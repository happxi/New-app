<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìíœ´ë ˆí„° - Letter from JAHU</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #6b46c1; /* ë³´ë¼ìƒ‰ ê³„ì—´ */
            --primary-soft: #ede9fe;
            --accent: #4ecdc4; /* ë¯¼íŠ¸ìƒ‰ ê³„ì—´ */
            --accent-soft: #d4f7f6;
            --secondary: #4edcc4;
            --bg: #f7f9fc;
            --text-main: #333;
            --text-sub: #777;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-card: 0 8px 30px rgba(0, 0, 0, 0.05);
            --border-radius: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 70px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ê³µê°„ */
        }
        
        /* ğŸ¨ ê¸°ì¡´ ë””ìì¸ ìœ ì§€: Header Section (Simplified) */
        .header-section {
            background-color: var(--bg); /* ë°°ê²½ìƒ‰ì„ ë³¸ë¬¸ê³¼ ìœ ì‚¬í•˜ê²Œ ìœ ì§€ */
            color: var(--text-main);
            padding: 20px 20px 10px;
            margin-bottom: 10px;
        }

        .header-title {
            font-size: 26px;
            font-weight: 800;
            color: var(--primary);
        }
        
        .header-subtitle {
            font-size: 14px;
            color: var(--text-sub);
            margin-top: 5px;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* Nav Bar */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--glass-bg);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--text-sub);
            font-size: 10px;
            cursor: pointer;
            transition: color 0.3s;
            height: 100%;
        }

        .nav-item i {
            font-size: 18px;
            margin-bottom: 3px;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Floating Write Icon */
        #writeIcon {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.5);
            z-index: 999;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        #writeIcon:hover {
            transform: scale(1.05);
        }

        /* Common Elements */
        .content-card {
            background-color: var(--glass-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 0 20px 20px 20px;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            background: var(--primary);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 15px rgba(107, 70, 193, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--primary-soft);
            border-radius: 10px;
            background-color: white;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--glass-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            margin-bottom: 25px;
            font-size: 22px;
            color: var(--primary);
            text-align: center;
            font-weight: 800;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: var(--text-sub);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        /* Letter/EditorTalk Card Styles */
        .post-card {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .post-card:hover {
            transform: translateY(-3px);
        }

        .post-meta {
            font-size: 12px;
            color: var(--text-sub);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-card h4 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-main);
        }
        
        .post-card p {
            font-size: 14px;
            color: var(--text-sub);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 10px;
        }
        
        .category-tag {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .tag-letter { background-color: var(--primary-soft); color: var(--primary); }
        .tag-lab { background-color: var(--accent-soft); color: var(--accent); }
        .tag-editor { background-color: #ffe0b2; color: #ff9800; } /* ì£¼í™©ìƒ‰ ê³„ì—´ */
        .tag-mood { background-color: #e3f2fd; color: #2196f3; } /* íŒŒë€ìƒ‰ ê³„ì—´ */
        
        /* Mood Specific */
        .mood-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .emoji-option {
            font-size: 30px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .emoji-option.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px var(--accent);
        }
        
        .mood-instruction {
            font-size: 12px;
            color: var(--text-sub);
            text-align: center;
            margin-bottom: 15px;
        }

        .mood-record {
            text-align: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 15px;
            background: var(--glass-bg);
            box-shadow: var(--shadow-card);
        }
        
        .mood-record .emoji {
            font-size: 40px;
            display: block;
            margin-bottom: 5px;
        }

        .mood-record .date {
            font-size: 10px;
            color: var(--text-sub);
            margin-bottom: 5px;
        }
        
        .mood-record .title {
            font-size: 14px;
            font-weight: 600;
        }
        
        /* MyPage Stamp */
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }

        .stamp-circle {
            width: 100%;
            padding-top: 100%; /* 1:1 ë¹„ìœ¨ */
            position: relative;
            border-radius: 50%;
            background-color: var(--primary-soft);
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            transition: background 0.3s;
        }
        
        .stamp-circle span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .stamp-circle.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(107, 70, 193, 0.3);
        }

        /* Toast Message */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 10px;
            padding: 16px;
            position: fixed;
            z-index: 2001;
            left: 50%;
            bottom: 70px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 70px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 70px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        
        /* New Post Modal Styles */
        .file-upload-area {
            display: flex;
            align-items: center;
            border: 2px dashed var(--primary-soft);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            background-color: white;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-upload-area i {
            color: var(--primary);
            margin-right: 10px;
            font-size: 20px;
        }

        #imagePreview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }

        /* Filter Dropdown */
        .filter-section {
            padding: 0 20px 15px;
        }
        
        .filter-section select {
            width: 100%;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--primary-soft);
            background-color: white;
            font-size: 14px;
            color: var(--text-main);
            appearance: none; /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%236b46c1" d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            box-shadow: var(--shadow-light);
        }
        
        /* Post View Modal */
        #postViewModal .post-content {
            white-space: pre-wrap;
            margin-top: 15px;
            padding: 15px;
            background: var(--primary-soft);
            border-radius: 10px;
            font-size: 15px;
        }

        #postViewModal .post-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--primary-soft);
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 14px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .action-btn.liked i, .action-btn.bookmarked i {
            color: var(--primary);
        }
        
        #commentsSection {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--primary-soft);
        }
        
        .comment-item {
            padding: 10px 0;
            border-bottom: 1px dashed var(--accent-soft);
        }
        
        .comment-meta {
            font-size: 12px;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
        }
        
        .comment-text {
            font-size: 14px;
        }

        /* Admin Dashboard */
        .admin-stat {
            background-color: var(--primary-soft);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .admin-stat h4 {
            font-size: 14px;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .admin-stat p {
            font-size: 24px;
            font-weight: 700;
        }
        
        /* í™ˆ íƒ­ ì•„ì¹´ì´ë¸Œ ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³µêµ¬ */
        .archive-card {
            background-color: var(--glass-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .archive-card:hover {
            transform: translateY(-2px);
        }

    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="app-container">
        <div id="appContainer">
            </div>

        <div id="writeIcon" style="display: none;">
            <i class="fas fa-plus"></i>
        </div>

        <div class="nav-bar">
            <div class="nav-item" id="nav-home" onclick="renderTab('home')">
                <i class="fas fa-home"></i>
                <span>í™ˆ</span>
            </div>
            <div class="nav-item" id="nav-letter" onclick="renderTab('letter')">
                <i class="fas fa-archive"></i>
                <span>ë ˆí„° ì•„ì¹´ì´ë¸Œ</span>
            </div>
            <div class="nav-item" id="nav-mood" onclick="renderTab('mood')">
                <i class="fas fa-sun"></i>
                <span>ë¬´ë“œ</span>
            </div>
            <div class="nav-item" id="nav-editorTalk" onclick="renderTab('editorTalk')">
                <i class="fas fa-comment"></i>
                <span>ì—ë””í„°í†¡</span>
            </div>
            <div class="nav-item" id="nav-mypage" onclick="renderTab('mypage')">
                <i class="fas fa-user"></i>
                <span>MY</span>
            </div>
        </div>
    </div>
    
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('loginModal')">&times;</span>
            <h2 id="loginTitle">ë¡œê·¸ì¸</h2>
            <input type="text" id="loginId" placeholder="ì•„ì´ë””">
            <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-primary" id="loginSubmitBtn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <button class="btn-primary" style="background: var(--accent); margin-top: 10px;" onclick="showSignup()">íšŒì›ê°€ì…</button>
        </div>
    </div>
    
    <div id="writeModal" class="modal" onclick="if(event.target.id === 'writeModal') closeModal('writeModal')">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('writeModal')">&times;</span>
            <h2 id="writeTitle">ê¸€ ì‘ì„±</h2>
            
            <select id="postCategory" style="display:none; margin-bottom:15px;">
                <option value="ìíœ´ë ˆí„°">ìíœ´ë ˆí„°</option>
                <option value="ìíœ´ë©">ìíœ´ë©</option>
            </select>
            
            <p id="moodInstruction" class="mood-instruction" style="display:none;">ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì„ ì„ íƒí•˜ê³  í•œ ì¤„ ì¼ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
            <div id="moodSelector" class="mood-grid" style="display:none;">
                </div>
            
            <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <textarea id="postContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="6"></textarea>
            
            <div id="fileUploadArea" class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-paperclip"></i>
                <span id="fileNameDisplay">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</span>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
            <img id="imagePreview" src="" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="display:none;">
            
            <button class="btn-primary" onclick="submitPost()">ë“±ë¡</button>
        </div>
    </div>
    
    <div id="postViewModal" class="modal" onclick="if(event.target.id === 'postViewModal') closeModal('postViewModal')">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('postViewModal')">&times;</span>
            <h2 id="viewTitle"></h2>
            <div class="post-meta">
                <span id="viewCategory" class="category-tag"></span>
                <span id="viewAuthor"></span>
                <span id="viewDate"></span>
            </div>
            
            <img id="viewImage" src="" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="width:100%; height:auto; border-radius:10px; margin-top:15px; display:none;">
            
            <div id="viewContent" class="post-content"></div>
            
            <div class="post-actions">
                <button id="likeBtn" class="action-btn" onclick="toggleLike(currentViewPostId)">
                    <i class="far fa-heart"></i> <span id="likeCount">0</span>
                </button>
                <button id="bookmarkBtn" class="action-btn" onclick="toggleBookmark(currentViewPostId)">
                    <i class="far fa-bookmark"></i> ë¶ë§ˆí¬
                </button>
                <button class="action-btn">
                    <i class="far fa-comment-dots"></i> <span id="commentCount">0</span>
                </button>
            </div>
            
            <div id="commentsSection">
                <h4>ëŒ“ê¸€</h4>
                <div id="commentsList">
                    </div>
                <input type="text" id="newCommentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-top: 15px;">
                <button class="btn-primary" style="margin-top:-5px; padding:10px; font-size:14px;" onclick="submitComment(currentViewPostId)">ëŒ“ê¸€ ë“±ë¡</button>
            </div>
        </div>
    </div>
    
    <div id="adminDashboardModal" class="modal" onclick="if(event.target.id === 'adminDashboardModal') closeModal('adminDashboardModal')">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('adminDashboardModal')">&times;</span>
            <h2>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
            <p style="text-align:center; color:var(--text-sub); margin-bottom:20px;">ìíœ´ë ˆí„° ê´€ë¦¬ í˜„í™©</p>

            <div class="admin-stat-grid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px;">
                <div class="admin-stat">
                    <h4>ì „ì²´ íšŒì›</h4>
                    <p id="statUsers">0</p>
                </div>
                <div class="admin-stat" style="background-color: var(--accent-soft);">
                    <h4>ì „ì²´ ê¸€</h4>
                    <p id="statPosts">0</p>
                </div>
                <div class="admin-stat">
                    <h4>ë¬´ë“œ ê¸°ë¡</h4>
                    <p id="statMoods">0</p>
                </div>
                <div class="admin-stat" style="background-color: var(--accent-soft);">
                    <h4>í™œë™ ë¡œê·¸</h4>
                    <p id="statLogs">0</p>
                </div>
            </div>

            <h4 style="margin-top:25px; margin-bottom:15px; color:var(--primary);">ìµœê·¼ í™œë™ ë¡œê·¸</h4>
            <div id="activityLogList" style="max-height: 200px; overflow-y: scroll; padding: 0 10px;">
                </div>
        </div>
    </div>
    
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('changePasswordModal')">&times;</span>
            <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
            <input type="password" id="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
            <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
            <input type="password" id="confirmNewPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
            <button class="btn-primary" onclick="handleChangePassword()">ë³€ê²½ ì™„ë£Œ</button>
        </div>
    </div>


    <script>
        // --- ì´ˆê¸° ë°ì´í„° ì„¤ì • ---
        let users = [
            { id: 'admin', pw: '1234', name: 'í–…ì”¨', isAdmin: true, isSuperAdmin: true },
            { id: 'user1', pw: '1234', name: 'í˜œë€', isAdmin: false, isSuperAdmin: false },
        ];

        let currentUser = null;
        let currentTab = 'home';
        let attachedFile = null; 
        let currentViewPostId = null;
        let selectedMoodEmoji = null;
        let userStamps = 0; 
        
        let posts = [ // ë ˆí„° íƒ­ì— ë…¸ì¶œë  ê¸€ (ìíœ´ë ˆí„°, ìíœ´ë©)
            { id: 10, title: 'ë””ì§€í„¸ ë…¸ë§ˆë“œì˜ ì˜¤í•´ì™€ ì§„ì‹¤', category: 'ìíœ´ë ˆí„°', content: 'ë””ì§€í„¸ ë…¸ë§ˆë“œì— ëŒ€í•œ í™˜ìƒì„ ê¹¨ê³  í˜„ì‹¤ì ì¸ ì ‘ê·¼ ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤.', author: 'í–…ì”¨', authorId: 1, date: new Date(2025, 11, 10).toISOString(), likes: 25, comments: 5, image: null },
            { id: 11, title: 'AI ê¸€ì“°ê¸° íˆ´ 5ê°€ì§€ ë¹„êµ ë¶„ì„', category: 'ìíœ´ë©', content: 'ì½˜í…ì¸  ì œì‘ì— ë„ì›€ì´ ë˜ëŠ” AI íˆ´ 5ê°€ì§€ë¥¼ ì‹¬ì¸µì ìœ¼ë¡œ ë¹„êµ ë¶„ì„í•©ë‹ˆë‹¤.', author: 'í–…ì”¨', authorId: 1, date: new Date(2025, 11, 8).toISOString(), likes: 18, comments: 3, image: null },
            { id: 12, title: 'í‡´ì‚¬ í›„ í•œ ë‹¬, ì†”ì§ í›„ê¸°', category: 'ìíœ´ë ˆí„°', content: 'í‡´ì‚¬ í›„ì˜ ê°ì •ê³¼ ì¼ìƒì„ ì†”ì§í•˜ê²Œ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.', author: 'í–…ì”¨', authorId: 1, date: new Date(2025, 11, 5).toISOString(), likes: 30, comments: 8, image: null }
        ];
        
        let editorTalks = [ // ì—ë””í„°í†¡ íƒ­ì— ë…¸ì¶œë  ê¸€ (ì—ë””í„°í†¡)
            { id: 20, title: 'ìš”ì¦˜ í–…ì”¨ì˜ ê³ ë¯¼', category: 'ì—ë””í„°í†¡', content: 'ìµœê·¼ êµ¬ë…ìë¶„ë“¤ì˜ ë°˜ì‘ì„ ë³´ë©° ë‹¤ìŒ ì½˜í…ì¸  ë°©í–¥ì— ëŒ€í•œ ê³ ë¯¼ì„ ë‚˜ëˆ„ê³  ì‹¶ì–´ìš”. ëŒ“ê¸€ë¡œ ì˜ê²¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.', author: 'í–…ì”¨', authorId: 1, date: new Date(2025, 11, 11).toISOString(), likes: 10, comments: 2, image: null },
            { id: 21, title: 'ê¸ˆì£¼ì˜ ìµœì•  BGM', category: 'ì—ë””í„°í†¡', content: 'ì”ì”í•˜ê²Œ ë“£ê¸° ì¢‹ì€ ì¸ë”” ìŒì•…ì„ ê³µìœ í•©ë‹ˆë‹¤.', author: 'í–…ì”¨', authorId: 1, date: new Date(2025, 11, 9).toISOString(), likes: 15, comments: 4, image: null }
        ];

        let myMoodRecords = [ // ë¬´ë“œ ê¸°ë¡
            { id: 30, emoji: 'ğŸ˜', title: 'ì™„ë²½í•œ í•˜ë£¨ì˜ ë§ˆë¬´ë¦¬', content: 'ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ëë‚´ê³  í™€ê°€ë¶„í•œ ê¸°ë¶„! ì—­ì‹œ ë³´ëŒì°¹ë‹ˆë‹¤.', date: new Date(2025, 11, 9).toISOString(), authorId: 1 },
            { id: 31, emoji: 'ğŸ’»', title: 'ì½”ë“œ ë²„ê·¸ì™€ì˜ ì‹¸ì›€ì—ì„œ ì´ê¹€', content: 'ë°¤ìƒˆë„ë¡ ê´´ë¡­íˆë˜ ë²„ê·¸ë¥¼ ë“œë””ì–´ ì¡ì•˜ë‹¤. ì»¤í”¼ 3ì”ì˜ ìŠ¹ë¦¬!', date: new Date(2025, 11, 7).toISOString(), authorId: 2 },
        ];
        
        let allPosts = [...posts, ...editorTalks];
        
        let comments = [
            { postId: 10, author: 'í˜œë€', content: 'ì™€ ì •ë§ ìœ ìµí•´ìš”! ì €ë„ ë…¸ë§ˆë“œ ê¿ˆê¾¸ëŠ”ë° í˜„ì‹¤ì ì¸ ì¡°ì–¸ ê°ì‚¬í•©ë‹ˆë‹¤.', date: new Date(2025, 11, 10).toISOString() },
            { postId: 20, author: 'í˜œë€', content: 'ì €ëŠ” ì»¤ë¦¬ì–´ ê´€ë ¨ ë ˆí„°ê°€ ê°€ì¥ í¥ë¯¸ë¡­ìŠµë‹ˆë‹¤!', date: new Date(2025, 11, 11).toISOString() }
        ];

        let likes = []; 
        let bookmarks = []; 
        
        let activityLogs = [
            { type: 'login', user: 'í˜œë€', date: new Date(2025, 11, 11, 10, 0, 0).toISOString(), userId: 2 },
            { type: 'post', user: 'í–…ì”¨', date: new Date(2025, 11, 11, 14, 0, 0).toISOString(), targetId: 20, userId: 1 },
        ];

        const moodEmojis = [
            { emoji: 'âœ¨', name: 'ì„¤ë ˜' }, { emoji: 'ğŸ˜Š', name: 'í–‰ë³µ' }, { emoji: 'ğŸ’»', name: 'ì§‘ì¤‘' }, 
            { emoji: 'ğŸ”¥', name: 'ì—´ì •' }, { emoji: 'â˜•', name: 'ì—¬ìœ ' }, { emoji: 'ğŸ¤”', name: 'ê³ ë¯¼' }, 
            { emoji: 'ğŸ˜¢', name: 'ìŠ¬í””' }, { emoji: 'ğŸ˜¡', name: 'ë¶„ë…¸' }, { emoji: 'ğŸ˜´', name: 'í”¼ê³¤' }, 
            { emoji: 'ğŸ˜', name: 'ë§Œì¡±' }
        ];
        
        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function formatDate(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays <= 1) {
                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('ko-KR');
        }

        function checkAutoLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userStamps = Math.min(30, myMoodRecords.filter(r => r.authorId === currentUser.id).length);
                renderTab('home');
            } else {
                renderTab('home'); // ë¡œê·¸ì¸ì´ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ í™ˆ íƒ­ë§Œ ë³´ì—¬ì¤Œ
            }
        }
        
        function getPostById(id) {
            return allPosts.find(p => p.id === id);
        }

        // --- ì¸ì¦ ë° ê³„ì • ê´€ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        function handleLogin() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;
            const user = users.find(u => u.id === id && u.pw === pw);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                userStamps = Math.min(30, myMoodRecords.filter(r => r.authorId === currentUser.id).length);
                closeModal('loginModal');
                renderTab('home');
                showToast(`${currentUser.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
                activityLogs.push({ type: 'login', user: currentUser.name, date: new Date().toISOString(), userId: currentUser.id });
            } else {
                showToast('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        function showSignup() {
            document.getElementById('loginTitle').textContent = 'íšŒì›ê°€ì…';
            document.getElementById('loginSubmitBtn').textContent = 'ê°€ì… ì™„ë£Œ';
            document.getElementById('loginSubmitBtn').setAttribute('onclick', 'handleSignup()');
            document.querySelector('#loginModal .btn-primary:last-child').style.display = 'none'; // íšŒì›ê°€ì… ë²„íŠ¼ ìˆ¨ê¹€
        }
        
        function handleSignup() {
            const id = document.getElementById('loginId').value;
            const pw = document.getElementById('loginPw').value;
            const name = prompt("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");

            if (!id || !pw || !name) {
                return showToast('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            }
            if (users.some(u => u.id === id)) {
                return showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.');
            }

            const newUser = { id, pw, name, isAdmin: false, isSuperAdmin: false };
            users.push(newUser);
            showToast('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');

            // ëª¨ë‹¬ ì´ˆê¸° ìƒíƒœë¡œ ë³µì›
            document.getElementById('loginTitle').textContent = 'ë¡œê·¸ì¸';
            document.getElementById('loginSubmitBtn').textContent = 'ë¡œê·¸ì¸';
            document.getElementById('loginSubmitBtn').setAttribute('onclick', 'handleLogin()');
            document.querySelector('#loginModal .btn-primary:last-child').style.display = 'block';
            document.getElementById('loginId').value = '';
            document.getElementById('loginPw').value = '';
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
            renderTab('home');
        }
        
        function showChangePassword() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        }
        
        function handleChangePassword() {
            const currentPw = document.getElementById('currentPassword').value;
            const newPw = document.getElementById('newPassword').value;
            const confirmNewPw = document.getElementById('confirmNewPassword').value;

            if (currentUser.pw !== currentPw) {
                return showToast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            if (newPw !== confirmNewPw) {
                return showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            if (newPw.length < 4) {
                 return showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }

            currentUser.pw = newPw;
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].pw = newPw;
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); // ë¡œì»¬ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
                showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal('changePasswordModal');
            }
        }

        // --- ëª¨ë‹¬ ì œì–´ ---
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- ê¸€ ì‘ì„± ëª¨ë‹¬ (ê¸°ëŠ¥ ë¡œì§ ìœ ì§€) ---
        function openModal(type) {
            if (!currentUser) {
                document.getElementById('loginModal').style.display = 'flex';
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            const modal = document.getElementById('writeModal');
            const title = document.getElementById('writeTitle');
            const moodSec = document.getElementById('moodSelector');
            const moodInst = document.getElementById('moodInstruction');
            const postCategory = document.getElementById('postCategory');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const currentPostTitle = document.getElementById('postTitle');

            // ì´ˆê¸°í™”
            modal.style.display = 'flex';
            moodSec.style.display = 'none';
            moodInst.style.display = 'none';
            postCategory.style.display = 'none';
            currentPostTitle.placeholder = 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
            currentPostTitle.value = '';
            document.getElementById('postContent').value = '';
            
            // íŒŒì¼ ì²¨ë¶€ ì´ˆê¸°í™”
            attachedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileNameDisplay').textContent = 'ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
            fileUploadArea.style.display = 'flex'; 

            moodSec.querySelectorAll('.emoji-option').forEach(opt => opt.classList.remove('selected'));
            selectedMoodEmoji = null;

            if (type === 'mood') {
                // ë¬´ë“œ ê¸°ë¡ ê´€ë ¨ ì„¤ì •
                title.innerText = 'ì˜¤ëŠ˜ì˜ ë¬´ë“œ ê¸°ë¡';
                moodSec.style.display = 'grid';
                moodInst.style.display = 'block';
                currentPostTitle.placeholder = 'ì˜¤ëŠ˜ì˜ ê°ì •ì— ëŒ€í•œ í•œ ì¤„ ìš”ì•½';
                fileUploadArea.style.display = 'none'; 
                
                const today = new Date().toDateString();
                if (myMoodRecords.some(record => new Date(record.date).toDateString() === today && record.authorId === currentUser.id)) {
                    showToast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ë¬´ë“œë¥¼ ê¸°ë¡í•˜ì…¨ì–´ìš”!');
                    modal.style.display = 'none';
                    return;
                }
                
                // ì´ëª¨ì§€ ë Œë”ë§
                moodSec.innerHTML = moodEmojis.map((m, index) => `
                    <div class="emoji-option" data-emoji="${m.emoji}" data-name="${m.name}" onclick="selectMoodEmoji('${m.emoji}', this)">
                        ${m.emoji}
                        <div style="font-size:10px; margin-top:3px; color:var(--text-sub);">${m.name}</div>
                    </div>
                `).join('');

            } else if (type === 'adminWrite') {
                if (!currentUser.isAdmin) {
                    showToast('ì—ë””í„°í†¡ ë° ë ˆí„° ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    modal.style.display = 'none';
                    return;
                }
                
                if (currentTab === 'letter') {
                    // **[ìœ ì§€] ë ˆí„° íƒ­: ìíœ´ë ˆí„°/ìíœ´ë© ì¹´í…Œê³ ë¦¬ ì„ íƒ í™œì„±í™”**
                    title.innerText = 'ë ˆí„°/ë© ì‘ì„±';
                    postCategory.style.display = 'block';
                    currentPostTitle.placeholder = 'ë ˆí„° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (í•„ìˆ˜)';
                } else if (currentTab === 'editorTalk') {
                    // **[ìœ ì§€] ì—ë””í„°í†¡ íƒ­: ì¹´í…Œê³ ë¦¬ ì„ íƒ ì—†ì´ ì—ë””í„°í†¡ìœ¼ë¡œ ê³ ì •**
                    title.innerText = 'ì—ë””í„°í†¡ ì‘ì„±';
                    postCategory.style.display = 'none';
                    currentPostTitle.placeholder = 'í†¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)';
                }
            }
        }
        
        function selectMoodEmoji(emoji, element) {
            selectedMoodEmoji = emoji;
            document.querySelectorAll('#moodSelector .emoji-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                attachedFile = file;
                document.getElementById('fileNameDisplay').textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // --- ê¸€ ë“±ë¡ (ê¸°ëŠ¥ ë¡œì§ ìœ ì§€) ---
        function submitPost() {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const postCategoryElement = document.getElementById('postCategory');
            const isMoodRecord = selectedMoodEmoji !== null;

            if (!content) return showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            
            if (isMoodRecord) {
                if (!selectedMoodEmoji) return showToast('ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

                const newRecord = {
                    id: Math.max(...myMoodRecords.map(r => r.id), 0) + 1,
                    emoji: selectedMoodEmoji,
                    title: title || 'ì œëª© ì—†ìŒ',
                    content: content,
                    date: new Date().toISOString(),
                    authorId: currentUser.id
                };
                myMoodRecords.unshift(newRecord);
                userStamps = Math.min(30, myMoodRecords.filter(r => r.authorId === currentUser.id).length);
                showToast('ì˜¤ëŠ˜ì˜ ë¬´ë“œê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                renderTab('mood');
                
                activityLogs.push({ 
                    type: 'mood', 
                    user: currentUser.name, 
                    date: new Date().toISOString(), 
                    targetId: newRecord.id, 
                    userId: currentUser.id 
                });

            } else if (currentUser.isAdmin) {
                if (!title && currentTab !== 'editorTalk') return showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                if (!title && currentTab === 'editorTalk' && content.length < 5) return showToast('ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                let selectedCategory;
                if (currentTab === 'letter') {
                    selectedCategory = postCategoryElement.value; 
                } else if (currentTab === 'editorTalk') {
                    selectedCategory = 'ì—ë””í„°í†¡';
                }
                
                const isLetter = selectedCategory === 'ìíœ´ë ˆí„°' || selectedCategory === 'ìíœ´ë©';
                
                const newId = Math.max(...allPosts.map(p => p.id), 0) + 1; 
                const imageUrl = attachedFile ? document.getElementById('imagePreview').src : null; 
                
                const newPost = {
                    id: newId,
                    title: title || content.substring(0, 30) + (content.length > 30 ? '...' : ''), // ì—ë””í„°í†¡ ì œëª© ì„ íƒì 
                    category: selectedCategory,
                    content: content,
                    author: currentUser.name,
                    authorId: currentUser.id,
                    date: new Date().toISOString(),
                    likes: 0,
                    comments: 0,
                    image: imageUrl 
                };

                allPosts.unshift(newPost); // ì „ì²´ ë°°ì—´ì— ì¶”ê°€
                
                if (isLetter) {
                    posts.unshift(newPost); // ë ˆí„° ë°°ì—´ì—ë„ ì¶”ê°€
                    showToast(`${selectedCategory}ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    renderTab('letter');
                } else { // ì—ë””í„°í†¡
                    editorTalks.unshift(newPost); // ì—ë””í„°í†¡ ë°°ì—´ì—ë„ ì¶”ê°€
                    showToast("ì—ë””í„°í†¡ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    renderTab('editorTalk');
                }

                activityLogs.push({ 
                    type: 'post', 
                    user: currentUser.name, 
                    date: new Date().toISOString(), 
                    targetId: newPost.id, 
                    userId: currentUser.id 
                });
            } else {
                showToast("ì¼ë°˜ ì‚¬ìš©ìëŠ” ë ˆí„°/ì—ë””í„°í†¡ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }

            closeModal('writeModal');
        }

        // --- í¬ìŠ¤íŠ¸ ë·° ë° ì•¡ì…˜ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        function viewPost(postId) {
            const post = getPostById(postId);
            if (!post) return showToast('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            
            currentViewPostId = postId;
            
            document.getElementById('viewTitle').textContent = post.title;
            document.getElementById('viewAuthor').textContent = `by ${post.author}`;
            document.getElementById('viewDate').textContent = formatDate(post.date);
            document.getElementById('viewContent').textContent = post.content;

            // ì¹´í…Œê³ ë¦¬ íƒœê·¸ ì„¤ì •
            const categoryEl = document.getElementById('viewCategory');
            categoryEl.textContent = post.category;
            categoryEl.className = 'category-tag';
            if (post.category === 'ìíœ´ë ˆí„°') categoryEl.classList.add('tag-letter');
            else if (post.category === 'ìíœ´ë©') categoryEl.classList.add('tag-lab');
            else if (post.category === 'ì—ë””í„°í†¡') categoryEl.classList.add('tag-editor');

            // ì´ë¯¸ì§€ ì„¤ì •
            const viewImage = document.getElementById('viewImage');
            if (post.image) {
                viewImage.src = post.image;
                viewImage.style.display = 'block';
            } else {
                viewImage.style.display = 'none';
            }

            // ì¢‹ì•„ìš”/ë¶ë§ˆí¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            const isLiked = likes.some(l => l.postId === postId && l.userId === currentUser.id);
            const isBookmarked = bookmarks.some(b => b.postId === postId && b.userId === currentUser.id);

            document.getElementById('likeBtn').classList.toggle('liked', isLiked);
            document.querySelector('#likeBtn i').className = isLiked ? 'fas fa-heart' : 'far fa-heart';
            document.getElementById('likeCount').textContent = likes.filter(l => l.postId === postId).length;

            document.getElementById('bookmarkBtn').classList.toggle('bookmarked', isBookmarked);
            document.querySelector('#bookmarkBtn i').className = isBookmarked ? 'fas fa-bookmark' : 'far fa-bookmark';

            // ëŒ“ê¸€ ë Œë”ë§
            renderComments(postId);
            
            document.getElementById('postViewModal').style.display = 'flex';
        }
        
        function renderComments(postId) {
            const postComments = comments.filter(c => c.postId === postId);
            const listEl = document.getElementById('commentsList');
            listEl.innerHTML = postComments.map(c => `
                <div class="comment-item">
                    <div class="comment-meta">
                        <span style="font-weight:600;">${c.author}</span>
                        <span>${formatDate(c.date)}</span>
                    </div>
                    <div class="comment-text">${c.content}</div>
                </div>
            `).join('');
            
            document.getElementById('commentCount').textContent = postComments.length;
        }

        function submitComment(postId) {
            if (!currentUser) return showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
            
            const input = document.getElementById('newCommentInput');
            const content = input.value.trim();
            if (!content) return showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            const post = getPostById(postId);
            if (!post) return showToast('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const newComment = {
                postId: postId,
                author: currentUser.name,
                content: content,
                date: new Date().toISOString()
            };
            comments.push(newComment);
            input.value = '';
            
            post.comments += 1; // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸ (UI ë°˜ì˜ìš©)
            
            showToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            renderComments(postId); // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        }
        
        function toggleLike(postId) {
            if (!currentUser) return showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
            
            const index = likes.findIndex(l => l.postId === postId && l.userId === currentUser.id);
            const post = getPostById(postId);

            if (index === -1) {
                // ì¢‹ì•„ìš” ì¶”ê°€
                likes.push({ postId: postId, userId: currentUser.id });
                post.likes += 1;
                showToast('ì¢‹ì•„ìš”!');
            } else {
                // ì¢‹ì•„ìš” ì œê±°
                likes.splice(index, 1);
                post.likes -= 1;
                showToast('ì¢‹ì•„ìš” ì·¨ì†Œ');
            }
            
            // UI ì—…ë°ì´íŠ¸
            const isLiked = index === -1;
            document.getElementById('likeBtn').classList.toggle('liked', isLiked);
            document.querySelector('#likeBtn i').className = isLiked ? 'fas fa-heart' : 'far fa-heart';
            document.getElementById('likeCount').textContent = likes.filter(l => l.postId === postId).length;
        }

        function toggleBookmark(postId) {
            if (!currentUser) return showToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
            
            const index = bookmarks.findIndex(b => b.postId === postId && b.userId === currentUser.id);

            if (index === -1) {
                // ë¶ë§ˆí¬ ì¶”ê°€
                bookmarks.push({ postId: postId, userId: currentUser.id });
                showToast('ë¶ë§ˆí¬ ì €ì¥!');
            } else {
                // ë¶ë§ˆí¬ ì œê±°
                bookmarks.splice(index, 1);
                showToast('ë¶ë§ˆí¬ í•´ì œ');
            }
            
            // UI ì—…ë°ì´íŠ¸
            const isBookmarked = index === -1;
            document.getElementById('bookmarkBtn').classList.toggle('bookmarked', isBookmarked);
            document.querySelector('#bookmarkBtn i').className = isBookmarked ? 'fas fa-bookmark' : 'far fa-bookmark';
        }
        
        // --- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (ê¸°ëŠ¥ ë¡œì§ ìœ ì§€) ---
        function showAdminDashboardModal() {
            if (!currentUser || !currentUser.isSuperAdmin) {
                return showToast('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('statUsers').textContent = users.length;
            document.getElementById('statPosts').textContent = allPosts.length;
            document.getElementById('statMoods').textContent = myMoodRecords.length;
            document.getElementById('statLogs').textContent = activityLogs.length;

            // ë¡œê·¸ ë Œë”ë§
            const logListEl = document.getElementById('activityLogList');
            logListEl.innerHTML = activityLogs.slice().reverse().map(log => { // ìµœì‹ ìˆœ ì •ë ¬
                let logText = '';
                let icon = '';
                if (log.type === 'login') {
                    logText = `${log.user}ë‹˜ ë¡œê·¸ì¸`;
                    icon = `<i class="fas fa-sign-in-alt" style="color:#2196f3;"></i>`;
                } else if (log.type === 'post') {
                    const post = getPostById(log.targetId);
                    logText = `${log.user}ë‹˜ì´ ê¸€ ì‘ì„±: ${post ? post.title.substring(0, 15) + '...' : 'ì•Œ ìˆ˜ ì—†ëŠ” ê¸€'}`;
                    icon = `<i class="fas fa-file-alt" style="color:var(--accent);"></i>`;
                } else if (log.type === 'mood') {
                     logText = `${log.user}ë‹˜ì´ ë¬´ë“œ ê¸°ë¡`;
                    icon = `<i class="fas fa-sun" style="color:var(--primary);"></i>`;
                }

                return `
                    <div style="font-size:12px; padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <span style="display:flex; align-items:center; gap:8px;">${icon} ${logText}</span>
                        <span style="color:var(--text-sub);">${formatDate(log.date)}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('adminDashboardModal').style.display = 'flex';
        }

        // --- íƒ­ ë Œë”ë§ ì‹œìŠ¤í…œ ---
        function renderPostList(postArray, container) {
            container.innerHTML = postArray.map(post => {
                const categoryClass = post.category === 'ìíœ´ë ˆí„°' ? 'tag-letter' : 
                                      post.category === 'ìíœ´ë©' ? 'tag-lab' : 'tag-editor';
                
                return `
                    <div class="post-card" onclick="viewPost(${post.id})">
                        <h4 style="display:flex; align-items:center; gap:10px;">
                            <span class="category-tag ${categoryClass}">${post.category}</span>
                            ${post.title}
                        </h4>
                        <p>${post.content}</p>
                        <div class="post-meta">
                            <span>${post.author}</span>
                            <span>
                                <i class="far fa-heart" style="margin-right:3px;"></i>${likes.filter(l => l.postId === post.id).length}
                                <i class="far fa-comment-dots" style="margin-left:10px; margin-right:3px;"></i>${comments.filter(c => c.postId === post.id).length}
                                <span style="margin-left:15px;">${formatDate(post.date)}</span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align:center; color:var(--text-sub); margin-top:30px;">ì•„ì§ ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }


        function renderTab(tabName, filterCategory = 'all') {
            if (!currentUser && tabName !== 'home') {
                document.getElementById('loginModal').style.display = 'flex';
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            currentTab = tabName;
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            window.scrollTo(0,0);

            // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${tabName}`);
            if (activeNav) activeNav.classList.add('active');

            // ê´€ë¦¬ì ê¸€ì“°ê¸° ì•„ì´ì½˜ ì œì–´ (ë ˆí„° ì•„ì¹´ì´ë¸Œ / ì—ë””í„°í†¡ / ë¬´ë“œ íƒ­ì—ì„œ í™œì„±í™”)
            const writeIcon = document.getElementById('writeIcon');
            if (currentUser && currentUser.isAdmin && (tabName === 'editorTalk' || tabName === 'letter')) {
                writeIcon.style.display = 'flex';
                writeIcon.setAttribute('onclick', `openModal('adminWrite')`);
            } else if (tabName === 'mood') {
                writeIcon.style.display = 'flex';
                writeIcon.setAttribute('onclick', `openModal('mood')`);
            } else {
                writeIcon.style.display = 'none';
            }

            if (tabName === 'home') {
                container.innerHTML = `
                    <div class="header-section">
                        <h1 class="header-title">ìíœ´ë ˆí„°</h1>
                        <p class="header-subtitle">${currentUser ? `${currentUser.name}ë‹˜, ì˜¤ëŠ˜ í•˜ë£¨ë„ í¸ì•ˆí•˜ê²Œ ì‹œì‘í•˜ì„¸ìš”.` : 'ììœ ë¡­ê³  íœ´ì‹í•˜ëŠ” ì‚¶ì„ ìœ„í•œ ì˜ê°ì˜ ë ˆí„°'}</p>
                    </div>
                    
                    <div style="padding: 0 20px;">
                        <div class="content-card" style="margin: 0 0 20px 0; background:linear-gradient(135deg, var(--primary-soft) 0%, #fff 100%);">
                            <h3 style="font-weight: 700; color: var(--primary); margin-bottom: 15px;">Today's Letter</h3>
                            ${posts.slice(0, 1).map(post => `
                                <div class="archive-card" onclick="viewPost(${post.id})">
                                    <h4 style="font-size:18px; color: var(--text-main);">${post.title}</h4>
                                    <p style="font-size:14px; color:var(--text-sub); margin-top:5px;">${post.content.substring(0, 50)}...</p>
                                    <div class="post-meta" style="margin-top:10px;">
                                        <span class="category-tag tag-letter">${post.category}</span>
                                        <span>${formatDate(post.date)}</span>
                                    </div>
                                </div>
                            `).join('') || '<p style="font-size:14px; color:var(--text-sub);">ìµœì‹  ë ˆí„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
                            
                            <h3 style="font-weight: 700; color: var(--accent); margin-top: 25px; margin-bottom: 15px;">Editor's Pick</h3>
                            ${editorTalks.slice(0, 1).map(post => `
                                <div class="archive-card" onclick="viewPost(${post.id})" style="border:1px solid var(--accent-soft);">
                                    <h4 style="font-size:18px; color: var(--text-main);">${post.title}</h4>
                                    <p style="font-size:14px; color:var(--text-sub); margin-top:5px;">${post.content.substring(0, 50)}...</p>
                                    <div class="post-meta" style="margin-top:10px;">
                                        <span class="category-tag tag-editor">${post.category}</span>
                                        <span>${formatDate(post.date)}</span>
                                    </div>
                                </div>
                            `).join('') || '<p style="font-size:14px; color:var(--text-sub);">ìµœì‹  ì—ë””í„°í†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        </div>
                        
                        ${currentUser ? `
                        <div class="content-card" onclick="renderTab('mypage')" style="text-align:center; background:var(--accent-soft); cursor:pointer;">
                            <h4 style="font-weight:700; color:var(--primary);"><i class="fas fa-award"></i> ë‚˜ì˜ ìíœ´ ìŠ¤íƒ¬í”„</h4>
                            <p style="font-size:24px; font-weight:800; color:var(--accent); margin-top:5px;">${userStamps} <span style="font-size:14px; color:var(--text-sub);">/ 30ê°œ</span></p>
                        </div>` : ''}
                    </div>
                `;

            } else if (tabName === 'letter') {
                container.innerHTML = `
                    <div class="header-section">
                        <h2 class="header-title">ë ˆí„° ì•„ì¹´ì´ë¸Œ</h2>
                        <p class="header-subtitle">ììœ ì™€ íœ´ì‹ì— ê´€í•œ ëª¨ë“  ë ˆí„°ë¥¼ ëª¨ì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                    
                    <div class="filter-section">
                        <select onchange="renderTab('letter', this.value)">
                            <option value="all" ${filterCategory === 'all' ? 'selected' : ''}>ì „ì²´ ë ˆí„°</option>
                            <option value="ìíœ´ë ˆí„°" ${filterCategory === 'ìíœ´ë ˆí„°' ? 'selected' : ''}>ìíœ´ë ˆí„°</option>
                            <option value="ìíœ´ë©" ${filterCategory === 'ìíœ´ë©' ? 'selected' : ''}>ìíœ´ë©</option>
                        </select>
                    </div>

                    <div id="postList" style="padding: 0 20px;">
                        </div>
                `;
                
                let filteredPosts = posts.slice().sort((a, b) => new Date(b.date) - new Date(a.date)); // ìµœì‹ ìˆœ ì •ë ¬
                if (filterCategory !== 'all') {
                    filteredPosts = filteredPosts.filter(p => p.category === filterCategory);
                }
                renderPostList(filteredPosts, document.getElementById('postList'));

            } else if (tabName === 'mood') {
                const myMoods = myMoodRecords.filter(r => r.authorId === currentUser.id).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = `
                    <div class="header-section">
                        <h2 class="header-title">ë‚˜ì˜ ë¬´ë“œ ê¸°ë¡</h2>
                        <p class="header-subtitle">ê°ì •ì„ ê¸°ë¡í•˜ê³  ë§ˆìŒì„ ëŒì•„ë³´ëŠ” ì‹œê°„</p>
                    </div>
                    <div style="padding: 0 20px;">
                        ${myMoods.map(mood => `
                            <div class="content-card mood-record">
                                <span class="emoji">${mood.emoji}</span>
                                <div class="date">${formatDate(mood.date)}</div>
                                <div class="title">${mood.title}</div>
                                <p style="font-size:12px; color:var(--text-sub); margin-top:5px;">${mood.content}</p>
                            </div>
                        `).join('') || '<p style="text-align:center; color:var(--text-sub); margin-top:30px;">ì•„ì§ ë¬´ë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ í•˜ë‹¨ â• ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>'}
                    </div>
                `;
            } else if (tabName === 'editorTalk') {
                container.innerHTML = `
                    <div class="header-section">
                        <h2 class="header-title">ì—ë””í„°í†¡</h2>
                        <p class="header-subtitle">ìíœ´ë ˆí„° ì—ë””í„°ì˜ ì†Œì†Œí•œ ì´ì•¼ê¸°</p>
                    </div>
                    <div id="postList" style="padding: 0 20px;">
                        </div>
                `;
                renderPostList(editorTalks.slice().sort((a, b) => new Date(b.date) - new Date(a.date)), document.getElementById('postList')); // ìµœì‹ ìˆœ ì •ë ¬

            } else if (tabName === 'mypage') {
                let stampHTML = '';
                for(let i=1; i<=30; i++) {
                    const active = i <= myMoodRecords.filter(r => r.authorId === currentUser.id).length ? 'active' : ''; 
                    stampHTML += `<div class="stamp-circle ${active}"><span>${i}</span></div>`;
                }

                container.innerHTML = `
                    <div class="header-section">
                        <h2 class="header-title">My Page</h2>
                        <div style="background:var(--glass-bg); padding:25px; border-radius:25px; display:flex; align-items:center; margin-top:20px; box-shadow:var(--shadow-card); backdrop-filter: blur(10px);">
                            <div style="width:60px; height:60px; background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border-radius:50%; margin-right:20px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:24px; box-shadow:0 4px 15px rgba(107, 70, 193, 0.3);">
                                ${currentUser.name.charAt(0)}
                            </div>
                            <div>
                                <h3 style="font-size:18px; font-weight:700;">${currentUser.name}ë‹˜</h3>
                                <p style="font-size:12px; color:var(--text-sub);">${currentUser.id}</p>
                                ${currentUser.isSuperAdmin ? '<span style="font-size:10px; background:var(--secondary); color:white; padding:2px 8px; border-radius:10px; margin-top:5px; display:inline-block;">Super Admin</span>' : 
                                  (currentUser.isAdmin ? '<span style="font-size:10px; background:var(--accent-soft); color:var(--accent); padding:2px 8px; border-radius:10px; margin-top:5px; display:inline-block;">ê´€ë¦¬ì</span>' : '')}
                            </div>
                        </div>
                    </div>

                    <div style="padding: 0 20px;">
                        ${currentUser.isSuperAdmin ? `
                            <button onclick="showAdminDashboardModal()" class="btn-primary" style="font-size:14px; margin-bottom:15px; background:var(--secondary); box-shadow:0 4px 15px rgba(78, 205, 196, 0.5);">
                                <i class="fas fa-chart-line"></i> ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                            </button>
                        ` : ''}
                        
                        <div class="content-card">
                            <h4 style="font-weight:700; color:var(--primary); margin-bottom:15px;">ìíœ´ìŠ¤íƒ¬í”„ í˜„í™© (${userStamps}ê°œ)</h4>
                            <div class="stamp-grid">
                                ${stampHTML}
                            </div>
                            <div style="background:linear-gradient(135deg, var(--primary-soft) 0%, var(--accent-soft) 100%); padding:20px; border-radius:20px; margin-top:25px; font-size:12px; color:var(--text-main); line-height:1.6; text-align:center;">
                                <strong>ğŸ ìíœ´ìŠ¤íƒ¬í”„ ì´ë²¤íŠ¸!</strong><br>
                                ìŠ¤íƒ¬í”„ 30ê°œë¥¼ ëª¨ë‘ ëª¨ì€ í™”ë©´ì„ ìº¡ì³í•´ì„œ<br>
                                ìíœ´ë ˆí„° ì¹´ì¹´ì˜¤í†¡ ì±„ë„ë¡œ ë³´ë‚´ì£¼ì„¸ìš”!<br>
                                (ì–´ëŠë‚  'ìŠ¤íì…œ ë ˆí„°'ê°€ ë„ì°©í• ì§€ë„ ëª°ë¼ìš”!)
                            </div>
                        </div>

                        <div class="content-card" style="padding:0;">
                            <div onclick="showToast('ê¸°ëŠ¥ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.')" style="padding:18px 20px; border-bottom:1px solid var(--primary-soft); display:flex; justify-content:space-between; align-items:center; cursor: pointer;">
                                <span><i class="fas fa-edit"></i> ë‚´ê°€ ì“´ ê¸€</span> 
                                <span style="color:var(--text-sub);">â€º</span>
                            </div>
                            <div onclick="showToast('ê¸°ëŠ¥ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.')" style="padding:18px 20px; border-bottom:1px solid var(--primary-soft); display:flex; justify-content:space-between; align-items:center; cursor: pointer;">
                                <span><i class="fas fa-comment-dots"></i> ë‚˜ì˜ ëŒ“ê¸€</span> 
                                <span style="color:var(--text-sub);">â€º</span>
                            </div>
                            <div onclick="showToast('ê¸°ëŠ¥ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.')" style="padding:18px 20px; border-bottom:1px solid var(--primary-soft); display:flex; justify-content:space-between; align-items:center; cursor: pointer;">
                                <span><i class="fas fa-heart"></i> ì¢‹ì•„ìš”í•œ ê¸€</span> 
                                <span style="color:var(--text-sub);">â€º</span>
                            </div>
                            <div onclick="showToast('ê¸°ëŠ¥ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.')" style="padding:18px 20px; display:flex; justify-content:space-between; align-items:center; cursor: pointer;">
                                <span><i class="fas fa-bookmark"></i> ë¶ë§ˆí¬í•œ ê¸€</span> 
                                <span style="color:var(--text-sub);">â€º</span>
                            </div>
                        </div>

                        <div class="content-card">
                            <h4 style="font-weight:700; margin-bottom:15px;">ê³„ì • ê´€ë¦¬</h4>
                            <button onclick="showChangePassword()" class="btn-primary" style="font-size:14px; margin-bottom:10px;">
                                <i class="fas fa-lock"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                            </button>
                        </div>
                        
                        <button onclick="handleLogout()" style="width:100%; padding:15px; color:var(--accent); background:none; border:2px solid var(--accent-soft); border-radius:15px; font-weight:700; margin-top:20px;">
                            <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                `;
            }
        }

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAutoLogin();
        });

    </script>
</body>
</html>
