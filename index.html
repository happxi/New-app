<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jahyu Letter</title>
    
    <!-- í°íŠ¸ & ì•„ì´ì½˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #9D76C1; 
            --primary-light: #F3E5F5;
            --bg-body: #FFFEF5;
            --white: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border: #EAEAEA; 
            --pink-popup: #FFF0F5;
            --pink-input: #FFEFF2;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--bg-body); padding-bottom: 100px; padding-top: 60px; position: relative; }
        .clickable { cursor: pointer; transition: transform 0.1s, opacity 0.1s; }
        .clickable:active { transform: scale(0.96); opacity: 0.8; }

        /* í—¤ë” */
        .header { position: fixed; top: 0; width: 100%; max-width: 480px; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 9000; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'Dancing Script', cursive; font-size: 28px; color: var(--primary); font-weight: 700; cursor: pointer; }
        .home-btn { position: absolute; right: 20px; font-size: 20px; color: #888; cursor: pointer; }

        /* ğŸ  í™ˆ (ì›ë˜ëŒ€ë¡œ ë³µêµ¬) */
        .home-greeting { text-align: center; margin: 20px 0; }
        .hero-card { margin: 0 20px 30px; padding: 30px; background: linear-gradient(135deg, #E0C3FC, #8EC5FC); border-radius: 20px; color: white; text-align: center; box-shadow: var(--shadow); cursor: pointer; }
        
        /* í€µë©”ë‰´ (ë™ê·¸ë¼ë¯¸ ë³µêµ¬ + URL ì—°ë™) */
        .quick-menu { display: flex; justify-content: space-between; padding: 0 25px; margin-bottom: 30px; }
        .quick-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; gap: 8px; width: 22%; }
        .quick-icon { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; box-shadow: var(--shadow); }
        .ic-1 { background: #FFB7B2; } /* ë ˆí„° */
        .ic-2 { background: #B5EAD7; } /* ë¬¸ì¥ */
        .ic-3 { background: #C7CEEA; } /* í…ŒìŠ¤íŠ¸ */
        .ic-4 { background: #FFDAC1; } /* ì±„íŒ… */
        .quick-text { font-size: 11px; font-weight: 700; color: var(--text-sub); }

        /* ì¹´ë“œ & ë¦¬ìŠ¤íŠ¸ */
        .card-list { padding: 0 20px; }
        .card { background: var(--white); border-radius: 18px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 15px; position: relative; }
        .card-badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; margin-bottom: 8px; background: #eee; color: #666; }
        .card-badge.notice { background: #FFD43B; color: #862E9C; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; color: #333; }
        .card-meta { font-size: 11px; color: #aaa; display: flex; justify-content: space-between; margin-top: 10px; }
        .delete-btn { position: absolute; top: 15px; right: 15px; color: #ff6b6b; font-size: 12px; cursor: pointer; }

        /* ì—ë””í„° í•„í„° (ë³µêµ¬ ë° ì•„ì´ì½˜í™”) */
        .editor-filter { display: flex; justify-content: space-between; padding: 0 20px; margin-bottom: 20px; }
        .editor-icon-box { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .editor-img { width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.2s; }
        .editor-img.active { border-color: var(--primary); background: var(--primary-light); transform: scale(1.1); }
        .editor-name { font-size: 11px; margin-top: 5px; color: #666; font-weight: 600; }

        /* íƒ­ ë²„íŠ¼ */
        .archive-tabs { display: flex; justify-content: center; gap: 8px; margin: 20px 0; padding: 0 20px; }
        .tab-btn { padding: 8px 16px; border-radius: 20px; background: white; border: 1px solid #eee; color: var(--text-sub); font-size: 13px; font-weight: 700; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* ìº˜ë¦°ë” */
        .cal-wrap { background: var(--primary-light); border-radius: 20px; padding: 20px; margin: 0 20px 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 10px; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; }
        .day-cell.today { border: 2px solid var(--primary); background: white; font-weight: 700; color: var(--primary); }
        .day-emoji { font-size: 20px; }

        /* ë§ˆì´í˜ì´ì§€ ë©”ë‰´ (ë³µêµ¬) */
        .mypage-header { text-align: center; padding: 30px 20px; }
        .menu-list { background: white; border-radius: 20px; margin: 0 20px 20px; padding: 10px; box-shadow: var(--shadow); }
        .menu-item { padding: 15px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #444; font-weight: 600; cursor: pointer; }
        .menu-item:last-child { border-bottom: none; }
        
        /* ìŠ¤íƒ¬í”„ */
        .stamp-board { background: white; padding: 20px; border-radius: 20px; margin: 0 20px 20px; box-shadow: var(--shadow); text-align: center; }
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }
        .stamp { aspect-ratio: 1/1; border-radius: 50%; background: #F3F0FF; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #C4B5FD; font-weight: 700; border: 1px solid #E9D5FF; }
        .stamp.active { background: var(--primary); color: white; border: none; }

        /* í•˜ë‹¨ë°” (ì•„ì´ì½˜ ìˆ˜ì •) */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 80px; background: rgba(255,255,255,0.98); border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 9000; padding-bottom: 10px; }
        .nav-item { color: #bbb; text-align: center; font-size: 10px; font-weight: 500; width: 20%; cursor: pointer; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; display: block; }
        .nav-item.active { color: var(--primary); font-weight: 700; }

        /* ê¸€ì“°ê¸° ë²„íŠ¼ */
        .fab { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: #333; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10000; cursor: pointer; }
        .fab.show { display: flex !important; }

        /* íŒì—… */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .popup-box { background: var(--pink-popup); width: 85%; max-width: 340px; padding: 30px 25px; border-radius: 30px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.15); border: 4px solid #fff; position: relative; max-height: 90vh; overflow-y: auto; }
        .pink-input { width: 100%; padding: 15px; background: #FFF9FC; border: 1px solid #FFE4E1; border-radius: 15px; margin-bottom: 10px; font-size: 14px; outline: none; }
        .btn-main { width: 100%; padding: 14px; border-radius: 15px; border: none; font-weight: 700; font-size: 15px; margin-top: 10px; cursor: pointer; background: var(--primary); color: white; }
        .btn-sub { background: #f5f5f5; color: #666; width: 100%; padding: 12px; border-radius: 15px; border: 1px solid #eee; font-weight: 600; margin-top: 5px; cursor: pointer; }

        .hidden { display: none !important; }
        .admin-badge { background: #333; color: white; padding: 3px 8px; border-radius: 5px; font-size: 10px; margin-left: 5px; }
        
        /* ì±Œë¦°ì§€ ì¹´ë“œ */
        .ch-card { background: white; border-radius: 20px; overflow: hidden; margin: 0 20px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .ch-img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .ch-info { padding: 20px; }
        .ch-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; background: linear-gradient(135deg, #FFB7B2, #FF9A9E); color: white; font-weight: 700; margin-top: 15px; cursor: pointer; }

        /* ì•Œë¦¼ íŒì—… */
        .custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #FFF0F5; padding: 25px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 12000; text-align: center; width: 80%; max-width: 300px; display: none; border: 2px solid white; }
    </style>
</head>
<body>

    <!-- ì•Œë¦¼ íŒì—… -->
    <div id="customAlert" class="custom-alert">
        <div style="font-size:35px; margin-bottom:15px;">ğŸŒ¸</div>
        <div id="alertMsg" style="margin-bottom:20px; font-weight:600; color:#555; line-height:1.5;">ì•Œë¦¼ ë‚´ìš©</div>
        <button onclick="window.closeAlert()" class="btn-main">í™•ì¸</button>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo clickable" onclick="window.renderTab('home')">Jahyu Letter</div>
        <div class="home-btn" onclick="window.renderTab('home')"><i class="fas fa-home"></i></div>
    </header>

    <div id="appContainer" class="app-container"></div>

    <nav class="bottom-nav">
        <div class="nav-item clickable" onclick="window.renderTab('home')"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item clickable" onclick="window.renderTab('letter')"><i class="fas fa-envelope-open-text"></i>ë ˆí„°</div>
        <div class="nav-item clickable" onclick="window.renderTab('mood')"><i class="fas fa-calendar-check"></i>ë¬´ë“œ</div>
        <div class="nav-item clickable" onclick="window.renderTab('editor')"><i class="fas fa-feather-alt"></i>ì—ë””í„°í†¡</div>
        <div class="nav-item clickable" onclick="window.renderTab('mypage')"><i class="fas fa-user-circle"></i>ë§ˆì´</div>
    </nav>

    <!-- ê¸€ì“°ê¸° ë²„íŠ¼ -->
    <div id="fab" class="fab clickable" onclick="window.openWriteModal()"><i class="fas fa-pen"></i></div>

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="popup-box">
            <h2 style="font-family:'Dancing Script'; color:var(--primary); margin-bottom:10px; font-size:32px;">Jahyu</h2>
            <p style="color:#888; margin-bottom:25px; font-size:14px;">ë‚˜ë¥¼ ìœ„í•œ ì‰¼í‘œ ğŸŒ¿</p>
            <div id="loginForm">
                <input type="email" id="authEmail" class="pink-input" placeholder="ì´ë©”ì¼">
                <input type="password" id="authPw" class="pink-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button onclick="window.doLogin()" class="btn-main">ìíœ´ë ˆí„° ì…ì¥í•˜ê¸°</button>
                <button onclick="window.toggleSignupMode()" class="btn-sub">ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”?</button>
                <p onclick="window.resetPw()" style="font-size:12px; color:#aaa; margin-top:15px; cursor:pointer; text-decoration:underline;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</p>
            </div>
            <div id="signupForm" class="hidden">
                <input type="text" id="regNick" class="pink-input" placeholder="ë‹‰ë„¤ì„">
                <input type="email" id="regEmail" class="pink-input" placeholder="ì´ë©”ì¼">
                <input type="password" id="regPw" class="pink-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)">
                <button onclick="window.doSignup()" class="btn-main">ê°€ì… ì™„ë£Œ</button>
                <button onclick="window.toggleSignupMode()" class="btn-sub">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="popup-box" style="text-align:left; max-width:400px; width:90%;">
            <h3 id="modalTitle" style="text-align:center; color:#555; margin-bottom:20px;">ê¸°ë¡í•˜ê¸°</h3>
            
            <!-- ë¬´ë“œ -->
            <div id="moodForm" class="hidden">
                <div id="emojiList" style="display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:15px;"></div>
                <textarea id="moodContent" class="pink-input" style="height:80px; text-align:left; resize:none;" placeholder="ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?"></textarea>
            </div>

            <!-- ê´€ë¦¬ì ê¸€ì“°ê¸° -->
            <div id="adminForm" class="hidden">
                <select id="postType" class="pink-input">
                    <option value="editor">â˜•ï¸ ì—ë””í„°í†¡</option>
                    <option value="letter">ğŸ’Œ ë ˆí„°</option>
                    <option value="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</option>
                </select>
                <input type="text" id="postTitle" class="pink-input" placeholder="ì œëª© (ì—ë””í„°í†¡ì€ ì—ë””í„° ì´ë¦„ì„ ì œëª©ìœ¼ë¡œ!)">
                <textarea id="postContent" class="pink-input" style="height:100px; text-align:left; resize:none;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-top:10px; border:1px solid #eee;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">ğŸ”— ì—°ê²° ë§í¬ (ì„ íƒ)</div>
                    <input type="text" id="postUrl" class="pink-input" style="margin-top:0;" placeholder="https://...">
                    <input type="text" id="btnText" class="pink-input" placeholder="ë²„íŠ¼ ì´ë¦„ (ì˜ˆ: ë³´ëŸ¬ê°€ê¸°)">
                </div>
            </div>

            <!-- ì±Œë¦°ì§€ ìƒì„± -->
            <div id="challengeForm" class="hidden">
                 <input type="text" id="chTitle" class="pink-input" placeholder="ì±Œë¦°ì§€ ì´ë¦„ (ì˜ˆ: ë¬¼ ë§ˆì‹œê¸°)">
                 <label style="font-size:12px; color:#888;">ì‹œì‘ì¼</label>
                 <input type="date" id="chStartDate" class="pink-input">
                 <label style="font-size:12px; color:#888;">ì¢…ë£Œì¼</label>
                 <input type="date" id="chEndDate" class="pink-input">
            </div>

            <button onclick="window.submitPost()" class="btn-main">ë“±ë¡í•˜ê¸°</button>
            <button onclick="window.closeModal()" class="btn-sub">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
    <div id="adminDashboardModal" class="modal-overlay">
        <div class="popup-box" style="text-align:left; max-height:80vh; overflow-y:auto;">
            <h3 style="text-align:center;">ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
            
            <div id="superAdminSection" class="hidden" style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h4 style="margin-bottom:5px;">ê´€ë¦¬ì ê¶Œí•œ ê´€ë¦¬</h4>
                <div style="display:flex; gap:5px;">
                    <input type="email" id="adminEmailInput" class="pink-input" style="flex:1; margin-bottom:0;" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    <button onclick="window.adminAction('add')" class="btn-main" style="width:auto; margin-top:0; padding:10px;">ì¶”ê°€</button>
                </div>
                <div id="adminListArea" style="margin-top:10px;"></div>
            </div>
            
            <button onclick="document.getElementById('adminDashboardModal').style.display='none'" class="btn-sub">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTab = 'home';
        let isAdmin = false;
        let isSuperAdmin = false;
        let selectedEmoji = null;
        let currentEditorFilter = null;

        const SUPER_ADMIN = 'hyeran5382@naver.com';
        const EDITORS = [
            { id: 'happci', name: 'í–…ì”¨', icon: 'âœï¸' },
            { id: 'gocal', name: 'ê³ ì¹¼', icon: 'ğŸª´' },
            { id: 'elly', name: 'ì—˜ë¦¬', icon: 'ğŸ¥¯' },
            { id: 'yudan', name: 'ìœ ë‹¨', icon: 'âš½' },
            { id: 'sunny', name: 'ì¨ë‹ˆ', icon: 'ğŸª' }
        ];
        const MOODS = ['â˜ï¸','ğŸ˜Š','ğŸ¥°','ğŸ˜­','ğŸ˜¡','ğŸ”¥','â˜”','ğŸ€','ğŸ·','ğŸ§¸','ğŸ§','ğŸ’¸','ğŸ¥‘','ğŸ§','ğŸ§˜â€â™€ï¸','ğŸ‘»','ğŸ¤§','ğŸ§¶','ğŸŒ™','ğŸ°'];

        // --- ìœ í‹¸ ---
        window.showAlert = (msg) => {
            document.getElementById('alertMsg').innerHTML = msg;
            document.getElementById('customAlert').style.display = 'flex';
        };
        window.closeAlert = () => document.getElementById('customAlert').style.display = 'none';

        window.closeModal = () => {
            document.getElementById('writeModal').style.display = 'none';
            checkFabVisibility();
        };

        function checkFabVisibility() {
            const fab = document.getElementById('fab');
            fab.classList.remove('show'); 
            if (currentTab === 'mood') fab.classList.add('show');
            else if (isAdmin && (currentTab === 'editor' || currentTab === 'letter' || currentTab === 'challenge')) fab.classList.add('show');
        }

        // --- íƒ­ ë Œë”ë§ ---
        window.renderTab = (tab, filter = null) => {
            currentTab = tab;
            if(tab === 'editor') currentEditorFilter = filter;
            window.scrollTo(0, 0);
            
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[onclick*="${tab}"]`);
            if (activeNav) activeNav.classList.add('active');

            checkFabVisibility();

            if (tab === 'home') renderHome(container);
            else if (tab === 'letter') renderLetter(container);
            else if (tab === 'mood') renderMood(container);
            else if (tab === 'editor') renderEditor(container);
            else if (tab === 'challenge') renderChallenge(container);
            else if (tab === 'mypage') renderMyPage(container);
        };

        function renderHome(container) {
            container.innerHTML = `
                <div style="padding:20px;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <h2 style="font-size:20px; color:#444;">${currentUser.displayName}ë‹˜, ì˜¤ëŠ˜ ë§ˆìŒì€ ì–´ë•Œìš”?</h2>
                        <p style="font-size:13px; color:#888;">ìíœ´ë ˆí„°ì™€ í•¨ê»˜ ì ì‹œ ì‰¬ì–´ê°€ì„¸ìš” ğŸŒ¿</p>
                    </div>
                    <div class="hero-card" onclick="window.open('https://index-html-zak5.vercel.app/', '_blank')" style="background:linear-gradient(135deg, #E0C3FC, #8EC5FC); padding:30px; border-radius:20px; color:white; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.1); margin-bottom:30px;">
                        <div style="font-size:18px; font-weight:700;">ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì‰¼ ìœ í˜•ì€?</div>
                        <div style="font-size:13px; margin-top:5px;">íë§ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ ê°€ê¸° ğŸ‘‰</div>
                    </div>
                    <div class="quick-menu" style="display:flex; justify-content:space-between; padding:0 10px;">
                        <div class="quick-item clickable" onclick="window.renderTab('letter')" style="display:flex; flex-direction:column; align-items:center; width:22%;"><div class="quick-icon" style="background:#FFB7B2; width:55px; height:55px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; margin-bottom:8px;"><i class="fas fa-envelope-open-text"></i></div><span style="font-size:11px; color:#666;">ë ˆí„°</span></div>
                        <div class="quick-item clickable" onclick="window.renderTab('challenge')" style="display:flex; flex-direction:column; align-items:center; width:22%;"><div class="quick-icon" style="background:#B5EAD7; width:55px; height:55px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; margin-bottom:8px;"><i class="fas fa-running"></i></div><span style="font-size:11px; color:#666;">ì±Œë¦°ì§€</span></div>
                        <div class="quick-item clickable" onclick="window.open('https://pf.kakao.com/_Jfjxgn/111753149', '_blank')" style="display:flex; flex-direction:column; align-items:center; width:22%;"><div class="quick-icon" style="background:#C7CEEA; width:55px; height:55px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; margin-bottom:8px;"><i class="fas fa-pen-nib"></i></div><span style="font-size:11px; color:#666;">ë¬¸ì¥ìˆ˜ì§‘</span></div>
                        <div class="quick-item clickable" onclick="window.open('https://pf.kakao.com/_Jfjxgn', '_blank')" style="display:flex; flex-direction:column; align-items:center; width:22%;"><div class="quick-icon" style="background:#FFDAC1; width:55px; height:55px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:22px; margin-bottom:8px;"><i class="fas fa-comments"></i></div><span style="font-size:11px; color:#666;">ì±„íŒ…</span></div>
                    </div>
                </div>`;
        }

        function renderLetter(container) {
            container.innerHTML = `
                <div style="padding:0 20px;">
                    <div class="archive-tabs" style="display:flex; justify-content:center; gap:8px; margin:20px 0;">
                        <div class="tab-btn active clickable" onclick="window.fetchPosts('all', 'letterList', this)">ì „ì²´</div>
                        <div class="tab-btn clickable" onclick="window.fetchPosts('letter', 'letterList', this)">ìíœ´ë ˆí„°</div>
                        <div class="tab-btn clickable" onclick="window.fetchPosts('notice', 'letterList', this)">ê³µì§€ì‚¬í•­</div>
                    </div>
                    <div id="letterList" class="card-list"></div>
                </div>`;
            window.fetchPosts('all', 'letterList');
        }

        function renderMood(container) {
            container.innerHTML = `
                <div style="padding:0 20px;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <h2 style="margin-bottom:5px;">My Mood Log</h2>
                        <p style="font-size:13px; color:#aaa;">ì˜¤ëŠ˜ í•˜ë£¨, ì†”ì§í•œ ê°ì •ì„ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ”’</p>
                    </div>
                    <div class="cal-container" id="moodCapture">
                        <div class="cal-header"><span>${new Date().getMonth()+1}ì›”</span></div>
                        <div class="cal-grid" style="margin-bottom:10px; font-size:12px; color:#888;"><div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
                        <div id="calGrid" class="cal-grid"></div>
                    </div>
                    <div style="text-align:center; margin:20px 0;">
                        <button onclick="window.saveImage('moodCapture')" class="btn-sub" style="width:auto; padding:10px 20px;"><i class="fas fa-download"></i> ì´ë¯¸ì§€ ì €ì¥</button>
                    </div>
                    <div id="moodList"></div>
                </div>`;
            window.loadCalendar();
            window.fetchPosts('mood', 'moodList');
        }

        function renderEditor(container) {
            let filterHtml = currentEditorFilter ? `<div style="text-align:center; margin-bottom:20px; font-size:16px; font-weight:700; color:var(--primary);">ì—ë””í„° ${currentEditorFilter}ë‹˜ì˜ ì´ì•¼ê¸° <i class="fas fa-times clickable" onclick="window.renderTab('editor')"></i></div>` : `<div style="margin-top:20px;" class="section-header">ì—ë””í„°ì˜ ì‘ì—…ì‹¤ â˜•ï¸</div>`;
            
            container.innerHTML = `
                <div style="padding:0 20px;">
                    ${currentEditorFilter ? '' : '<div style="text-align:center; margin:20px 0; font-weight:700; color:#555;">ì—ë””í„°í†¡</div>'}
                    <div class="editor-container">
                        ${EDITORS.map(e => `
                            <div class="editor-item" onclick="window.renderTab('editor', '${e.name}')">
                                <div class="editor-circle ${currentEditorFilter === e.name ? 'active' : ''}">
                                    <div class="editor-icon" style="font-size:28px;">${e.icon}</div>
                                </div>
                                <div class="editor-name">${e.name}</div>
                            </div>`).join('')}
                    </div>
                    ${filterHtml}
                    <div id="editorList" class="card-list"></div>
                </div>`;
            window.fetchPosts('editor', 'editorList');
        }

        function renderChallenge(container) {
            container.innerHTML = `
                <div style="padding:20px; text-align:center; background:#F3E5F5; border-radius:0 0 30px 30px; margin-bottom:20px;">
                    <h3>ê±´ê°•í•œ ìŠµê´€ì„ ë§Œë“¤ì–´ ë³¼ê¹Œìš”? ğŸƒâ€â™€ï¸</h3>
                    <p style="font-size:13px; color:#888;">ì‘ì€ ìŠµê´€ì´ ëª¨ì—¬ í° ë³€í™”ë¥¼ ë§Œë“¤ì–´ìš”!</p>
                </div>
                <div id="challengeList" style="padding:0 20px;"></div>
            `;
            window.fetchChallenges();
        }

        function renderMyPage(container) {
            let adminHtml = '';
            if (isSuperAdmin || isAdmin) {
                adminHtml = `<button onclick="window.openAdminDashboard()" class="btn-sub" style="margin-top:10px; background:#333; color:white;">ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</button>`;
            }

            container.innerHTML = `
                <div style="text-align:center; padding:30px 20px;">
                    <h3 style="margin-bottom:5px;">${currentUser.displayName}ë‹˜${isAdmin ? ' <span class="badge-editor">ì—ë””í„°</span>' : ''}</h3>
                    <p style="font-size:13px; color:#888;">${currentUser.email}</p>
                    ${adminHtml}
                </div>
                <div style="padding:0 20px;">
                    <div class="stamp-board">
                        <h4>ë‚˜ì˜ ìŠ¤íƒ¬í”„ ğŸ¾</h4>
                        <p style="font-size:12px; color:#888; margin-bottom:15px;">30ê°œë¥¼ ëª¨ìœ¼ë©´ ìŠ¤í˜ì…œ ë ˆí„°ê°€ ë„ì°©í•´ìš”!</p>
                        <div id="stampGrid" class="stamp-grid"></div>
                    </div>
                    <div class="menu-list">
                        <div class="menu-item" onclick="window.showMyData('posts')">ğŸ“ ë‚´ê°€ ì“´ ê¸€ <i class="fas fa-chevron-right"></i></div>
                        <div class="menu-item" onclick="window.showMyData('comments')">ğŸ’¬ ë‚´ê°€ ì“´ ëŒ“ê¸€ <i class="fas fa-chevron-right"></i></div>
                        <div class="menu-item" onclick="window.showMyData('bookmarks')">ğŸ”– ë¶ë§ˆí¬ <i class="fas fa-chevron-right"></i></div>
                        <div class="menu-item" onclick="window.resetPw()">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ <i class="fas fa-chevron-right"></i></div>
                        <div class="menu-item" onclick="window.handleLogout()" style="color:#FF6B6B;">ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ</div>
                    </div>
                </div>`;
            window.loadStamps();
        }

        // --- ê¸°ëŠ¥ ë¡œì§ ---
        window.openWriteModal = () => {
            document.getElementById('writeModal').style.display = 'flex';
            document.getElementById('moodForm').classList.add('hidden');
            document.getElementById('adminForm').classList.add('hidden');
            document.getElementById('challengeForm').classList.add('hidden');

            if(currentTab === 'mood') {
                document.getElementById('moodForm').classList.remove('hidden');
                document.getElementById('modalTitle').innerText = "ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€? â˜ï¸";
                document.getElementById('emojiList').innerHTML = MOODS.map(m => `<div class="clickable" style="font-size:28px; text-align:center;" onclick="window.selectEmoji('${m}', this)">${m}</div>`).join('');
            } else if (currentTab === 'challenge') {
                document.getElementById('challengeForm').classList.remove('hidden');
                document.getElementById('modalTitle').innerText = "ì±Œë¦°ì§€ ê°œì„¤ ğŸ”¥";
            } else if(isAdmin) {
                document.getElementById('adminForm').classList.remove('hidden');
                document.getElementById('modalTitle').innerText = "ê´€ë¦¬ì ê¸€ì“°ê¸° âœï¸";
            }
        };

        window.submitPost = async () => {
            const now = new Date();
            try {
                if(currentTab === 'mood') {
                    if (!selectedEmoji) return window.showAlert("ê¸°ë¶„ ì´ëª¨ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
                    await addDoc(collection(db, "posts"), {
                        type: 'mood', emoji: selectedEmoji, content: document.getElementById('moodContent').value,
                        date: now.toISOString(), authorId: currentUser.uid
                    });
                    const userRef = doc(db, "users", currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    await setDoc(userRef, { stamps: (userSnap.data()?.stamps || 0) + 1 }, { merge: true });
                    window.showAlert("ê¸°ë¡ ì™„ë£Œ! ìŠ¤íƒ¬í”„ +1 ğŸ¾");
                } else if(currentTab === 'challenge') {
                    await addDoc(collection(db, "posts"), {
                        type: 'challenge', title: document.getElementById('chTitle').value,
                        startDate: document.getElementById('chStartDate').value,
                        endDate: document.getElementById('chEndDate').value,
                        date: now.toISOString()
                    });
                    window.showAlert("ì±Œë¦°ì§€ ë“±ë¡ ì™„ë£Œ!");
                } else if (isAdmin) {
                    await addDoc(collection(db, "posts"), {
                        type: document.getElementById('postType').value,
                        title: document.getElementById('postTitle').value,
                        content: document.getElementById('postContent').value,
                        url: document.getElementById('postUrl').value,
                        btnText: document.getElementById('btnText').value,
                        date: now.toISOString(), authorId: currentUser.uid
                    });
                    window.showAlert("ë“±ë¡ ì™„ë£Œ!");
                }
                window.closeModal();
                window.renderTab(currentTab);
            } catch(e) { window.showAlert("ì˜¤ë¥˜: " + e.message); }
        };

        // ê¸°íƒ€ í•„ìˆ˜ í•¨ìˆ˜ë“¤ (fetchPosts, loadCalendar ë“±)
        window.fetchPosts = async (type, elId) => {
            const list = document.getElementById(elId);
            list.innerHTML = '';
            let q = query(collection(db, "posts"), orderBy("date", "desc")); // ë‹¨ìˆœ ì¿¼ë¦¬
            const snap = await getDocs(q);
            snap.forEach(d => {
                const data = d.data();
                if(data.type !== type && !(type==='all' && (data.type==='letter'||data.type==='notice'))) return;
                // ì—ë””í„°í†¡ í•„í„°
                if(type==='editor' && currentEditorFilter && data.title !== currentEditorFilter) return;

                if(type === 'mood') {
                    list.innerHTML += `<div class="card" style="display:flex; gap:15px; align-items:center;"><div style="font-size:30px;">${data.emoji}</div><div><div style="font-size:12px; color:#aaa;">${new Date(data.date).toLocaleDateString()}</div><div style="font-size:14px; margin-top:2px;">${data.content}</div></div></div>`;
                } else {
                    list.innerHTML += `
                        <div class="card">
                            <div style="font-weight:700; margin-bottom:5px;">${data.type==='notice'?'ğŸ“¢ ':''}${data.title}</div>
                            <div style="font-size:14px; color:#444; line-height:1.5;">${data.content}</div>
                            ${data.url ? `<button onclick="window.open('${data.url}')" class="btn-sub" style="width:auto; padding:8px 15px; font-size:12px; margin-top:10px;">${data.btnText || 'ë³´ëŸ¬ê°€ê¸°'}</button>` : ''}
                            ${type==='letter' || type==='editor' || type==='notice' ? `<div class="delete-btn" onclick="window.deletePost('${d.id}')">ì‚­ì œ</div>` : ''}
                        </div>`;
                }
            });
        };

        window.fetchChallenges = async () => {
            const list = document.getElementById('challengeList');
            list.innerHTML = '';
            const q = query(collection(db, "posts"), where("type", "==", "challenge"));
            const snap = await getDocs(q);
            if(snap.empty) list.innerHTML = `<div style="text-align:center; color:#aaa; margin-top:20px;">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš”.</div>`;
            snap.forEach(d => {
                const p = d.data();
                list.innerHTML += `
                    <div class="ch-card">
                        <div class="ch-img"></div>
                        <div class="ch-content">
                            <span style="font-size:11px; background:#F3E5F5; color:#9D76C1; padding:4px 8px; border-radius:8px;">${p.startDate} ~ ${p.endDate}</span>
                            <div style="font-size:18px; font-weight:800; margin:10px 0;">${p.title}</div>
                            <button class="ch-btn" onclick="window.showAlert('ì°¸ì—¬ ì™„ë£Œ! (ì¸ì¦ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘)')">ì°¸ì—¬í•˜ê¸°</button>
                             <div class="delete-btn" style="position:relative; text-align:right; margin-top:10px;" onclick="window.deletePost('${d.id}')">ì‚­ì œ</div>
                        </div>
                    </div>`;
            });
        };
        
        window.deletePost = async (id) => {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await deleteDoc(doc(db, "posts", id));
                window.renderTab(currentTab);
            }
        };

        window.loadCalendar = async () => {
            const grid = document.getElementById('calGrid');
            const now = new Date();
            const year = now.getFullYear(); const month = now.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const moods = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === month && date.getFullYear() === year) moods[date.getDate()] = d.data().emoji;
            });
            for(let i=1; i<=lastDate; i++) {
                grid.innerHTML += `<div class="day-cell ${moods[i] ? 'today' : ''}"><span style="position:absolute; top:2px; left:4px; font-size:9px;">${i}</span><span class="day-emoji">${moods[i] || ''}</span></div>`;
            }
        };

        window.loadStamps = async () => { 
            const userSnap = await getDoc(doc(db, "users", currentUser.uid)); 
            const count = userSnap.data()?.stamps || 0; 
            const grid = document.getElementById('stampGrid'); 
            grid.innerHTML = ''; 
            for(let i=1; i<=30; i++) { 
                grid.innerHTML += `<div class="stamp-slot ${i<=count?'active':''}">${i}</div>`; 
            } 
        };

        window.showMyData = async (type) => {
            const container = document.getElementById('appContainer');
            container.innerHTML = `
                <div class="header" style="justify-content: flex-start; padding-left: 20px;">
                    <i class="fas fa-arrow-left clickable" style="font-size:24px;" onclick="window.renderTab('mypage')"></i>
                </div>
                <h3 style="padding:0 20px;">ë³´ê´€í•¨</h3>
                <div id="myList" class="card-list" style="margin-top:20px;">ë¡œë”©ì¤‘...</div>
            `;
            const list = document.getElementById('myList');
            const q = query(collection(db, "posts"), where("authorId", "==", currentUser.uid)); // ë‚´ ê¸€ ì „ì²´
            const snap = await getDocs(q);
            list.innerHTML = '';
            if(snap.empty) list.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">ì•„ì§ ì—†ì–´ìš”!</div>';
            
            snap.forEach(d => {
                const data = d.data();
                // íƒ€ì… í•„í„° (ëŒ“ê¸€, ë¶ë§ˆí¬ëŠ” êµ¬ì¡°ìƒ ìƒëµ, ë‚´ê°€ ì“´ ê¸€ë§Œ í‘œì‹œ)
                if(type === 'posts' && (data.type === 'mood' || data.type === 'post')) {
                    list.innerHTML += `<div class="card">${data.content || data.title}</div>`;
                }
            });
        };
        
        window.openAdminDashboard = () => { document.getElementById('adminDashboardModal').style.display='flex'; window.loadAdminList(); };
        window.loadAdminList = async () => {
            const list = document.getElementById('adminListArea');
            list.innerHTML = 'ë¡œë”©ì¤‘...';
            const q = query(collection(db, "admins"));
            const snap = await getDocs(q);
            list.innerHTML = '';
            snap.forEach(d => {
                list.innerHTML += `<div class="admin-list-item"><span>${d.id}</span><span class="delete-btn" style="position:static; color:red;" onclick="window.removeAdmin('${d.id}')">ì‚­ì œ</span></div>`;
            });
        };
        window.adminAction = async (action) => {
            if(action === 'add') {
                const email = document.getElementById('adminEmailInput').value;
                if(email) {
                    await setDoc(doc(db, "admins", email), { addedBy: currentUser.email });
                    window.loadAdminList();
                    window.showAlert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }
        };
        window.removeAdmin = async (email) => {
             if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                 await deleteDoc(doc(db, "admins", email));
                 window.loadAdminList();
             }
        };

        // --- ì¸ì¦ ---
        window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('authEmail').value, document.getElementById('authPw').value); } catch(e) { window.showAlert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); } };
        window.doSignup = async () => { try { const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPw').value); await updateProfile(cred.user, { displayName: document.getElementById('regNick').value }); await setDoc(doc(db, "users", cred.user.uid), { stamps: 0 }); window.showAlert("í™˜ì˜í•©ë‹ˆë‹¤!"); } catch(e) { window.showAlert("ê°€ì… ì˜¤ë¥˜: " + e.message); } };
        window.toggleSignupMode = () => { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('signupForm').classList.toggle('hidden'); };
        window.resetPw = () => {
             const email = prompt("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");
             if(email) sendPasswordResetEmail(auth, email).then(()=>window.showAlert("ë©”ì¼ ë°œì†¡!")).catch(()=>window.showAlert("ì´ë©”ì¼ í™•ì¸ í•„ìš”")); 
        };
        window.handleLogout = async () => { await signOut(auth); window.location.reload(); };
        window.saveImage = (targetId) => { const el = document.getElementById(targetId); html2canvas(el).then(canvas => { const link = document.createElement("a"); link.download = `jahyu_mood.png`; link.href = canvas.toDataURL(); link.click(); }); };
        window.selectEmoji = (m, el) => { selectedEmoji = m; document.querySelectorAll('#emojiList div').forEach(d => d.style.background = 'none'); el.style.background = 'var(--primary-light)'; el.style.borderRadius = '50%'; };

        // ì´ˆê¸°í™”
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                // ê´€ë¦¬ì ì²´í¬ (DB í™•ì¸)
                if(user.email === SUPER_ADMIN) { isSuperAdmin = true; isAdmin = true; }
                else {
                    const docSnap = await getDoc(doc(db, "admins", user.email));
                    isAdmin = docSnap.exists();
                }
                
                document.getElementById('authModal').style.display = 'none';
                window.renderTab('home');
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>