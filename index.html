<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jahyu Letter</title>
    
    <!-- í°íŠ¸ & ì•„ì´ì½˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Gaegu:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #9D76C1;
            --primary-soft: #F3E5F5;
            --pink-bg: #FFF0F5;
            --pink-input: #FFEFF2;
            --accent: #FFB7B2;
            --bg-body: #F9F9F9;
            --text-main: #333;
            --text-sub: #888;
            --shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nanum Round Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--bg-body); padding-bottom: 100px; position: relative; }

        /* âœ¨ í—¤ë” (ì•„ì´ì½˜ ì—†ì´ ê¹”ë”í•˜ê²Œ) */
        .header { padding: 20px; text-align: center; background: transparent; height: 60px; display: flex; align-items: center; justify-content: center; margin-top: 10px; }
        .logo { font-family: 'Dancing Script', cursive; font-size: 32px; color: var(--primary); font-weight: 700; }

        /* ë²„íŠ¼ ë°˜ì‘í˜• íš¨ê³¼ */
        .btn-hover { transition: transform 0.1s, opacity 0.1s; cursor: pointer; }
        .btn-hover:active { transform: scale(0.96); opacity: 0.8; }

        /* íƒ­ ë²„íŠ¼ */
        .tab-wrap { display: flex; justify-content: center; gap: 8px; margin: 15px 0 25px; flex-wrap: wrap; }
        .tab-btn { 
            padding: 8px 18px; border-radius: 20px; 
            background: white; border: 1px solid #E0E0E0; 
            color: #888; font-size: 13px; font-weight: 700; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(157, 118, 193, 0.3); }

        /* ğŸ  í™ˆ */
        .home-section { text-align: center; padding-top: 10px; }
        .hero-card { margin: 20px; padding: 30px; background: linear-gradient(135deg, #E0C3FC, #8EC5FC); border-radius: 25px; color: white; text-align: center; box-shadow: var(--shadow); }
        .quick-menu { display: flex; justify-content: space-between; padding: 0 30px; margin-bottom: 30px; }
        .quick-icon { width: 55px; height: 55px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; box-shadow: var(--shadow); margin-bottom: 8px; }
        .ic-1 { background: #FFB7B2; } .ic-2 { background: #B5EAD7; } .ic-3 { background: #C7CEEA; } .ic-4 { background: #FFDAC1; }
        .quick-text { font-size: 11px; font-weight: 700; color: #888; }

        /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .card-list { padding: 0 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); position: relative; border: 1px solid white; }
        .card-badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; margin-bottom: 8px; background: #eee; color: #666; }
        .card-badge.notice { background: #FFD43B; color: #862E9C; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; color: #333; }
        .card-meta { font-size: 12px; color: #aaa; display: flex; justify-content: space-between; margin-top: 10px; }
        
        /* ì±Œë¦°ì§€ ì¹´ë“œ */
        .ch-card { background: white; border-radius: 20px; overflow: hidden; margin: 0 20px 20px; box-shadow: var(--shadow); }
        .ch-img { width: 100%; height: 160px; background: #eee; object-fit: cover; }
        .ch-content { padding: 20px; }
        .ch-title { font-size: 18px; font-weight: 800; margin: 10px 0; }
        .ch-meta { font-size: 13px; color: #888; display: flex; gap: 10px; margin-bottom: 15px; }
        .ch-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; background: linear-gradient(135deg, #FFB7B2, #FF9A9E); color: white; font-weight: 700; margin-top: 10px; cursor: pointer; }

        /* ğŸ—“ï¸ ìº˜ë¦°ë” */
        .cal-wrap { background: #F3E5F5; border-radius: 25px; padding: 20px; margin: 0 20px 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 10px; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; }
        .day-cell.today { border: 2px solid var(--primary); background: white; font-weight: 700; color: var(--primary); }

        /* ğŸ‘¤ ë§ˆì´í˜ì´ì§€ (ë©”ë‰´ ê¹”ë”í•˜ê²Œ) */
        .menu-list { background: white; border-radius: 20px; margin: 0 20px 20px; padding: 5px 0; box-shadow: var(--shadow); }
        .menu-item { 
            padding: 18px 20px; border-bottom: 1px solid #f5f5f5; 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 15px; color: #444; font-weight: 500; cursor: pointer;
        }
        .menu-item:last-child { border-bottom: none; }
        
        /* ìŠ¤íƒ¬í”„ (íŒŒìŠ¤í…”í†¤) */
        .stamp-board { background: white; padding: 25px; border-radius: 25px; margin: 20px; box-shadow: var(--shadow); text-align: center; }
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .stamp { 
            aspect-ratio: 1/1; border-radius: 50%; 
            background: #F3E5F5; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 12px; color: #C4B5FD; font-weight: 700; 
        }
        .stamp.active { background: var(--primary); color: white; box-shadow: 0 3px 8px rgba(157, 118, 193, 0.4); }

        /* í•˜ë‹¨ë°” & FAB */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 80px; background: rgba(255,255,255,0.98); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 1px solid #eee; padding-bottom: 15px; }
        .nav-item { color: #ccc; width: 60px; text-align: center; font-size: 10px; cursor: pointer; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--primary); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: #333; border-radius: 50%; color: white; display: none; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 900; }

        /* ëª¨ë‹¬ & íŒì—… */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .write-box { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 30px; border: 3px solid #FFF0F5; max-height: 90vh; overflow-y: auto; }
        .pink-input { width: 100%; padding: 15px; background: #FFF9FC; border: 1px solid #FFE4E1; border-radius: 15px; margin-bottom: 10px; font-size: 14px; outline: none; }
        .btn-pretty { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; margin-top: 5px; }
        .btn-ok { background: linear-gradient(135deg, #FFB7B2, #FF9A9E); color: white; }
        .btn-no { background: #f5f5f5; color: #888; margin-top: 10px; }
        
        .hidden { display: none !important; }
        .custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #FFF0F5; padding: 25px; border-radius: 25px; z-index: 5000; text-align: center; width: 80%; border: 2px solid white; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <!-- ì•Œë¦¼ íŒì—… -->
    <div id="customAlert" class="custom-alert">
        <div style="font-size:30px; margin-bottom:10px;">ğŸŒ¸</div>
        <div id="alertMsg" style="margin-bottom:20px; font-weight:700; color:#555; word-break: keep-all;">ë©”ì‹œì§€</div>
        <button onclick="closeAlert()" class="btn-pretty btn-ok btn-hover">í™•ì¸</button>
    </div>

    <!-- ìº¡ì²˜ ì˜ì—­ -->
    <div id="captureArea" style="position:fixed; top:-9999px; left:-9999px; background:white; padding:40px; width:360px; text-align:center;">
        <div style="font-family:'Dancing Script'; font-size:30px; color:#9D76C1; margin-bottom:20px;">Jahyu Letter</div>
        <div id="captureContent" style="font-size:16px; line-height:1.6;"></div>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo" onclick="renderTab('home')">Jahyu Letter</div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="app-container"></div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ -->
    <nav class="bottom-nav">
        <div class="nav-item active btn-hover" id="nav-home" onclick="renderTab('home')"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item btn-hover" id="nav-letter" onclick="renderTab('letter')"><i class="fas fa-envelope-open-text"></i>ë ˆí„°</div>
        <div class="nav-item btn-hover" id="nav-mood" onclick="renderTab('mood')"><i class="fas fa-calendar-alt"></i>ë¬´ë“œ</div>
        <div class="nav-item btn-hover" id="nav-challenge" onclick="renderTab('challenge')"><i class="fas fa-running"></i>ì±Œë¦°ì§€</div>
        <div class="nav-item btn-hover" id="nav-mypage" onclick="renderTab('mypage')"><i class="fas fa-user-circle"></i>ë§ˆì´</div>
    </nav>

    <!-- FAB -->
    <div id="fab" class="fab btn-hover" onclick="openWriteModal()"><i class="fas fa-pen"></i></div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="write-box" style="text-align:center;">
            <div style="font-family:'Dancing Script'; font-size:40px; color:var(--primary); margin-bottom:10px;">Jahyu Letter</div>
            <p style="color:#aaa; margin-bottom:30px;">ë‹¹ì‹ ì„ ìœ„í•œ ì‰¼í‘œ ğŸŒ¿</p>
            <input type="email" id="email" class="pink-input" placeholder="ì´ë©”ì¼">
            <input type="password" id="pw" class="pink-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="doLogin()" class="btn-pretty btn-ok btn-hover">ìíœ´ë ˆí„° ì‹œì‘í•˜ê¸°</button>
            <button onclick="doSignup()" class="btn-pretty btn-no btn-hover">ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”? (ê°€ì…)</button>
            <p onclick="document.getElementById('pwModal').style.display='block'" style="font-size:12px; color:#aaa; margin-top:20px; cursor:pointer; text-decoration:underline;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</p>
        </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • íŒì—… -->
    <div id="pwModal" class="custom-alert" style="background:white; border:3px solid #FFE0E6;">
        <h3 style="color:var(--primary); margin-bottom:10px;">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h3>
        <p style="font-size:13px; color:#888; margin-bottom:15px; line-height:1.4;">ê°€ì…í•˜ì‹  ì´ë©”ì¼ë¡œ<br>ì¬ì„¤ì • ë©”ì¼ì„ ë³´ë‚´ë“œë¦´ê²Œìš” ğŸ“¨</p>
        <input type="email" id="resetEmail" class="pink-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <button onclick="sendResetEmail()" class="btn-pretty btn-ok btn-hover">ë©”ì¼ ë³´ë‚´ê¸°</button>
        <button onclick="document.getElementById('pwModal').style.display='none'" class="btn-pretty btn-no btn-hover">ë‹«ê¸°</button>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="write-box">
            <h3 style="text-align:center; color:var(--primary); margin-bottom:20px;">ê¸°ë¡í•˜ê¸° âœï¸</h3>
            
            <div id="letterOptions" class="hidden">
                <select id="postCategory" class="pink-input">
                    <option value="ìíœ´ë ˆí„°">ìíœ´ë ˆí„°</option>
                    <option value="ìíœ´ë©">ìíœ´ë©</option>
                    <option value="ì—ë””í„°í†¡">ì—ë””í„°í†¡</option>
                </select>
                <label><input type="checkbox" id="isNotice"> ğŸ“Œ ê³µì§€ì‚¬í•­</label>
            </div>

            <div id="challengeOptions" class="hidden">
                <label style="font-size:12px; color:#888;">ì‹œì‘ì¼</label>
                <input type="date" id="chStartDate" class="pink-input">
                <label style="font-size:12px; color:#888;">ì¢…ë£Œì¼</label>
                <input type="date" id="chEndDate" class="pink-input">
            </div>

            <div id="moodOptions" class="hidden" style="margin-bottom:15px; overflow-x:auto; white-space:nowrap;">
                <div id="emojiList"></div>
            </div>

            <input type="text" id="postTitle" class="pink-input" placeholder="ì œëª©">
            <textarea id="postContent" class="pink-input" style="height:100px; resize:none;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            
            <div onclick="document.getElementById('fileInput').click()" style="padding:15px; border:2px dashed #FFD1DC; border-radius:15px; text-align:center; color:#D66D75; cursor:pointer; margin:15px 0; font-size:13px;">
                <i class="fas fa-camera"></i> ì‚¬ì§„ ì¶”ê°€
            </div>
            <input type="file" id="fileInput" hidden accept="image/*">

            <button onclick="submitPost()" class="btn-pretty btn-ok btn-hover">ë“±ë¡í•˜ê¸°</button>
            <button onclick="closeModal()" class="btn-pretty btn-no btn-hover">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="adminManageModal" class="modal-overlay">
        <div class="write-box">
            <h3>ğŸ‘‘ ê´€ë¦¬ì ê´€ë¦¬</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="email" id="newAdminEmail" class="pink-input" placeholder="ì´ë©”ì¼ ì…ë ¥" style="margin-bottom:0;">
                <button onclick="addNewAdmin()" class="btn-pretty btn-ok btn-hover" style="width:80px; margin-top:0;">ì¶”ê°€</button>
            </div>
            <div id="adminList" style="max-height:200px; overflow-y:auto;"></div>
            <button onclick="document.getElementById('adminManageModal').style.display='none'" class="btn-pretty btn-no btn-hover">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, orderBy, updateDoc, deleteDoc, arrayUnion, arrayRemove, setDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ í–…ì‚ë‹˜ í‚¤ê°’ ë‚´ì¥ ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isAdmin = false;
        let currentTab = 'home';
        let currentChallengeId = null;
        const SUPER_ADMIN = 'hyeran5382@naver.com';
        const MOODS = ['ğŸ˜Š','ğŸ¥°','ğŸ˜Œ','ğŸ˜­','ğŸ˜¡','ğŸ˜´','ğŸ¤©','ğŸ¤”','ğŸ¥º','ğŸ”¥','â˜”','ğŸ€'];

        // ìœ í‹¸ í•¨ìˆ˜
        window.showAlert = (msg) => { document.getElementById('alertMsg').innerText = msg; document.getElementById('customAlert').style.display = 'block'; };
        window.closeAlert = () => document.getElementById('customAlert').style.display = 'none';
        window.closeModal = () => document.getElementById('writeModal').style.display = 'none';

        // ê´€ë¦¬ì ì²´í¬
        async function checkIsAdmin(email) {
            if(email === SUPER_ADMIN) return true;
            try {
                const docSnap = await getDoc(doc(db, "admins", email));
                return docSnap.exists();
            } catch(e) { return false; }
        }

        // ì¸ì¦
        window.doLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value); }
            catch(e) { window.showAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"); }
        };
        window.doSignup = async () => {
            const nick = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if(!nick) return;
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value);
                await updateProfile(cred.user, { displayName: nick });
                await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, name: nick, stamps: 0 });
                if(cred.user.email === SUPER_ADMIN) await setDoc(doc(db, "admins", cred.user.email), { role: 'super' });
                window.showAlert("ê°€ì… ì™„ë£Œ! í™˜ì˜í•©ë‹ˆë‹¤ ğŸŒ¸");
            } catch(e) { window.showAlert("ì˜¤ë¥˜: " + e.message); }
        };
        window.sendResetEmail = async () => {
            const email = document.getElementById('resetEmail').value;
            if(email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    window.showAlert("ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆì–´ìš”!");
                    document.getElementById('pwModal').style.display = 'none';
                } catch(e) { window.showAlert("ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); }
            }
        };
        window.handleLogout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        // íƒ­ ë Œë”ë§
        window.renderTab = (tab) => {
            currentTab = tab;
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`)?.classList.add('active');

            const fab = document.getElementById('fab');
            if(tab === 'mood') fab.style.display = 'flex';
            else if(isAdmin && (tab === 'letter' || tab === 'challenge')) fab.style.display = 'flex';
            else fab.style.display = 'none';

            if (tab === 'home') {
                container.innerHTML = `
                    <div class="home-section">
                        <div class="greeting">
                            <h2>${currentUser.displayName}ë‹˜, ì˜¤ëŠ˜ ë§ˆìŒì€ ì–´ë•Œìš”?</h2>
                            <p>ìíœ´ë ˆí„°ì™€ í•¨ê»˜ ì ì‹œ ì‰¬ì–´ê°€ì„¸ìš” ğŸŒ¿</p>
                        </div>
                        <div class="hero-card" onclick="window.open('https://index-html-zak5.vercel.app/')">
                            <div style="font-size:18px; font-weight:700;">ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì‰¼ ìœ í˜•ì€?</div>
                            <div style="font-size:13px; margin-top:5px;">íë§ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸° ğŸ‘‰</div>
                        </div>
                        <div class="quick-menu">
                            <div class="quick-item btn-hover" onclick="renderTab('letter')"><div class="quick-icon ic-1"><i class="fas fa-envelope-open-text"></i></div><span class="quick-text">ë ˆí„°</span></div>
                            <div class="quick-item btn-hover" onclick="renderTab('challenge')"><div class="quick-icon ic-2"><i class="fas fa-running"></i></div><span class="quick-text">ì±Œë¦°ì§€</span></div>
                            <div class="quick-item btn-hover" onclick="window.open('https://pf.kakao.com/_Jfjxgn/111753149')"><div class="quick-icon ic-3"><i class="fas fa-pen-nib"></i></div><span class="quick-text">ë¬¸ì¥ìˆ˜ì§‘</span></div>
                            <div class="quick-item btn-hover" onclick="window.open('https://pf.kakao.com/_Jfjxgn')"><div class="quick-icon ic-4"><i class="fas fa-comments"></i></div><span class="quick-text">ì±„íŒ…</span></div>
                        </div>
                    </div>
                `;
            }
            else if (tab === 'letter') {
                container.innerHTML = `
                    <div style="padding:20px;">
                        <h2 style="color:var(--primary); text-align:center;">Archive</h2>
                        <div class="tab-wrap">
                            <div class="tab-btn active btn-hover" onclick="fetchPosts('all', 'letterList', this)">ì „ì²´</div>
                            <div class="tab-btn btn-hover" onclick="fetchPosts('ìíœ´ë ˆí„°', 'letterList', this)">ìíœ´ë ˆí„°</div>
                            <div class="tab-btn btn-hover" onclick="fetchPosts('ìíœ´ë©', 'letterList', this)">ìíœ´ë©</div>
                        </div>
                        <div id="noticeList"></div>
                        <div id="letterList" class="card-list">ë¡œë”©ì¤‘...</div>
                    </div>
                `;
                fetchPosts('all', 'letterList');
            }
            else if (tab === 'challenge') {
                container.innerHTML = `
                    <div style="padding:20px; text-align:center; background:#F3E5F5; border-radius:0 0 30px 30px;">
                        <h3>ê±´ê°•í•œ ìŠµê´€ì„ ë§Œë“¤ì–´ ë³¼ê¹Œìš”? ğŸƒâ€â™€ï¸</h3>
                        <p style="font-size:13px; color:#888;">ì‘ì€ ìŠµê´€ì´ ëª¨ì—¬ í° ë³€í™”ë¥¼ ë§Œë“¤ì–´ìš”!</p>
                        <div class="tab-wrap">
                            <div class="tab-btn active btn-hover" onclick="fetchChallenges('ongoing', this)">ì§„í–‰ì¤‘</div>
                            <div class="tab-btn btn-hover" onclick="fetchChallenges('upcoming', this)">ì˜ˆì •</div>
                            <div class="tab-btn btn-hover" onclick="fetchChallenges('ended', this)">ì¢…ë£Œ</div>
                        </div>
                    </div>
                    <div id="challengeList" style="padding:20px;">ë¡œë”©ì¤‘...</div>
                `;
                fetchChallenges('ongoing');
            }
            else if (tab === 'mood') {
                container.innerHTML = `
                    <div style="padding:20px; text-align:center;">
                        <h2>My Mood Log</h2>
                        <p style="font-size:13px; color:#aaa; margin-top:5px;">ì˜¤ëŠ˜ í•˜ë£¨, ì†”ì§í•œ ê°ì •ì„ ë‚¨ê²¨ë³´ì„¸ìš”<br>(ì˜¤ì§ ë‚˜ë§Œ ë³¼ ìˆ˜ ìˆì–´ìš” ğŸ”’)</p>
                        <div class="cal-wrap">
                            <div style="font-weight:700; margin-bottom:10px;">${new Date().getMonth()+1}ì›”</div>
                            <div id="calGrid" class="cal-grid" style="margin:0;"></div>
                        </div>
                        <button class="btn-pretty btn-ok btn-hover" style="width:auto; padding:10px 20px; margin-top:15px;" onclick="saveImage('calGrid')">ğŸ¨ ì˜ˆìœ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                    </div>
                    <div style="padding:0 20px;">
                        <h4 style="margin-bottom:10px;">ìµœê·¼ ê¸°ë¡</h4>
                        <div id="moodList"></div>
                    </div>
                `;
                loadCalendar();
                fetchList('mood', 'moodList');
            }
            else if (tab === 'mypage') {
                renderMyPage(container);
            }
        };

        // ë°ì´í„° ë¡œì§
        async function fetchPosts(filter, targetId, btnEl) {
            if(btnEl) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btnEl.classList.add('active'); }
            const target = document.getElementById(targetId);
            const noticeTarget = document.getElementById('noticeList');
            if(noticeTarget) noticeTarget.innerHTML = '';
            target.innerHTML = '';

            const q = query(collection(db, "posts"));
            const snap = await getDocs(q);
            let posts = [];
            snap.forEach(d => posts.push({id: d.id, ...d.data()}));
            posts.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(posts.length === 0) target.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">ê¸€ì´ ì—†ì–´ìš”</div>';

            posts.forEach(p => {
                if(p.type !== 'post') return;
                
                const isMyPost = p.authorId === currentUser.uid || isAdmin;
                const card = `
                    <div class="card btn-hover" onclick="window.alert('ìƒì„¸ë³´ê¸°ëŠ” ëª©ë¡ì—ì„œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”!')">
                        ${isMyPost ? `<div class="more-btn" onclick="deletePost('${p.id}', event)">â‹®</div>` : ''}
                        ${p.image ? `<img src="${p.image}" style="width:100%; border-radius:10px; margin-bottom:10px;">` : ''}
                        <div class="card-badge ${p.isNotice?'notice':''}">${p.isNotice?'ğŸ“¢ ê³µì§€':p.category}</div>
                        <div style="font-weight:700; margin-bottom:5px;">${p.title}</div>
                        <div style="font-size:12px; color:#aaa;">${p.author}</div>
                    </div>
                `;
                if(p.isNotice && noticeTarget) noticeTarget.innerHTML += card;
                else {
                    if(filter === 'all' || p.category === filter) target.innerHTML += card;
                }
            });
        }

        async function fetchChallenges(status, btnEl) {
            if(btnEl) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btnEl.classList.add('active'); }
            const target = document.getElementById('challengeList');
            target.innerHTML = '';
            
            const q = query(collection(db, "posts"), where("type", "==", "challenge"));
            const snap = await getDocs(q);
            let posts = [];
            snap.forEach(d => posts.push({id:d.id, ...d.data()}));
            
            const today = new Date().toISOString().split('T')[0];
            posts = posts.filter(p => {
                if(status === 'ongoing') return p.startDate <= today && p.endDate >= today;
                if(status === 'upcoming') return p.startDate > today;
                if(status === 'ended') return p.endDate < today;
                return true;
            });

            if(posts.length === 0) target.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:20px;">í•´ë‹¹í•˜ëŠ” ì±Œë¦°ì§€ê°€ ì—†ì–´ìš” â˜ï¸</div>';

            posts.forEach(p => {
                const isPart = p.participants && p.participants.includes(currentUser.uid);
                const btn = isPart 
                    ? `<button class="ch-btn" style="background:#E3F2FD; color:#1976D2;" onclick="openCertifyModal('${p.id}', '${p.title}')">ğŸ“· ì¸ì¦í•˜ê¸°</button>`
                    : `<button class="ch-btn btn-hover" onclick="joinChallenge('${p.id}')">ì°¸ì—¬í•˜ê¸°</button>`;

                target.innerHTML += `
                    <div class="ch-card">
                        ${p.image ? `<img src="${p.image}" class="ch-img">` : '<div class="ch-img"></div>'}
                        <div class="ch-content">
                            <span class="ch-tag">${p.startDate} ~ ${p.endDate}</span>
                            <div class="ch-title">${p.title}</div>
                            <div class="ch-meta">ğŸ”¥ í˜„ì¬ ${p.participants ? p.participants.length : 0}ëª…ì´ í•¨ê»˜ ë›°ê³  ìˆì–´ìš”!</div>
                            ${btn}
                        </div>
                    </div>
                `;
            });
        }

        async function fetchList(type, targetId) {
            const target = document.getElementById(targetId);
            const q = query(collection(db, "posts"), where("type", "==", type), where("authorId", "==", currentUser.uid), orderBy("date", "desc"));
            const snap = await getDocs(q);
            target.innerHTML = '';
            snap.forEach(d => {
                const p = d.data();
                target.innerHTML += `<div class="card" style="display:flex; align-items:center;"><div style="font-size:30px; margin-right:15px;">${p.emoji || 'ğŸ“'}</div><div>${p.content}</div></div>`;
            });
        }

        // ë§ˆì´í˜ì´ì§€ ë Œë”ë§
        async function renderMyPage(container) {
            const userSnap = await getDoc(doc(db, "users", currentUser.uid));
            const userData = userSnap.data() || { stamps: 0 };
            
            container.innerHTML = `
                <div class="mypage-header">
                    <h3>${currentUser.displayName}ë‹˜ ${isAdmin?'<span class="admin-badge">ê´€ë¦¬ì</span>':''}</h3>
                    <p style="color:#aaa; font-size:13px;">${currentUser.email}</p>
                </div>
                
                <div class="stamp-board">
                    <h4>ë‚˜ì˜ ìŠ¤íƒ¬í”„ ğŸ¾</h4>
                    <p style="font-size:12px; color:#888; margin-bottom:15px;">30ê°œë¥¼ ëª¨ìœ¼ë©´ ìŠ¤í˜ì…œ ë ˆí„°ê°€ ë„ì°©í•´ìš”!</p>
                    <div id="stampGrid" class="stamp-grid"></div>
                </div>

                <div class="menu-list">
                    <div class="menu-item btn-hover" onclick="showMyData('posts')">ğŸ“ ë‚´ê°€ ì“´ ê¸€ <i class="fas fa-chevron-right"></i></div>
                    <div class="menu-item btn-hover" onclick="showMyData('comments')">ğŸ’¬ ë‚´ê°€ ì“´ ëŒ“ê¸€ <i class="fas fa-chevron-right"></i></div>
                    <div class="menu-item btn-hover" onclick="showMyData('bookmarks')">ğŸ”– ë¶ë§ˆí¬ <i class="fas fa-chevron-right"></i></div>
                    <div class="menu-item btn-hover" onclick="document.getElementById('pwModal').style.display='block'">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ <i class="fas fa-chevron-right"></i></div>
                    ${isAdmin ? `<div class="menu-item btn-hover" onclick="openAdminModal()">ğŸ”§ ê´€ë¦¬ì ê´€ë¦¬ <i class="fas fa-chevron-right"></i></div>` : ''}
                </div>
                
                <div class="logout-btn btn-hover" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</div>
            `;
            
            const grid = document.getElementById('stampGrid');
            if(grid) {
                grid.innerHTML = '';
                for(let i=1; i<=30; i++) {
                    grid.innerHTML += `<div class="stamp ${i<=userData.stamps?'active':''}">${i}</div>`;
                }
            }
        }

        window.showMyData = async (type) => {
            const container = document.getElementById('appContainer');
            container.innerHTML = `
                <div class="header" style="justify-content: flex-start; padding-left: 20px;">
                    <i class="fas fa-arrow-left btn-hover" style="font-size:24px;" onclick="renderTab('mypage')"></i>
                </div>
                <h3 style="padding:0 20px;">ë³´ê´€í•¨</h3>
                <div id="myList" class="card-list" style="margin-top:20px;">ë¡œë”©ì¤‘...</div>
            `;
            const list = document.getElementById('myList');
            let q;
            if(type === 'posts') q = query(collection(db, "posts"), where("authorId", "==", currentUser.uid));
            else if(type === 'comments') q = query(collection(db, "comments"), where("authorId", "==", currentUser.uid));
            else q = query(collection(db, "posts"), where("bookmarks", "array-contains", currentUser.uid));

            const snap = await getDocs(q);
            list.innerHTML = '';
            if(snap.empty) list.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">ì•„ì§ ì—†ì–´ìš”!</div>';
            
            snap.forEach(d => {
                const data = d.data();
                list.innerHTML += `<div class="card">${data.content || data.title}</div>`;
            });
        };

        // ê´€ë¦¬ì ëª¨ë‹¬
        window.openAdminModal = async () => {
            document.getElementById('adminManageModal').style.display = 'flex';
            const list = document.getElementById('adminList');
            list.innerHTML = 'ë¡œë”©ì¤‘...';
            const q = query(collection(db, "admins"));
            const snap = await getDocs(q);
            list.innerHTML = '';
            snap.forEach(d => {
                list.innerHTML += `<div class="admin-item"><span>${d.id}</span><span class="del-btn" onclick="removeAdmin('${d.id}')">ì‚­ì œ</span></div>`;
            });
        };
        window.addNewAdmin = async () => {
            const email = document.getElementById('newAdminEmail').value;
            if(email) {
                await setDoc(doc(db, "admins", email), { addedBy: currentUser.email });
                openAdminModal();
            }
        };
        window.removeAdmin = async (email) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "admins", email));
                openAdminModal();
            }
        };

        // ê¸€ì“°ê¸° ê´€ë ¨
        window.openWriteModal = (forceType) => {
            const modal = document.getElementById('writeModal');
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            
            document.getElementById('letterOptions').classList.add('hidden');
            document.getElementById('challengeOptions').classList.add('hidden');
            document.getElementById('moodOptions').classList.add('hidden');
            document.getElementById('postTitle').classList.remove('hidden');

            if (currentTab === 'letter') {
                document.getElementById('letterOptions').classList.remove('hidden');
            } else if (currentTab === 'challenge') {
                document.getElementById('challengeOptions').classList.remove('hidden');
                document.getElementById('postTitle').placeholder = "ì±Œë¦°ì§€ ì´ë¦„";
            } else if (currentTab === 'mood' || forceType === 'mood') {
                document.getElementById('moodOptions').classList.remove('hidden');
                document.getElementById('postTitle').classList.add('hidden'); 
                document.getElementById('emojiList').innerHTML = MOODS.map(m => `<span style="font-size:30px; margin:5px; cursor:pointer;" onclick="selectEmoji('${m}')">${m}</span>`).join('');
            }
            if(forceType === 'certify') {
                document.getElementById('postTitle').value = "ì±Œë¦°ì§€ ì¸ì¦";
                document.getElementById('postTitle').disabled = true;
            }
            modal.style.display = 'flex';
        };

        let selectedEmoji = null;
        window.selectEmoji = (m) => { selectedEmoji = m; window.showAlert(`${m} ì„ íƒë¨`); };

        window.submitPost = async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const file = document.getElementById('fileInput').files[0];
            
            let imgStr = null;
            if(file) {
                imgStr = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const data = {
                title: title || selectedEmoji,
                content: content,
                image: imgStr,
                date: new Date().toISOString(),
                author: currentUser.displayName,
                authorId: currentUser.uid,
                type: currentTab === 'mood' ? 'mood' : (currentTab === 'challenge' ? 'challenge' : 'post'),
                category: currentTab === 'letter' ? document.getElementById('postCategory').value : 'challenge',
                isNotice: document.getElementById('isNotice')?.checked || false,
                emoji: selectedEmoji,
                duration: document.getElementById('chDuration')?.value,
                startDate: document.getElementById('chStartDate')?.value,
                endDate: document.getElementById('chEndDate')?.value,
                participants: []
            };

            if (currentTab === 'challenge_certify') {
                data.type = 'certification';
                data.challengeId = currentChallengeId;
            }

            await addDoc(collection(db, "posts"), data);
            window.closeModal();
            window.showAlert("ì €ì¥ ì™„ë£Œ!");
            renderTab(currentTab === 'challenge_certify' ? 'challenge' : currentTab);
        };

        window.deletePost = async (id, e) => {
            e.stopPropagation();
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "posts", id));
                renderTab(currentTab);
            }
        };

        window.joinChallenge = async (id) => {
            const ref = doc(db, "posts", id);
            await updateDoc(ref, { participants: arrayUnion(currentUser.uid) });
            window.showAlert("ì‹ ì²­ ì™„ë£Œ! ğŸ”¥");
            renderTab('challenge');
        };

        window.openCertifyModal = (chId, chTitle) => {
            currentTab = 'challenge_certify';
            currentChallengeId = chId;
            openWriteModal('certify');
        };

        async function loadCalendar() {
            const grid = document.getElementById('calGrid');
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            const lastDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const records = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === today.getMonth()) records[date.getDate()] = d.data().emoji;
            });

            for(let i=1; i<=lastDate; i++) {
                grid.innerHTML += `
                    <div class="day-cell ${i===today.getDate()?'today':''}">
                        <span style="position:absolute; top:3px; left:5px;">${i}</span>
                        <span class="day-emoji">${records[i] || ''}</span>
                    </div>
                `;
            }
        }

        window.saveImage = (id) => {
            const target = document.getElementById(id);
            html2canvas(target).then(canvas => {
                const link = document.createElement('a');
                link.download = 'jahyu_mood.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        window.closeModal = () => document.getElementById('writeModal').style.display = 'none';

        // ì•± ì‹œì‘
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAdmin = await checkIsAdmin(user.email);
                document.getElementById('authModal').style.display = 'none';
                renderTab('home');
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>