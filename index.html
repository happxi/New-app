<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jahyu Letter</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #9D76C1;
            --primary-light: #F3E5F5;
            --bg-body: #F9F9F9;
            --white: #ffffff;
            --text-main: #333;
            --text-sub: #888;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --pink-popup: #FFF0F5;
            --pink-input: #FFEFF2;
            --accent-pink: #FFB7B2;
        }

        * { 
            box-sizing: border-box; margin: 0; padding: 0; 
            font-family: 'Pretendard', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            user-select: none; 
        }
        
        body { 
            background: var(--bg-body); color: var(--text-main); 
            min-height: 100vh; display: flex; flex-direction: column; 
            align-items: center; overflow-x: hidden; 
        }
        
        .app-container { 
            width: 100%; max-width: 480px; min-height: calc(100vh - 75px); 
            background: var(--bg-body); padding-bottom: 100px; 
            padding-top: 80px; position: relative; 
        }

        .clickable { cursor: pointer; transition: transform 0.1s, opacity 0.1s; }
        .clickable:active { transform: scale(0.96); opacity: 0.8; }

        .header { 
            position: fixed; top: 0; width: 100%; max-width: 480px; height: 70px; 
            background: rgba(249, 249, 249, 0.95); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; 
            z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .logo { font-family: 'Dancing Script', cursive; font-size: 32px; color: var(--primary); font-weight: 700; }

        /* í™ˆ ìŠ¤íƒ€ì¼ */
        .hero-card { 
            margin: 0 20px 30px; padding: 30px; 
            background: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            border-radius: 20px; color: var(--white); text-align: center; 
            box-shadow: var(--shadow); 
        }
        .quick-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px 10px; padding: 0 20px; margin-bottom: 30px; }
        .quick-item { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .quick-icon { 
            width: 50px; height: 50px; border-radius: 18px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px; color: var(--white); box-shadow: var(--shadow); 
        }
        /* í€µë©”ë‰´ ìƒ‰ìƒ */
        .ic-1 { background: #FF9A9E; } .ic-2 { background: #FECFEF; } 
        .ic-3 { background: #A18CD1; } .ic-4 { background: #84FAB0; }
        .ic-5 { background: #FFD1FF; } .ic-6 { background: #FBC2EB; }
        .quick-text { font-size: 11px; font-weight: 600; color: var(--text-sub); }

        /* ê³µí†µ íƒ­/ì¹´ë“œ */
        .tab-bar { display: flex; gap: 8px; padding: 0 20px; margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .tab-btn { 
            flex: 0 0 auto; padding: 10px 18px; border-radius: 20px; 
            background: var(--white); border: 1px solid #eee; 
            color: #888; font-weight: 600; font-size: 13px; text-align: center;
        }
        .tab-btn.active { background: var(--primary); color: var(--white); border-color: var(--primary); box-shadow: 0 4px 10px rgba(157, 118, 193, 0.3); }

        .card-list { padding: 0 20px; display: flex; flex-direction: column; gap: 15px; }
        .card { 
            background: var(--white); border-radius: 20px; padding: 20px; 
            box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .card-title { font-size: 16px; font-weight: 800; margin-bottom: 8px; color: #333; }
        .card-content { font-size: 14px; color: #666; line-height: 1.5; }
        .card-meta { font-size: 11px; color: #aaa; display: flex; justify-content: space-between; margin-top: 15px; align-items: center; }
        
        /* ì±Œë¦°ì§€ ì¹´ë“œ */
        .ch-card { background: var(--white); border-radius: 20px; overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow); }
        .ch-img-area { width: 100%; height: 180px; background: #eee; position: relative; }
        .ch-img { width: 100%; height: 100%; object-fit: cover; }
        .ch-badge { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 11px; }
        .ch-content { padding: 20px; }
        .ch-date { font-size: 12px; color: var(--primary); font-weight: 700; margin-bottom: 5px; }
        .ch-btn { width: 100%; padding: 14px; border-radius: 15px; border: none; background: linear-gradient(135deg, #FFB7B2, #FF9A9E); color: var(--white); font-weight: 700; margin-top: 15px; font-size: 14px; }
        .ch-stamp-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .ch-stamp { aspect-ratio: 1/1; background: #f5f5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #ddd; }
        .ch-stamp.checked { background: var(--primary); color: #fff; }

        /* ìº˜ë¦°ë” */
        .cal-wrapper-bg { background: var(--primary-light); border-radius: 25px; padding: 25px; margin: 0 20px 20px; box-shadow: var(--shadow); position: relative; }
        .cal-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 800; font-size: 18px; color: #555; padding: 0 5px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .week-head { font-size: 12px; color: #888; margin-bottom: 10px; font-weight: 600; }
        .day-cell { 
            aspect-ratio: 1/1; border-radius: 12px; background: rgba(255,255,255,0.7); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 11px; color: #777; position: relative; 
        }
        .day-cell.filled { background: var(--white); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .day-emoji { font-size: 22px; margin-top: -2px; line-height: 1; }
        
        /* ë§ˆì´í˜ì´ì§€ */
        .mypage-header { text-align: center; padding: 30px 20px; }
        .profile-circle { width: 80px; height: 80px; background: #E0C3FC; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; }
        .menu-list { background: var(--white); border-radius: 20px; margin: 0 20px 20px; overflow: hidden; box-shadow: var(--shadow); }
        .menu-item { padding: 18px 20px; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; font-size: 15px; font-weight: 500; color: #444; }
        .menu-item:last-child { border-bottom: none; }
        
        .stamp-board { background: var(--white); margin: 0 20px 25px; padding: 30px 20px; border-radius: 25px; box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
        .stamp-board::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, #FF9A9E, #FECFEF); }
        .stamp-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 25px; }
        .stamp { aspect-ratio: 1/1; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #bbb; font-weight: 700; transition: 0.3s; }
        .stamp.active { background: linear-gradient(135deg, #A18CD1, #FBC2EB); color: var(--white); transform: scale(1.1); box-shadow: 0 3px 6px rgba(161, 140, 209, 0.4); }

        /* í•˜ë‹¨ë°” & FAB */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 75px; background: var(--white); border-top: 1px solid #f5f5f5; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: 5px; }
        .nav-item { color: #ddd; width: 20%; text-align: center; font-size: 10px; font-weight: 500; }
        .nav-item i { font-size: 22px; margin-bottom: 6px; display: block; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }
        
        .fab { position: fixed; bottom: 95px; right: 25px; width: 56px; height: 56px; background: #333; border-radius: 50%; color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 8px 25px rgba(0,0,0,0.25); z-index: 900; transform: scale(0); transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .fab.show { transform: scale(1); }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .pink-box { background: var(--white); width: 88%; max-width: 380px; padding: 35px 25px; border-radius: 30px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.15); border: 3px solid var(--pink-popup); position: relative; animation: popUp 0.3s ease-out; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .pink-input { width: 100%; padding: 16px; background: var(--pink-input); border: 1px solid #FFE0E6; border-radius: 16px; margin-bottom: 12px; font-size: 15px; outline: none; transition: 0.2s; }
        .pink-input:focus { border-color: var(--accent-pink); background: #fff; }
        .btn-pretty { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700; margin-top: 10px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-ok { background: linear-gradient(135deg, #FFB7B2, #FF9A9E); color: var(--white); box-shadow: 0 5px 15px rgba(255, 154, 158, 0.3); }
        .btn-no { background: #f7f7f7; color: #999; }
        
        /* ì´ëª¨ì§€ ê·¸ë¦¬ë“œ */
        #emojiList { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .emoji-item { font-size: 28px; padding: 8px; border-radius: 15px; cursor: pointer; transition: 0.2s; }
        .emoji-item.selected { background: var(--primary-light); transform: scale(1.1); box-shadow: 0 0 0 2px var(--primary); }

        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 60px 20px; color: #bbb; font-size: 14px; line-height: 1.6; }
        
        /* ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í…Œì´ë¸” */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; text-align: left; }
        .admin-table th { padding: 8px; background: #f5f5f5; color: #555; }
        .admin-table td { padding: 8px; border-bottom: 1px solid #eee; color: #666; }
        .badge-admin { background: #333; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 10px; }
    </style>
</head>
<body>

    <!-- ğŸŒ¸ ì•Œë¦¼ íŒì—… -->
    <div id="customAlert" class="modal-overlay" style="z-index: 3000;">
        <div class="pink-box">
            <div style="font-size:40px; margin-bottom:15px; animation: bounce 1s infinite;">ğŸŒ¸</div>
            <div id="alertMsg" style="margin-bottom:25px; font-weight:600; color:#555; word-break: keep-all; line-height:1.5;">ì•Œë¦¼ ë©”ì‹œì§€</div>
            <button onclick="window.closeAlert()" class="btn-pretty btn-ok clickable">í™•ì¸</button>
        </div>
    </div>

    <!-- ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ íŒì—… -->
    <div id="pwResetModal" class="modal-overlay">
        <div class="pink-box">
            <h3 style="margin-bottom:20px; color:var(--primary);">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ğŸ”’</h3>
            <p style="font-size:13px; color:#999; margin-bottom:20px;">ê°€ì…í•˜ì‹  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
            <input type="email" id="resetEmailInput" class="pink-input" placeholder="example@email.com">
            <button onclick="window.sendResetEmail()" class="btn-pretty btn-ok clickable">ì „ì†¡í•˜ê¸°</button>
            <button onclick="document.getElementById('pwResetModal').style.display='none'" class="btn-pretty btn-no clickable">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo">Jahyu Letter</div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div id="appContainer" class="app-container"></div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bottom-nav">
        <div class="nav-item clickable" onclick="window.renderTab('home')"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item clickable" onclick="window.renderTab('letter')"><i class="fas fa-envelope-open-text"></i>ë ˆí„°</div>
        <div class="nav-item clickable" onclick="window.renderTab('mood')"><i class="fas fa-calendar-check"></i>ë¬´ë“œ</div>
        <div class="nav-item clickable" onclick="window.renderTab('challenge')"><i class="fas fa-crown"></i>ì±Œë¦°ì§€</div>
        <div class="nav-item clickable" onclick="window.renderTab('mypage')"><i class="fas fa-user"></i>ë§ˆì´</div>
    </nav>

    <!-- ê¸€ì“°ê¸° ë²„íŠ¼ -->
    <div id="fab" class="fab clickable" onclick="window.openWriteModal()"><i class="fas fa-pen"></i></div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="pink-box">
            <div style="font-family:'Dancing Script'; font-size:45px; color:var(--primary); margin-bottom:10px;">Jahyu</div>
            <p style="color:#aaa; margin-bottom:30px; font-size:14px;">ë‹¹ì‹ ì„ ìœ„í•œ ì‰¼í‘œ, ìíœ´ë ˆí„° ğŸŒ¿</p>
            <input type="email" id="authEmail" class="pink-input" placeholder="ì´ë©”ì¼">
            <input type="password" id="authPw" class="pink-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <div id="signupFields" class="hidden">
                <input type="text" id="authNick" class="pink-input" placeholder="ë‹‰ë„¤ì„ (í™œë™ëª…)">
            </div>
            <button id="loginBtn" onclick="window.doLogin()" class="btn-pretty btn-ok clickable">ë¡œê·¸ì¸</button>
            <button id="signupBtn" onclick="window.toggleSignup()" class="btn-pretty btn-no clickable">3ì´ˆë§Œì— íšŒì›ê°€ì…</button>
            <p onclick="document.getElementById('pwResetModal').style.display='flex'" style="font-size:12px; color:#bbb; margin-top:20px; cursor:pointer; text-decoration:underline;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</p>
        </div>
    </div>

    <!-- âœï¸ ê¸€ì“°ê¸°/ì¶”ê°€ ëª¨ë‹¬ (í†µí•©) -->
    <div id="writeModal" class="modal-overlay">
        <div class="pink-box" style="text-align:left; max-width:400px; max-height:80vh; overflow-y:auto;">
            <h3 id="modalTitle" style="text-align:center; color:var(--primary); margin-bottom:20px;">ê¸°ë¡í•˜ê¸°</h3>
            
            <!-- ë¬´ë“œ ì…ë ¥ í¼ -->
            <div id="moodForm" class="hidden">
                <h4 style="text-align:center; margin-bottom:15px; color:#888;">ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?</h4>
                <div id="emojiList"></div>
                <textarea id="moodContent" class="pink-input" style="height:80px; resize:none; margin-top:10px;" placeholder="ì§§ì€ ê°ì • ê¸°ë¡..."></textarea>
            </div>

            <!-- ë ˆí„°(ê´€ë¦¬ì) ì…ë ¥ í¼ -->
            <div id="letterForm" class="hidden">
                <select id="letterCategory" class="pink-input">
                    <option value="letter">ğŸ’Œ ìíœ´ë ˆí„°</option>
                    <option value="lab">ğŸ§ª ìíœ´ë©</option>
                    <option value="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</option>
                </select>
                <input type="text" id="letterTitle" class="pink-input" placeholder="ë ˆí„° ì œëª©">
                <textarea id="letterContent" class="pink-input" style="height:120px; resize:none;" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
                <input type="text" id="letterUrl" class="pink-input" placeholder="ì—°ê²°í•  URL (ì„ íƒì‚¬í•­)">
                <input type="text" id="letterBtnText" class="pink-input" placeholder="ë²„íŠ¼ ì´ë¦„ (ì˜ˆ: ë³´ëŸ¬ê°€ê¸°)">
            </div>

            <!-- ì±Œë¦°ì§€(ê´€ë¦¬ì) ì…ë ¥ í¼ -->
            <div id="challengeForm" class="hidden">
                <input type="text" id="chTitle" class="pink-input" placeholder="ì±Œë¦°ì§€ ì œëª©">
                <textarea id="chContent" class="pink-input" style="height:80px;" placeholder="ì±Œë¦°ì§€ ì„¤ëª…"></textarea>
                <div style="font-size:12px; color:#888; margin-bottom:5px;">ì˜¤í”ˆ ì˜ˆì •ì¼</div>
                <input type="date" id="chOpenDate" class="pink-input">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <span style="font-size:12px; color:#888;">ì‹œì‘ì¼</span>
                        <input type="date" id="chStartDate" class="pink-input">
                    </div>
                    <div style="flex:1;">
                        <span style="font-size:12px; color:#888;">ì¢…ë£Œì¼</span>
                        <input type="date" id="chEndDate" class="pink-input">
                    </div>
                </div>
                <input type="text" id="chImgUrl" class="pink-input" placeholder="ì´ë¯¸ì§€ URL (ì§ì ‘ ì…ë ¥)">
            </div>

            <button onclick="window.submitPost()" class="btn-pretty btn-ok clickable">ë“±ë¡í•˜ê¸°</button>
            <button onclick="window.closeModal()" class="btn-pretty btn-no clickable">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ğŸ”´ğŸ”´ ì œê³µí•´ì£¼ì‹  íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •ê°’ (ìˆ˜ì • ì™„ë£Œ) ğŸ”´ğŸ”´ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ì „ì—­ ë³€ìˆ˜ ë° ê´€ë¦¬ì ì„¤ì • ---
        let currentUser = null;
        let currentTab = 'home';
        let isAdmin = false;
        let isSuperAdmin = false;
        let selectedEmoji = null;

        // 20ê°œì˜ íŠ¸ë Œë””í•œ ì´ëª¨ì§€ ë¦¬ìŠ¤íŠ¸
        const MOOD_EMOJIS = ['ğŸ˜Š','ğŸ¥°','ğŸ˜Œ','ğŸ˜­','ğŸ˜¡','ğŸ˜´','ğŸ¤©','ğŸ¥º','ğŸ”¥','â˜”','ğŸ€','â˜ï¸','â˜•','ğŸ§','ğŸ ','ğŸ’¸','ğŸ’ª','ğŸ‘»','ğŸ·','ğŸ§¶'];
        
        // ê´€ë¦¬ì ì´ë©”ì¼ ëª©ë¡
        const ADMIN_EMAILS = [
            'happci@test.com', // ìŠˆí¼ ê´€ë¦¬ì
            'admin1@test.com', 'admin2@test.com', 'admin3@test.com', 'admin4@test.com'
        ];
        const SUPER_ADMIN = 'happci@test.com';

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        window.showAlert = (msg) => {
            document.getElementById('alertMsg').innerHTML = msg;
            document.getElementById('customAlert').style.display = 'flex';
        };
        window.closeAlert = () => document.getElementById('customAlert').style.display = 'none';

        // íƒ­ ë Œë”ë§ ì‹œìŠ¤í…œ
        window.renderTab = (tab) => {
            currentTab = tab;
            const container = document.getElementById('appContainer');
            const fab = document.getElementById('fab');
            container.innerHTML = '';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[onclick*="${tab}"]`);
            if (activeNav) activeNav.classList.add('active');

            fab.classList.remove('show');

            if (tab === 'home') renderHome(container);
            else if (tab === 'letter') renderLetter(container);
            else if (tab === 'mood') renderMood(container);
            else if (tab === 'challenge') renderChallenge(container);
            else if (tab === 'mypage') renderMyPage(container);
        };

        // ğŸ  í™ˆ í™”ë©´
        function renderHome(container) {
            container.innerHTML = `
                <div class="hero-card clickable" onclick="window.open('https://index-html-zak5.vercel.app/', '_blank')">
                    <h3 style="margin-bottom:5px;">ë‚˜ì˜ ì‰¼ ìœ í˜• í…ŒìŠ¤íŠ¸ ğŸŒ¿</h3>
                    <p style="font-size:13px; opacity:0.9;">ë‚˜ëŠ” ì–´ë–¤ ì‰¼ì´ í•„ìš”í• ê¹Œ? Click! ğŸ‘‰</p>
                </div>
                <div class="quick-menu">
                    <div class="quick-item clickable" onclick="window.open('https://maily.so/happci', '_blank')"><div class="quick-icon ic-1"><i class="fas fa-envelope-open-text"></i></div><span class="quick-text">ë ˆí„°êµ¬ë…</span></div>
                    <div class="quick-item clickable" onclick="window.renderTab('challenge')"><div class="quick-icon ic-2"><i class="fas fa-crown"></i></div><span class="quick-text">ì±Œë¦°ì§€</span></div>
                    <div class="quick-item clickable" onclick="window.renderTab('mood')"><div class="quick-icon ic-3"><i class="fas fa-calendar-check"></i></div><span class="quick-text">ë¬´ë“œê¸°ë¡</span></div>
                    <div class="quick-item clickable" onclick="window.open('http://pf.kakao.com/_Jfjxgn/111753149', '_blank')"><div class="quick-icon ic-4"><i class="fas fa-quote-right"></i></div><span class="quick-text">ë¬¸ì¥ìˆ˜ì§‘</span></div>
                    <div class="quick-item clickable" onclick="window.open('http://pf.kakao.com/_Jfjxgn', '_blank')"><div class="quick-icon ic-5"><i class="fas fa-comments"></i></div><span class="quick-text">1:1 ì±„íŒ…</span></div>
                    <div class="quick-item clickable" onclick="window.renderTab('mypage')"><div class="quick-icon ic-6"><i class="fas fa-user-circle"></i></div><span class="quick-text">ë§ˆì´í˜ì´ì§€</span></div>
                </div>
            `;
        }

        // ğŸ’Œ ë ˆí„° í™”ë©´
        function renderLetter(container) {
            if(isAdmin) document.getElementById('fab').classList.add('show');
            
            container.innerHTML = `
                <div class="tab-bar">
                    <button class="tab-btn active clickable" onclick="window.filterLetters('all', this)">ì „ì²´</button>
                    <button class="tab-btn clickable" onclick="window.filterLetters('letter', this)">ìíœ´ë ˆí„°</button>
                    <button class="tab-btn clickable" onclick="window.filterLetters('lab', this)">ìíœ´ë©</button>
                    <button class="tab-btn clickable" onclick="window.filterLetters('notice', this)">ê³µì§€</button>
                </div>
                <div id="letterList" class="card-list" style="padding-bottom:20px;">
                    <div class="empty-state">ë¡œë”©ì¤‘... ğŸ“¨</div>
                </div>
            `;
            window.fetchLetters('all');
        }

        window.fetchLetters = async (category) => {
            const list = document.getElementById('letterList');
            let q = query(collection(db, "posts"), where("type", "in", ["letter", "lab", "notice"]), orderBy("date", "desc"));
            
            if(category !== 'all') {
                q = query(collection(db, "posts"), where("type", "==", category), orderBy("date", "desc"));
            }

            const snap = await getDocs(q);
            list.innerHTML = '';
            
            if (snap.empty) {
                list.innerHTML = `<div class="empty-state">ë“±ë¡ëœ ê¸€ì´ ì—†ì–´ìš”.</div>`;
                return;
            }

            snap.forEach(d => {
                const p = d.data();
                const date = new Date(p.date).toLocaleDateString();
                const tagMap = { 'letter': 'ğŸ’Œ ë ˆí„°', 'lab': 'ğŸ§ª ë©', 'notice': 'ğŸ“¢ ê³µì§€' };
                
                let btnHtml = '';
                if(p.url) btnHtml = `<button onclick="window.open('${p.url}', '_blank')" class="ch-btn" style="margin-top:10px; padding:10px;">${p.btnText || 'ë³´ëŸ¬ê°€ê¸°'}</button>`;

                list.innerHTML += `
                    <div class="card">
                        <span style="font-size:11px; color:var(--primary); font-weight:700;">${tagMap[p.type] || 'ê¸€'}</span>
                        <div class="card-title" style="margin-top:5px;">${p.title}</div>
                        <div class="card-content" style="white-space:pre-wrap;">${p.content}</div>
                        ${btnHtml}
                        <div class="card-meta"><span>ê´€ë¦¬ì</span><span>${date}</span></div>
                    </div>
                `;
            });
        };
        window.filterLetters = (cat, btn) => {
            document.querySelectorAll('.tab-bar .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.fetchLetters(cat);
        }

        // ğŸ“… ë¬´ë“œ í™”ë©´
        function renderMood(container) {
            document.getElementById('fab').classList.add('show');
            
            container.innerHTML = `
                <div style="padding:0 20px;">
                    <div class="card" style="margin-bottom:20px; text-align:center; background:#FFF0F5; border:none;">
                        <div style="font-size:14px; color:#555; line-height:1.4;">
                            ì˜¤ëŠ˜ì€ ì–´ë–¤ í•˜ë£¨ì˜€ë‚˜ìš”?<br>
                            <span style="font-weight:700; color:var(--primary);">ë‚˜ì˜ ê°ì •ì„ ê¸°ë¡í•´ ë³´ì„¸ìš”! âœï¸</span>
                        </div>
                    </div>

                    <div id="captureArea" class="cal-wrapper-bg">
                        <div class="cal-header">
                            <span>My Mood Log</span>
                            <span>${new Date().getMonth()+1}ì›”</span>
                        </div>
                        <div class="cal-grid" style="margin-bottom:5px;">
                            <div class="week-head">ì¼</div><div class="week-head">ì›”</div><div class="week-head">í™”</div><div class="week-head">ìˆ˜</div><div class="week-head">ëª©</div><div class="week-head">ê¸ˆ</div><div class="week-head">í† </div>
                        </div>
                        <div id="calGrid" class="cal-grid"></div>
                    </div>
                    
                    <button onclick="window.saveCalendarImage()" class="btn-pretty btn-ok clickable" style="margin-bottom:30px;">
                        <i class="fas fa-download"></i> ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°
                    </button>
                    
                    <h4 style="margin-bottom:15px; padding-left:5px;">ë‚˜ì˜ ë¬´ë“œ íˆìŠ¤í† ë¦¬</h4>
                    <div id="moodList" class="card-list" style="padding:0;"></div>
                    
                     <button onclick="window.toggleMoodHistory()" class="btn-pretty btn-no clickable" style="margin-top:10px;">
                        ì´ì „ ë‚´ì—­ ë”ë³´ê¸°
                    </button>
                </div>
            `;
            window.loadCalendar();
            window.fetchMoods(5);
        }

        // ìº˜ë¦°ë” ì´ë¯¸ì§€ ì €ì¥
        window.saveCalendarImage = () => {
            const element = document.getElementById("captureArea");
            html2canvas(element, { scale: 2, backgroundColor: "#F3E5F5", borderRadius:25 }).then(canvas => {
                const link = document.createElement("a");
                link.download = `my_mood_log_${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        window.loadCalendar = async () => {
            const grid = document.getElementById('calGrid');
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const records = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === month && date.getFullYear() === year) {
                    records[date.getDate()] = d.data().emoji;
                }
            });

            for(let i=1; i<=lastDate; i++) {
                const hasMood = records[i];
                grid.innerHTML += `
                    <div class="day-cell ${hasMood ? 'filled' : ''}">
                        <span style="position:absolute; top:4px; left:6px; font-size:9px;">${i}</span>
                        <span class="day-emoji">${hasMood || ''}</span>
                    </div>
                `;
            }
        };

        window.fetchMoods = async (limitNum = 1000) => {
            const list = document.getElementById('moodList');
            const q = query(
                collection(db, "posts"), 
                where("type", "==", "mood"), 
                where("authorId", "==", currentUser.uid),
                orderBy("date", "desc")
            );
            
            const snap = await getDocs(q);
            list.innerHTML = '';

            if(snap.empty) {
                list.innerHTML = '<div class="empty-state">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.</div>'; return;
            }

            let count = 0;
            snap.forEach(d => {
                if(limitNum && count >= limitNum) return;
                const p = d.data();
                const date = new Date(p.date).toLocaleDateString();
                list.innerHTML += `
                    <div class="card clickable" style="display:flex; align-items:center; padding:15px; margin-bottom:10px;">
                        <div style="font-size:28px; margin-right:15px;">${p.emoji}</div>
                        <div style="flex:1;">
                            <div style="font-size:12px; color:#aaa;">${date}</div>
                            <div style="font-size:14px; margin-top:3px;">${p.content}</div>
                        </div>
                    </div>`;
                count++;
            });
        };
        
        window.toggleMoodHistory = () => {
            window.fetchMoods(null);
        }

        // ğŸ† ì±Œë¦°ì§€ í™”ë©´
        function renderChallenge(container) {
            if(isAdmin) document.getElementById('fab').classList.add('show');

            container.innerHTML = `
                <div class="card" style="margin:0 20px 20px; background:#f9f9f9; border:none; box-shadow:none; padding:15px;">
                    <p style="font-size:13px; text-align:center; color:#777;">
                        ì›í•˜ëŠ” ì±Œë¦°ì§€ê°€ ìˆë‚˜ìš”? ğŸ™‹â€â™€ï¸<br>
                        <a href="http://pf.kakao.com/_Jfjxgn" target="_blank" style="color:var(--primary); font-weight:700;">ì¹´í†¡ ì±„ë„ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”!</a>
                    </p>
                </div>
                <div id="challengeList" style="padding:0 20px;"></div>
            `;
            window.loadChallenges();
        }

        window.loadChallenges = async () => {
            const list = document.getElementById('challengeList');
            const today = new Date().toISOString().split('T')[0];
            
            let q = query(collection(db, "challenges"), orderBy("startDate", "desc"));
            const snap = await getDocs(q);
            
            list.innerHTML = '';
            if(snap.empty) {
                list.innerHTML = `<div class="empty-state">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš”.<br>ê³§ ìƒˆë¡œìš´ ì±Œë¦°ì§€ë¡œ ì°¾ì•„ì˜¬ê²Œìš”!</div>`;
                return;
            }

            snap.forEach(d => {
                const c = d.data();
                if(!isAdmin && c.openDate > today) return;

                const isOngoing = (today >= c.startDate && today <= c.endDate);
                const statusBadge = isOngoing ? '<span class="ch-badge" style="background:var(--primary);">ì§„í–‰ì¤‘ ğŸ”¥</span>' : (today < c.startDate ? '<span class="ch-badge">ì˜ˆì • â³</span>' : '<span class="ch-badge" style="background:#aaa;">ì¢…ë£Œ</span>');

                list.innerHTML += `
                    <div class="ch-card">
                        <div class="ch-img-area">
                            <img src="${c.imgUrl || 'https://via.placeholder.com/400x200?text=Challenge'}" class="ch-img" alt="challenge">
                            ${statusBadge}
                        </div>
                        <div class="ch-content">
                            <div class="ch-date">${c.startDate} ~ ${c.endDate}</div>
                            <div class="ch-title" style="font-size:18px; font-weight:700; margin-bottom:5px;">${c.title}</div>
                            <p style="font-size:13px; color:#666; margin-bottom:15px;">${c.content}</p>
                            
                            <div style="font-size:12px; font-weight:700; color:#555;">ë‚˜ì˜ ì¸ì¦ í˜„í™©</div>
                            <div class="ch-stamp-grid">
                                ${Array(7).fill(0).map((_, i) => `<div class="ch-stamp ${i< (c.myCount||0) ? 'checked' : ''}"><i class="fas fa-check"></i></div>`).join('')}
                            </div>

                            ${isOngoing ? `<button onclick="window.certifyChallenge('${d.id}')" class="ch-btn clickable">ğŸ“¸ ì˜¤ëŠ˜ ì¸ì¦í•˜ê¸°</button>` : ''}
                        </div>
                    </div>
                `;
            });
        };

        window.certifyChallenge = (chId) => {
            window.showAlert(`
                <span style="color:var(--primary); font-size:18px;">ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</span><br><br>
                ì˜¤ëŠ˜ì˜ ì±Œë¦°ì§€ ì¸ì¦ ì™„ë£Œ!<br>
                ê¾¸ì¤€í•¨ì´ ë¹›ë‚˜ëŠ” ë‹¹ì‹ , ë©‹ì ¸ìš” âœ¨
            `);
        };

        // ğŸ‘¤ ë§ˆì´í˜ì´ì§€
        function renderMyPage(container) {
            container.innerHTML = `
                <div class="mypage-header">
                    <div class="profile-circle"><i class="fas fa-user"></i></div>
                    <h3 style="margin-bottom:5px;">${currentUser.displayName}ë‹˜</h3>
                    <p style="font-size:13px; color:#aaa;">${currentUser.email}</p>
                    ${isAdmin ? `<span class="badge-admin">Admin ê³„ì •</span>` : ''}
                </div>
                
                <div class="stamp-board">
                    <h4 style="margin-bottom:5px;">ë‚˜ì˜ ìŠ¤íƒ¬í”„ ğŸ¾</h4>
                    <p style="font-size:12px; color:#666; line-height:1.4;">
                        30ê°œ ìŠ¤íƒ¬í”„ë¥¼ ì™„ì„±í•˜ê³  ì¹´í†¡ìœ¼ë¡œ ì¸ì¦í•˜ë©´?<br>
                        <b style="color:var(--primary);">í™í•œ ë‹¤ê¾¸ ìŠ¤í‹°ì»¤íŒ© & ì‘ì› ì§¤</b>ì„ ë“œë ¤ìš” ğŸ
                    </p>
                    <div id="stampGrid" class="stamp-grid"></div>
                </div>

                <div class="menu-list">
                    <div class="menu-item clickable" onclick="window.showMyPosts()">ğŸ“ ë‚´ê°€ ì“´ ê¸€ <i class="fas fa-chevron-right"></i></div>
                    <div class="menu-item clickable">ğŸ’¬ ë‚´ê°€ ì“´ ëŒ“ê¸€ <i class="fas fa-chevron-right"></i></div>
                    <div class="menu-item clickable">ğŸ”– ë¶ë§ˆí¬ <i class="fas fa-chevron-right"></i></div>
                    ${isAdmin ? `<div class="menu-item clickable" onclick="window.renderAdminDashboard()" style="color:var(--primary); font-weight:700;">âš™ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ <i class="fas fa-chevron-right"></i></div>` : ''}
                    <div class="menu-item clickable" onclick="document.getElementById('pwResetModal').style.display='flex'">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ <i class="fas fa-chevron-right"></i></div>
                    <div class="menu-item clickable" onclick="window.handleLogout()" style="color:#FF6B6B;">ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ</div>
                </div>
            `;
            window.loadStamps();
        }

        window.showMyPosts = () => {
            window.renderTab('mood'); 
            setTimeout(() => window.showAlert("ìµœê·¼ ì‘ì„±í•œ ë¬´ë“œ/ë ˆí„° ê¸°ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤."), 100);
        };

        window.loadStamps = async () => {
            const userSnap = await getDoc(doc(db, "users", currentUser.uid));
            const count = userSnap.data()?.stamps || 0;
            const grid = document.getElementById('stampGrid');
            grid.innerHTML = '';
            for(let i=1; i<=30; i++) {
                grid.innerHTML += `<div class="stamp ${i<=count?'active':''}">${i}</div>`;
            }
        };

        // âš™ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
        window.renderAdminDashboard = async () => {
            if(!isAdmin) return;
            const container = document.getElementById('appContainer');
            
            let adminHtml = '';
            if(isSuperAdmin) {
                adminHtml = `
                    <div class="card" style="margin-bottom:20px;">
                        <h4 style="margin-bottom:10px;">ğŸ‘‘ ìŠˆí¼ ê´€ë¦¬ì ê¸°ëŠ¥</h4>
                        <input type="email" id="newAdminEmail" class="pink-input" placeholder="ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬/ì‚­ì œí•  ì´ë©”ì¼">
                        <div style="display:flex; gap:10px;">
                            <button onclick="window.manageAdmin('add')" class="btn-pretty btn-ok" style="flex:1;">ê´€ë¦¬ì ë“±ë¡</button>
                            <button onclick="window.manageAdmin('remove')" class="btn-pretty btn-no" style="flex:1;">ê¶Œí•œ í•´ì œ</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="padding:20px;">
                    <h2 style="margin-bottom:20px;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                    ${adminHtml}
                    
                    <div class="card">
                        <h4>ğŸ“Š íšŒì› í˜„í™©</h4>
                        <div id="userStats" style="margin-top:10px; font-size:13px;">ë¡œë”©ì¤‘...</div>
                        <table class="admin-table">
                            <thead><tr><th>ë‹‰ë„¤ì„</th><th>ì´ë©”ì¼</th><th>ìŠ¤íƒ¬í”„</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="userTableBody"></tbody>
                        </table>
                    </div>
                </div>
            `;
            
            const snap = await getDocs(collection(db, "users"));
            const tbody = document.getElementById('userTableBody');
            let totalUsers = 0;
            
            snap.forEach(d => {
                totalUsers++;
                const u = d.data();
                tbody.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.stamps}</td>
                        <td><span onclick="window.deleteUserFunc('${d.id}')" style="color:red; cursor:pointer;">ì‚­ì œ</span></td>
                    </tr>
                `;
            });
            document.getElementById('userStats').innerText = `ì´ íšŒì›ìˆ˜: ${totalUsers}ëª…`;
        };

        window.manageAdmin = (action) => {
            const targetEmail = document.getElementById('newAdminEmail').value;
            if(!targetEmail) return window.showAlert("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
            window.showAlert(`${targetEmail} ê³„ì •ì„ ${action === 'add' ? 'ê´€ë¦¬ìë¡œ ë“±ë¡' : 'ê´€ë¦¬ì í•´ì œ'} ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.<br>(DB ì—°ë™ í•„ìš”)`);
        };
        
        window.deleteUserFunc = (uid) => {
            if(confirm("ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                deleteDoc(doc(db, "users", uid)).then(() => {
                    window.showAlert("ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.renderAdminDashboard();
                });
            }
        };

        // --- ê³µí†µ ê¸°ëŠ¥ ---
        window.openWriteModal = () => {
            const modal = document.getElementById('writeModal');
            const title = document.getElementById('modalTitle');
            
            document.getElementById('moodForm').classList.add('hidden');
            document.getElementById('letterForm').classList.add('hidden');
            document.getElementById('challengeForm').classList.add('hidden');
            
            modal.style.display = 'flex';
            document.getElementById('fab').classList.remove('show');

            if(currentTab === 'mood') {
                title.innerText = "ì˜¤ëŠ˜ì˜ ë¬´ë“œ ê¸°ë¡ ğŸ¨";
                document.getElementById('moodForm').classList.remove('hidden');
                
                const emojiListEl = document.getElementById('emojiList');
                emojiListEl.innerHTML = MOOD_EMOJIS.map(m => 
                    `<div class="emoji-item" onclick="window.selectEmoji('${m}', this)">${m}</div>`
                ).join('');
                
            } else if(currentTab === 'letter' && isAdmin) {
                title.innerText = "ìƒˆë¡œìš´ ê¸€ ì‘ì„± âœï¸";
                document.getElementById('letterForm').classList.remove('hidden');
            } else if(currentTab === 'challenge' && isAdmin) {
                title.innerText = "ìƒˆ ì±Œë¦°ì§€ ë“±ë¡ ğŸ†";
                document.getElementById('challengeForm').classList.remove('hidden');
            }
        };

        window.selectEmoji = (m, el) => { 
            selectedEmoji = m; 
            document.querySelectorAll('.emoji-item').forEach(item => item.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.submitPost = async () => {
            try {
                let data = {
                    date: new Date().toISOString(),
                    authorId: currentUser.uid,
                };
                let collectionName = "posts";

                if (currentTab === 'mood') {
                    if(!selectedEmoji) return window.showAlert("ë¬´ë“œ ì´ëª¨ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
                    data.type = 'mood';
                    data.emoji = selectedEmoji;
                    data.content = document.getElementById('moodContent').value;
                    
                    const userRef = doc(db, "users", currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    await setDoc(userRef, { stamps: (userSnap.data()?.stamps || 0) + 1 }, { merge: true });
                    window.showAlert("ê¸°ë¡ ì™„ë£Œ!<br>ìŠ¤íƒ¬í”„ê°€ í•˜ë‚˜ ì ë¦½ë˜ì—ˆì–´ìš” ğŸ¾");

                } else if (currentTab === 'letter') {
                    data.type = document.getElementById('letterCategory').value;
                    data.title = document.getElementById('letterTitle').value;
                    data.content = document.getElementById('letterContent').value;
                    data.url = document.getElementById('letterUrl').value;
                    data.btnText = document.getElementById('letterBtnText').value;
                    if(!data.title || !data.content) return window.showAlert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    window.showAlert("ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

                } else if (currentTab === 'challenge') {
                    collectionName = "challenges";
                    data.title = document.getElementById('chTitle').value;
                    data.content = document.getElementById('chContent').value;
                    data.openDate = document.getElementById('chOpenDate').value;
                    data.startDate = document.getElementById('chStartDate').value;
                    data.endDate = document.getElementById('chEndDate').value;
                    data.imgUrl = document.getElementById('chImgUrl').value;
                    if(!data.title) return window.showAlert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    window.showAlert("ì±Œë¦°ì§€ê°€ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }

                await addDoc(collection(db, collectionName), data);
                window.closeModal();
                window.renderTab(currentTab);

            } catch(e) {
                console.error(e);
                window.showAlert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            }
        };

        window.closeModal = () => {
            document.getElementById('writeModal').style.display = 'none';
            if((currentTab === 'mood') || (isAdmin && (currentTab === 'letter' || currentTab === 'challenge'))) {
                document.getElementById('fab').classList.add('show');
            }
        };

        // --- ì¸ì¦ ê´€ë ¨ ---
        window.toggleSignup = () => {
            const fields = document.getElementById('signupFields');
            const logBtn = document.getElementById('loginBtn');
            const signBtn = document.getElementById('signupBtn');
            
            if(fields.classList.contains('hidden')) {
                fields.classList.remove('hidden');
                logBtn.innerText = "ê°€ì… ì™„ë£Œ";
                logBtn.onclick = window.doSignup;
                signBtn.innerText = "ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°";
            } else {
                fields.classList.add('hidden');
                logBtn.innerText = "ë¡œê·¸ì¸";
                logBtn.onclick = window.doLogin;
                signBtn.innerText = "3ì´ˆë§Œì— íšŒì›ê°€ì…";
            }
        };

        // ë¡œê·¸ì¸ í•¨ìˆ˜ (ìˆ˜ì •ë¨: window ê°ì²´ì— í™•ì‹¤íˆ ë°”ì¸ë”©)
        window.doLogin = async () => {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPw').value;
            
            if(!email || !pw) {
                return window.showAlert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            try { 
                await signInWithEmailAndPassword(auth, email, pw); 
            } catch(e) { 
                console.error(e);
                let msg = "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                if(e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    msg = "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                } else if (e.code === 'auth/invalid-email') {
                    msg = "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.";
                }
                window.showAlert(msg); 
            }
        };

        window.doSignup = async () => {
            const email = document.getElementById('authEmail').value;
            const pw = document.getElementById('authPw').value;
            const nick = document.getElementById('authNick').value;
            if(!nick) return window.showAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pw);
                await updateProfile(cred.user, { displayName: nick });
                await setDoc(doc(db, "users", cred.user.uid), { email: email, name: nick, stamps: 0, role: 'user' });
                window.showAlert(`ë°˜ê°€ì›Œìš”, ${nick}ë‹˜! ğŸŒ¸`);
            } catch(e) { 
                console.error(e);
                window.showAlert("ê°€ì… ì‹¤íŒ¨: " + e.message); 
            }
        };

        window.sendResetEmail = async () => {
            const email = document.getElementById('resetEmailInput').value;
            if(!email) return window.showAlert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            try {
                await sendPasswordResetEmail(auth, email);
                window.showAlert("ì¬ì„¤ì • ë©”ì¼ì„ ë°œì†¡í–ˆì–´ìš”!<br>ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                document.getElementById('pwResetModal').style.display='none';
            } catch(e) { window.showAlert("ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        // ì•± ì´ˆê¸°í™” ë° ìƒíƒœ ë³€í™” ê°ì§€
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                // ê´€ë¦¬ì ì²´í¬
                isAdmin = ADMIN_EMAILS.includes(user.email);
                isSuperAdmin = (user.email === SUPER_ADMIN);

                document.getElementById('authModal').style.display = 'none';
                window.renderTab('home');
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>