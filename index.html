<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jahyu Letter</title>
    
    <!-- í°íŠ¸ & ì•„ì´ì½˜ & ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #9D76C1;
            --primary-soft: #F3E5F5;
            --pink-bg: #FFF0F5;
            --pink-input: #FFEFF2;
            --gray-input: #F8F9FA;
            --accent: #FFB7B2;
            --bg-body: #FFFCF9;
            --text-main: #4A4A4A;
            --text-sub: #9B9B9B;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 25px rgba(157, 118, 193, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nanum Round Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-body); color: var(--text-main); 
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
        }

        .app-container { 
            width: 100%; max-width: 480px; min-height: 100vh; 
            background: var(--bg-body); position: relative; padding-bottom: 100px; 
        }

        /* í—¤ë” (ìƒˆë¡œê³ ì¹¨ ì¶”ê°€) */
        .header { 
            padding: 20px; text-align: center; margin-top: 10px; position: relative; 
            display: flex; justify-content: center; align-items: center;
        }
        .logo { font-family: 'Gaegu'; font-size: 30px; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .refresh-btn { position: absolute; right: 20px; color: #ccc; font-size: 18px; cursor: pointer; }

        /* í™ˆ ì¤‘ì•™ ì •ë ¬ */
        .home-section { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; }
        .greeting { margin: 20px 0 30px; width: 100%; }
        .greeting h2 { font-size: 22px; color: var(--text-main); margin-bottom: 8px; font-weight: 800; }
        .greeting p { font-size: 14px; color: var(--text-sub); }

        .hero-card { width: 90%; padding: 30px; background: linear-gradient(135deg, #E0C3FC, #8EC5FC); border-radius: 25px; color: white; text-align: center; box-shadow: var(--shadow); cursor: pointer; margin-bottom: 30px; transition: transform 0.1s; }
        .hero-card:active { transform: scale(0.98); }
        
        /* í€µë©”ë‰´ */
        .quick-menu { display: flex; justify-content: space-between; width: 90%; margin-bottom: 40px; }
        .quick-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; gap: 8px; transition: transform 0.1s; }
        .quick-item:active { transform: scale(0.95); }
        .quick-icon { width: 60px; height: 60px; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .icon-1 { background: #FFD1DC; } .icon-2 { background: #C1E1C1; } .icon-3 { background: #B5EAD7; } .icon-4 { background: #FFDAC1; }
        .quick-text { font-size: 12px; font-weight: 700; color: var(--text-sub); }

        /* íƒ­ ë²„íŠ¼ */
        .archive-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; padding-top: 20px; }
        .tab-btn { padding: 8px 18px; border-radius: 20px; background: white; border: 1px solid #eee; color: var(--text-sub); font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .card-list { padding: 0 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; border: 1px solid rgba(0,0,0,0.02); position: relative; }
        .card:active { transform: scale(0.98); }
        .card-badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; margin-bottom: 8px; background: #eee; color: #666; }
        .card-badge.notice { background: #FFD43B; color: #862E9C; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; line-height: 1.4; color: #333; }
        .card-meta { font-size: 11px; color: #aaa; display: flex; justify-content: space-between; margin-top: 10px; }

        /* ì±Œë¦°ì§€ ì¹´ë“œ */
        .challenge-card { background: white; border-radius: 20px; overflow: hidden; margin: 0 20px 20px; box-shadow: var(--shadow); }
        .ch-img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .ch-info { padding: 20px; }
        .ch-title { font-size: 18px; font-weight: 800; margin: 10px 0; }
        .ch-meta { font-size: 13px; color: #888; display: flex; gap: 10px; margin-bottom: 15px; }

        /* ğŸ“ ê¸€ì“°ê¸° íŒì—… & ë¡œê·¸ì¸ (ì—°í•‘í¬) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .write-box { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 30px; position: relative; max-height: 90vh; overflow-y: auto; border: 2px solid #FFF0F5; }
        
        .pink-input { width: 100%; padding: 15px; background: var(--pink-input); border: 1px solid #FFE0E6; border-radius: 15px; margin-bottom: 12px; font-size: 14px; outline: none; transition: 0.2s; }
        .pink-input:focus { border-color: var(--accent); }
        .gray-input { width: 100%; padding: 12px; background: var(--gray-input); border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; font-size: 13px; color: #666; }
        
        .btn-pretty { width:100%; padding: 15px; border-radius: 15px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; margin-top: 5px; transition: transform 0.1s; }
        .btn-pretty:active { transform: scale(0.98); opacity: 0.9; }
        .btn-ok { background: linear-gradient(135deg, #FF9A9E, #FECFEF); color: white; box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4); }
        .btn-no { background: #f1f3f5; color: #868e96; margin-top: 10px; }

        /* ìŠ¤íƒ¬í”„ & ìº˜ë¦°ë” */
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .stamp { aspect-ratio: 1/1; border-radius: 50%; background: #F5F5F5; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #CCC; font-weight: 700; }
        .stamp.active { background: var(--primary); color: white; animation: pop 0.3s ease; }
        @keyframes pop { 0% { transform: scale(0.5); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        /* ìº˜ë¦°ë” íŒŒìŠ¤í…”í†¤ */
        .cal-wrap { background: #F3E5F5; border-radius: 25px; padding: 20px; margin: 0 20px 20px; box-shadow: var(--shadow); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .day-cell { aspect-ratio: 1/1; border-radius: 10px; background: rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; position: relative; }
        .day-cell.today { border: 2px solid var(--primary); font-weight: 700; background: white; }
        .day-emoji { font-size: 20px; }

        /* ë§ˆì´í˜ì´ì§€ */
        .admin-tag { background: #333; color: white; padding: 3px 8px; border-radius: 8px; font-size: 11px; margin-left: 5px; vertical-align: middle; }
        .d-day-badge { display: inline-block; background: #FFE0E6; color: #D6336C; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-top: 5px; }

        /* í•˜ë‹¨ë°” & FAB & Top Button */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 80px; background: rgba(255,255,255,0.95); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 1px solid #eee; padding-bottom: 10px; backdrop-filter: blur(10px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); width: 60px; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        
        .fab { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: var(--text-main); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 900; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }

        .top-btn { position: fixed; bottom: 100px; right: 85px; width: 45px; height: 45px; background: white; border-radius: 50%; display: none; align-items: center; justify-content: center; color: #aaa; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 900; font-size: 18px; border: 1px solid #eee; }

        .hidden { display: none !important; }
        .custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #FFF0F5; padding: 25px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 5000; text-align: center; width: 80%; max-width: 300px; display: none; border: 2px solid white; }
        
        /* ê´€ë¦¬ì ë¦¬ìŠ¤íŠ¸ */
        .admin-item { display: flex; justify-content: space-between; padding: 12px; background: #f8f9fa; margin-bottom: 5px; border-radius: 10px; font-size: 13px; align-items: center; }
        .del-btn { background: #FF6B6B; color: white; padding: 3px 8px; border-radius: 5px; font-size: 11px; cursor: pointer; }
        
        /* ëª¨ë‹¬ ë’¤ë¡œê°€ê¸° */
        .modal-back { position: absolute; bottom: 20px; right: 20px; width: 35px; height: 35px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #888; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>

    <!-- íŒì—… -->
    <div id="customAlert" class="custom-alert">
        <div style="font-size:30px; margin-bottom:10px;">âœ¨</div>
        <div id="alertMsg" style="margin-bottom:20px; font-weight:700; color:#444; word-break: keep-all; line-height:1.5;">ë©”ì‹œì§€</div>
        <button onclick="closeAlert()" class="btn-pretty btn-ok">í™•ì¸</button>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • íŒì—… -->
    <div id="pwModal" class="custom-alert" style="background:white; border:3px solid #FFE0E6;">
        <h3 style="color:var(--primary); margin-bottom:10px;">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h3>
        <p style="font-size:13px; color:#888; margin-bottom:15px; line-height:1.4;">ê°€ì…í•˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì‹œë©´<br>ì¬ì„¤ì • ë©”ì¼ì„ ë³´ë‚´ë“œë¦´ê²Œìš” ğŸ“¨<br>(ìŠ¤íŒ¸í•¨ë„ ê¼­ í™•ì¸í•´ì£¼ì„¸ìš”!)</p>
        <input type="email" id="resetEmail" class="pink-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <button onclick="sendResetEmail()" class="btn-pretty btn-ok">ë©”ì¼ ë³´ë‚´ê¸°</button>
        <button onclick="document.getElementById('pwModal').style.display='none'" class="btn-pretty btn-no">ë‹«ê¸°</button>
    </div>

    <!-- ìº¡ì²˜ìš© -->
    <div id="captureArea" style="position:fixed; top:-9999px; left:-9999px; background:white; padding:40px; width:360px; text-align:center;">
        <div style="font-family:'Gaegu'; font-size:30px; color:#9D76C1; margin-bottom:20px;">Jahyu Letter</div>
        <div id="captureContent"></div>
    </div>

    <!-- ë§¨ ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ -->
    <div id="scrollTopBtn" class="top-btn" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="app-container"></div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ -->
    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="renderTab('home')"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item" id="nav-letter" onclick="renderTab('letter')"><i class="fas fa-envelope-open-text"></i>ë ˆí„°</div>
        <div class="nav-item" id="nav-mood" onclick="renderTab('mood')"><i class="fas fa-calendar-alt"></i>ë¬´ë“œ</div>
        <div class="nav-item" id="nav-challenge" onclick="renderTab('challenge')"><i class="fas fa-running"></i>ì±Œë¦°ì§€</div>
        <div class="nav-item" id="nav-mypage" onclick="renderTab('mypage')"><i class="fas fa-user-circle"></i>ë§ˆì´</div>
    </nav>

    <!-- FAB -->
    <div id="fab" class="fab" onclick="openWriteModal()"><i class="fas fa-pen"></i></div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="write-box">
            <h3 style="text-align:center; color:var(--primary); margin-bottom:20px;">ê¸€ì“°ê¸°</h3>
            
            <div id="letterOptions" class="hidden">
                <select id="postCategory" class="pink-input">
                    <option value="ìíœ´ë ˆí„°">ìíœ´ë ˆí„°</option>
                    <option value="ìíœ´ë©">ìíœ´ë©</option>
                    <option value="ì—ë””í„°í†¡">ì—ë””í„°í†¡</option>
                </select>
                <label style="font-size:13px; display:block; margin-bottom:10px;">
                    <input type="checkbox" id="isNotice"> ğŸ“Œ ê³µì§€ì‚¬í•­ (ìƒë‹¨ ê³ ì •)
                </label>
            </div>

            <div id="challengeOptions" class="hidden">
                <select id="chDuration" class="pink-input">
                    <option value="5">5ì¼ ì±Œë¦°ì§€</option>
                    <option value="10">10ì¼ ì±Œë¦°ì§€</option>
                    <option value="30">30ì¼ ì±Œë¦°ì§€</option>
                </select>
                <input type="date" id="chStartDate" class="pink-input">
            </div>

            <div id="moodOptions" class="hidden" style="margin-bottom:15px; overflow-x:auto; white-space:nowrap;">
                <!-- ì´ëª¨ì§€ JS ë¡œë“œ -->
            </div>

            <input type="text" id="postTitle" class="pink-input" placeholder="ì œëª©">
            <textarea id="postContent" class="pink-input" style="height:100px; resize:none;" placeholder="ë‚´ìš©..."></textarea>
            
            <!-- ë§í¬ ì…ë ¥ (í•˜ë‹¨ ë°°ì¹˜ & íšŒìƒ‰) -->
            <div id="linkArea" class="hidden">
                <input type="text" id="linkUrl" class="gray-input" placeholder="ğŸ”— ì—°ê²°í•  ë§í¬ (http://...)">
                <input type="text" id="linkText" class="gray-input" placeholder="ë²„íŠ¼ ì´ë¦„ (ì˜ˆ: ë³´ëŸ¬ê°€ê¸°)">
            </div>

            <div onclick="document.getElementById('fileInput').click()" style="padding:15px; border:2px dashed #FFD1DC; border-radius:15px; text-align:center; color:#D66D75; cursor:pointer; margin:15px 0; font-size:13px;">
                <i class="fas fa-camera"></i> ì‚¬ì§„ ì¶”ê°€
            </div>
            <input type="file" id="fileInput" hidden accept="image/*">

            <div class="btn-group">
                <button onclick="submitPost()" class="btn-pretty btn-ok">ë“±ë¡í•˜ê¸°</button>
            </div>
            
            <!-- ìš°ì¸¡ í•˜ë‹¨ ë’¤ë¡œê°€ê¸° -->
            <div class="modal-back" onclick="closeModal()"><i class="fas fa-arrow-right"></i></div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="write-box" style="text-align:center;">
            <div style="font-family:'Gaegu'; font-size:36px; color:var(--primary); margin-bottom:10px;">Jahyu Letter</div>
            <p style="color:#aaa; margin-bottom:30px;">ë‹¹ì‹ ì„ ìœ„í•œ ì‰¼í‘œ ğŸŒ¿</p>
            <input type="email" id="email" class="pink-input" placeholder="ì´ë©”ì¼">
            <input type="password" id="pw" class="pink-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="doLogin()" class="btn-pretty btn-ok">ë¡œê·¸ì¸</button>
            <button onclick="doSignup()" class="btn-pretty btn-no">íšŒì›ê°€ì…</button>
            <p onclick="openResetPw()" style="font-size:12px; color:#aaa; margin-top:20px; cursor:pointer; text-decoration:underline;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</p>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="adminManageModal" class="modal-overlay">
        <div class="write-box">
            <h3>ğŸ‘‘ ê´€ë¦¬ì ê´€ë¦¬</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="email" id="newAdminEmail" class="pink-input" placeholder="ì´ë©”ì¼ ì…ë ¥" style="margin-bottom:0;">
                <button onclick="addNewAdmin()" class="btn-pretty btn-ok" style="width:80px; margin-top:0;">ì¶”ê°€</button>
            </div>
            <div id="adminList" style="max-height:200px; overflow-y:auto;"></div>
            <button onclick="document.getElementById('adminManageModal').style.display='none'" class="btn-pretty btn-no">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, orderBy, updateDoc, deleteDoc, arrayUnion, arrayRemove, setDoc, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ í–…ì‚ë‹˜ ì„¤ì •ê°’ ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isAdmin = false;
        let currentTab = 'home';
        const MOODS = ['ğŸ˜Š','ğŸ¥°','ğŸ˜Œ','ğŸ˜­','ğŸ˜¡','ğŸ˜´','ğŸ¤©','ğŸ¤”','ğŸ¥º','ğŸ”¥','â˜”','ğŸ€'];

        // --- íŒì—… ìœ í‹¸ ---
        window.showAlert = (msg) => {
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('customAlert').style.display = 'block';
        };
        window.closeAlert = () => document.getElementById('customAlert').style.display = 'none';
        window.closeModal = () => document.getElementById('writeModal').style.display = 'none';
        window.openResetPw = () => document.getElementById('pwModal').style.display = 'block';

        // --- ê´€ë¦¬ì ì²´í¬ ---
        async function checkIsAdmin(email) {
            if(email === 'happxi@jahyu.com') return true;
            try {
                const docRef = doc(db, "admins", email);
                const docSnap = await getDoc(docRef);
                return docSnap.exists();
            } catch(e) { return false; }
        }

        // --- ì¸ì¦ ---
        window.doLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value); }
            catch(e) { showAlert("ë¡œê·¸ì¸ ì •ë³´ê°€ í‹€ë ¤ìš” ğŸ˜¢"); }
        };
        window.doSignup = async () => {
            const nick = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if(!nick) return;
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value);
                await updateProfile(cred.user, { displayName: nick });
                await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, name: nick, createdAt: new Date().toISOString() });
                if(cred.user.email === 'happxi@jahyu.com') await setDoc(doc(db, "admins", cred.user.email), { addedAt: new Date().toISOString() });
                showAlert("ê°€ì…ì„ í™˜ì˜í•´ìš”! ğŸŒ¸");
            } catch(e) { showAlert("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì´ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”."); }
        };
        window.sendResetEmail = async () => {
            const email = document.getElementById('resetEmail').value;
            if(email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    showAlert("ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆì–´ìš”! ğŸ“¨");
                    document.getElementById('pwModal').style.display = 'none';
                } catch(e) { showAlert("ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); }
            }
        };

        // --- íƒ­ ë Œë”ë§ ---
        window.renderTab = (tab) => {
            currentTab = tab;
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`)?.classList.add('active');

            const fab = document.getElementById('fab');
            if(tab === 'mood') fab.style.display = 'flex';
            else if(isAdmin && (tab === 'letter' || tab === 'challenge')) fab.style.display = 'flex';
            else fab.style.display = 'none';

            if (tab === 'home') {
                container.innerHTML = `
                    <div class="header">
                        Jahyu letter
                        <i class="fas fa-sync-alt refresh-btn" onclick="renderTab(currentTab)"></i>
                    </div>
                    <div class="home-section">
                        <div class="greeting">
                            <h2>${currentUser.displayName}ë‹˜, ì˜¤ëŠ˜ ë§ˆìŒì€ ì–´ë•Œìš”?</h2>
                            <p>ìíœ´ë ˆí„°ì™€ í•¨ê»˜ ì ì‹œ ì‰¬ì–´ê°€ì„¸ìš” ğŸŒ¿</p>
                        </div>
                        <div class="hero-card" onclick="window.open('https://index-html-zak5.vercel.app/')">
                            <div style="font-size:18px; font-weight:700;">ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì‰¼ ìœ í˜•ì€?</div>
                            <div style="font-size:13px; margin-top:5px;">íë§ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸° ğŸ‘‰</div>
                        </div>
                        <div class="quick-menu">
                            <div class="quick-item" onclick="renderTab('letter')"><div class="quick-icon icon-1"><i class="fas fa-envelope-open-text"></i></div><span class="quick-text">ë ˆí„°</span></div>
                            <div class="quick-item" onclick="renderTab('challenge')"><div class="quick-icon icon-2"><i class="fas fa-running"></i></div><span class="quick-text">ì±Œë¦°ì§€</span></div>
                            <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn/111753149')"><div class="quick-icon icon-3"><i class="fas fa-pen-nib"></i></div><span class="quick-text">ë¬¸ì¥ìˆ˜ì§‘</span></div>
                            <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn')"><div class="quick-icon icon-4"><i class="fas fa-comments"></i></div><span class="quick-text">ì±„íŒ…</span></div>
                        </div>
                    </div>
                `;
            }
            else if (tab === 'letter') {
                container.innerHTML = `
                    <div style="padding:20px;">
                        <h2 style="color:var(--primary); text-align:center;">Archive</h2>
                        <div class="archive-tabs">
                            <div class="tab-btn active" onclick="fetchPosts('all', 'letterList')">ì „ì²´</div>
                            <div class="tab-btn" onclick="fetchPosts('ìíœ´ë ˆí„°', 'letterList')">ìíœ´ë ˆí„°</div>
                            <div class="tab-btn" onclick="fetchPosts('ìíœ´ë©', 'letterList')">ìíœ´ë©</div>
                        </div>
                        <div id="noticeList"></div>
                        <div id="letterList">ë¡œë”©ì¤‘...</div>
                    </div>
                `;
                fetchPosts('all', 'letterList');
            }
            else if (tab === 'challenge') {
                container.innerHTML = `
                    <div style="padding:20px; text-align:center; background:#F3E5F5; border-radius:0 0 30px 30px;">
                        <h3>í•¨ê»˜í•˜ëŠ” ë¦¬ì¶”ì–¼ ğŸƒâ€â™€ï¸</h3>
                        <p style="font-size:13px; color:#888;">ë‚˜ë§Œì˜ ì‚¬ì†Œí•œ ìŠµê´€ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                    </div>
                    <div id="challengeList" style="padding:20px;">ë¡œë”©ì¤‘...</div>
                `;
                fetchChallenges();
            }
            else if (tab === 'mood') {
                container.innerHTML = `
                    <div style="padding:20px; text-align:center;">
                        <h2>My Mood Log</h2>
                        <p style="font-size:13px; color:#aaa; margin-top:5px;">ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?<br>ë‚˜ì˜ ì†”ì§í•œ ê°ì •ì„ ê¸°ë¡í•´ ë³´ì„¸ìš”!</p>
                        
                        <div id="moodCalendar" class="cal-wrap">
                            <div style="font-weight:700; margin-bottom:10px;">${new Date().getMonth()+1}ì›”</div>
                            <div style="display:grid; grid-template-columns:repeat(7,1fr); font-size:12px; color:#bbb; margin-bottom:5px;">
                                <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                            </div>
                            <div id="calGrid" class="cal-grid" style="margin:0;"></div>
                        </div>
                        <div style="display:flex; gap:10px; justify-content:center;">
                            <button class="btn-pretty" style="background:#E3F2FD; color:#1976D2; width:auto; padding:10px 20px;" onclick="saveImage('moodCalendar')">ğŸ¨ ì˜ˆìœ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                            <button class="btn-pretty" style="background:#FFF3E0; color:#F57C00; width:auto; padding:10px 20px;" onclick="alert('ì´ë¯¸ì§€ ì €ì¥ í›„ ê³µìœ í•´ì£¼ì„¸ìš”!')">ğŸ“¤ ê³µìœ í•˜ê¸°</button>
                        </div>
                    </div>
                    <div style="padding:0 20px;">
                        <h4 style="margin-bottom:10px;">ìµœê·¼ ê¸°ë¡</h4>
                        <div id="moodList"></div>
                    </div>
                `;
                loadCalendar();
                fetchList('mood', 'moodList');
            }
            else if (tab === 'mypage') {
                renderMyPage(container);
            }
        };

        // --- ë°ì´í„° ë¡œì§ (ì•ˆì •ì„± ê°•í™”) ---
        async function fetchPosts(filter, targetId) {
            const target = document.getElementById(targetId);
            const noticeTarget = document.getElementById('noticeList');
            if(noticeTarget) noticeTarget.innerHTML = '';
            target.innerHTML = '';

            // ë³µí•© ì¸ë±ìŠ¤ ì—†ì´ ë‹¨ìˆœ ì¿¼ë¦¬ë¡œ ê°€ì ¸ì™€ JSë¡œ ì •ë ¬/í•„í„°ë§ (ë°ì´í„° ì¦ë°œ ë°©ì§€)
            const q = query(collection(db, "posts"));
            const snap = await getDocs(q);
            
            let posts = [];
            snap.forEach(d => posts.push({id: d.id, ...d.data()}));
            posts.sort((a,b) => new Date(b.date) - new Date(a.date)); // ìµœì‹ ìˆœ

            if(posts.length === 0) target.innerHTML = '<div style="text-align:center; color:#aaa; padding:20px;">ê¸€ì´ ì—†ì–´ìš”</div>';

            posts.forEach(p => {
                if(p.type !== 'post') return; // ì±Œë¦°ì§€/ë¬´ë“œ ì œì™¸
                
                const card = `
                    <div class="card" onclick="alert('ìƒì„¸ë³´ê¸°ëŠ” ëª©ë¡ì—ì„œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”!')">
                        ${p.image ? `<img src="${p.image}" style="width:100%; border-radius:10px; margin-bottom:10px;">` : ''}
                        <div class="card-badge ${p.isNotice?'notice':''}">${p.isNotice?'ğŸ“¢ ê³µì§€':p.category}</div>
                        <div style="font-weight:700; margin-bottom:5px;">${p.title}</div>
                        <div style="font-size:12px; color:#aaa;">${p.author}</div>
                        ${p.link ? `<a href="${p.link.url}" target="_blank" style="display:block; margin-top:10px; padding:10px; background:#f8f9fa; border-radius:10px; text-align:center; text-decoration:none; color:var(--primary); font-weight:700;">ğŸ”— ${p.link.text}</a>` : ''}
                    </div>
                `;
                if(p.isNotice && noticeTarget) noticeTarget.innerHTML += card;
                else {
                    if(filter === 'all' || p.category === filter) target.innerHTML += card;
                }
            });
        }

        async function fetchChallenges() {
            const target = document.getElementById('challengeList');
            target.innerHTML = '';
            
            const q = query(collection(db, "posts"), where("type", "==", "challenge"));
            const snap = await getDocs(q);
            
            let posts = [];
            snap.forEach(d => posts.push({id:d.id, ...d.data()}));
            posts.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(posts.length === 0) target.innerHTML = '<div style="text-align:center; color:#aaa;">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš”</div>';

            posts.forEach(p => {
                const count = p.participants ? p.participants.length : 0;
                target.innerHTML += `
                    <div class="challenge-card">
                        ${p.image ? `<img src="${p.image}" class="ch-img">` : '<div class="ch-img"></div>'}
                        <div class="ch-info">
                            <span style="background:var(--primary-soft); color:var(--primary); padding:3px 8px; border-radius:10px; font-size:11px; font-weight:700;">${p.duration}ì¼ ì±Œë¦°ì§€</span>
                            <div class="ch-title">${p.title}</div>
                            <div class="ch-meta">ğŸ“… ì‹œì‘: ${p.startDate || 'ìƒì‹œ'} <span style="color:var(--primary);">ğŸ”¥ ${count}ëª… ë„ì „ ì¤‘</span></div>
                            <button class="btn-pretty btn-ok" onclick="joinChallenge('${p.id}')">ì°¸ì—¬í•˜ê¸°</button>
                        </div>
                    </div>
                `;
            });
        }

        async function fetchList(type, targetId) {
            const target = document.getElementById(targetId);
            const q = query(collection(db, "posts"), where("type", "==", type), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            
            let posts = [];
            snap.forEach(d => posts.push({id:d.id, ...d.data()}));
            posts.sort((a,b) => new Date(b.date) - new Date(a.date));

            target.innerHTML = '';
            posts.forEach(p => {
                target.innerHTML += `<div class="card" style="display:flex; align-items:center;"><div style="font-size:30px; margin-right:15px;">${p.emoji}</div><div>${p.content}</div></div>`;
            });
        }

        // --- ë§ˆì´í˜ì´ì§€ ---
        async function renderMyPage(container) {
            const userSnap = await getDoc(doc(db, "users", currentUser.uid));
            const userData = userSnap.data();
            const joinDate = new Date(userData.createdAt);
            const today = new Date();
            const dayDiff = Math.ceil((today - joinDate) / (1000 * 60 * 60 * 24));

            container.innerHTML = `
                <div style="padding:40px 20px; text-align:center;">
                    <span class="d-day-badge">í•¨ê»˜í•œ ì§€ ${dayDiff}ì¼ì°¨ â¤ï¸</span>
                    <h3 style="margin-top:10px;">${currentUser.displayName}ë‹˜ ${isAdmin?'<span class="admin-tag">ê´€ë¦¬ì</span>':''}</h3>
                    <p style="color:#aaa; font-size:13px;">${currentUser.email}</p>
                </div>
                
                <div style="background:white; margin:20px; padding:20px; border-radius:20px; box-shadow:var(--shadow); text-align:center;">
                    <h4>ë‚˜ì˜ ìŠ¤íƒ¬í”„ ğŸ¾</h4>
                    <p style="font-size:12px; color:#888; margin-bottom:15px; line-height:1.5;">ìŠ¤íƒ¬í”„ë¥¼ ëª¨ë‘ ëª¨ìœ¼ë©´ ì–´ëŠë‚  ìŠ¤í˜ì…œ ë ˆí„°ê°€ ë„ì°©í•´ìš”!<br>ìíœ´ë ˆí„° ì¹´í†¡ ì±„ë„ì— 30ê°œ ì¸ì¦ìƒ·ì„ ë³´ë‚´ì£¼ì„¸ìš”!</p>
                    <div id="stampGrid" class="stamp-grid"></div>
                </div>

                <div style="padding:0 20px;">
                    ${isAdmin ? `<button class="btn-pretty" style="background:#333; color:white; margin-bottom:10px;" onclick="openAdminModal()">ğŸ”§ ê´€ë¦¬ì ê´€ë¦¬ (ì¶”ê°€/ì‚­ì œ)</button>` : ''}
                    <div class="card" style="padding:0;">
                        <div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick="showMyData('posts')">ğŸ“ ë‚´ê°€ ì“´ ê¸€</div>
                        <div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick="showMyData('comments')">ğŸ’¬ ë‚´ê°€ ì“´ ëŒ“ê¸€</div>
                        <div style="padding:15px; cursor:pointer;" onclick="showMyData('bookmarks')">ğŸ”– ë¶ë§ˆí¬í•œ ê¸€</div>
                    </div>
                    <button onclick="openResetPw()" class="btn-pretty btn-no">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    <button onclick="auth.signOut(); location.reload();" class="btn-pretty btn-no" style="color:#FF6B6B;">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            `;
            // ìŠ¤íƒ¬í”„ ë¡œë“œ
            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const count = snap.size;
            const grid = document.getElementById('stampGrid');
            if(grid) {
                grid.innerHTML = '';
                for(let i=1; i<=30; i++) {
                    grid.innerHTML += `<div class="stamp ${i<=count?'active':''}">${i}</div>`;
                }
            }
        }

        window.showMyData = async (type) => {
            const container = document.getElementById('appContainer');
            container.innerHTML = `
                <div class="header" style="text-align:left; padding-left:20px;"><i class="fas fa-arrow-left" onclick="renderTab('mypage')"></i></div>
                <h3 style="padding:0 20px;">ë³´ê´€í•¨</h3>
                <div id="myList" class="card-list" style="margin-top:20px;">ë¡œë”©ì¤‘...</div>
            `;
            const list = document.getElementById('myList');
            let q;
            if(type === 'posts') q = query(collection(db, "posts"), where("authorId", "==", currentUser.uid));
            else if(type === 'comments') q = query(collection(db, "comments"), where("authorId", "==", currentUser.uid));
            else q = query(collection(db, "posts"), where("bookmarks", "array-contains", currentUser.uid));

            const snap = await getDocs(q);
            list.innerHTML = '';
            if(snap.empty) list.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">ì•„ì§ ì—†ì–´ìš”!</div>';
            
            snap.forEach(d => {
                const data = d.data();
                list.innerHTML += `<div class="card">${data.content || data.title}</div>`;
            });
        };

        // --- ê´€ë¦¬ì ê´€ë¦¬ ---
        window.openAdminModal = async () => {
            document.getElementById('adminManageModal').style.display = 'flex';
            loadAdminList();
        };
        window.loadAdminList = async () => {
            const list = document.getElementById('adminList');
            list.innerHTML = 'ë¡œë”©ì¤‘...';
            const q = query(collection(db, "admins"));
            const snap = await getDocs(q);
            list.innerHTML = '';
            snap.forEach(d => {
                list.innerHTML += `
                    <div class="admin-item">
                        <span>${d.id}</span>
                        <span class="del-btn" onclick="removeAdmin('${d.id}')">ì‚­ì œ</span>
                    </div>
                `;
            });
        };
        window.addNewAdmin = async () => {
            const email = document.getElementById('newAdminEmail').value;
            if(!email) return;
            await setDoc(doc(db, "admins", email), { addedBy: currentUser.email, date: new Date().toISOString() });
            document.getElementById('newAdminEmail').value = '';
            loadAdminList();
            showAlert("ê´€ë¦¬ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
        };
        window.removeAdmin = async (email) => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "admins", email));
                loadAdminList();
            }
        };

        // --- ê¸€ì“°ê¸° ---
        window.openWriteModal = (forceType) => {
            const modal = document.getElementById('writeModal');
            const title = document.getElementById('postTitle');
            const content = document.getElementById('postContent');
            const linkArea = document.getElementById('linkArea');
            
            // ì´ˆê¸°í™”
            title.value = ''; content.value = '';
            document.getElementById('letterOptions').classList.add('hidden');
            document.getElementById('challengeOptions').classList.add('hidden');
            document.getElementById('moodOptions').classList.add('hidden');
            title.classList.remove('hidden');
            linkArea.classList.add('hidden');

            if (currentTab === 'letter') {
                document.getElementById('letterOptions').classList.remove('hidden');
                linkArea.classList.remove('hidden');
            } else if (currentTab === 'challenge') {
                document.getElementById('challengeOptions').classList.remove('hidden');
                title.placeholder = "ì±Œë¦°ì§€ ì´ë¦„ (ì˜ˆ: ë¬¼ ë§ˆì‹œê¸°)";
            } else if (currentTab === 'mood' || forceType === 'mood') {
                document.getElementById('moodOptions').classList.remove('hidden');
                title.classList.add('hidden'); 
                document.getElementById('emojiList').innerHTML = MOODS.map(m => `<div style="font-size:30px; cursor:pointer; min-width:40px;" onclick="selectEmoji('${m}')">${m}</div>`).join('');
            }
            modal.style.display = 'flex';
        };

        let selectedEmoji = null;
        window.selectEmoji = (m) => { selectedEmoji = m; showAlert(`${m} ì„ íƒë¨!`); };

        window.submitPost = async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const file = document.getElementById('fileInput').files[0];
            
            let imgStr = null;
            if(file) {
                imgStr = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            const data = {
                title: title || selectedEmoji,
                content: content,
                image: imgStr,
                date: new Date().toISOString(),
                author: currentUser.displayName,
                authorId: currentUser.uid,
                type: currentTab === 'mood' ? 'mood' : (currentTab === 'challenge' ? 'challenge' : 'post'),
                category: currentTab === 'letter' ? document.getElementById('postCategory').value : 'challenge',
                isNotice: document.getElementById('isNotice')?.checked || false,
                emoji: selectedEmoji,
                duration: document.getElementById('chDuration')?.value,
                startDate: document.getElementById('chStartDate')?.value,
                link: document.getElementById('linkUrl')?.value ? { url: document.getElementById('linkUrl').value, text: document.getElementById('linkText').value } : null,
                participants: [] 
            };

            await addDoc(collection(db, "posts"), data);
            window.closeModal();
            showAlert("ì €ì¥ ì™„ë£Œ! ğŸŒ¸");
            renderTab(currentTab);
        };

        // ì±Œë¦°ì§€ ì°¸ì—¬
        window.joinChallenge = async (id) => {
            const ref = doc(db, "posts", id);
            await updateDoc(ref, { participants: arrayUnion(currentUser.uid) });
            showAlert("ì±Œë¦°ì§€ ì°¸ì—¬ ì™„ë£Œ! ğŸ”¥");
            renderTab('challenge');
        };

        // ìº˜ë¦°ë”
        async function loadCalendar() {
            const grid = document.getElementById('calGrid');
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            const lastDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const records = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === today.getMonth()) records[date.getDate()] = d.data().emoji;
            });

            for(let i=1; i<=lastDate; i++) {
                grid.innerHTML += `
                    <div class="day-cell ${i===today.getDate()?'today':''}">
                        <span style="position:absolute; top:3px; left:5px;">${i}</span>
                        <span class="day-emoji">${records[i] || ''}</span>
                    </div>
                `;
            }
        }

        window.saveImage = (id) => {
            const target = document.getElementById(id);
            document.getElementById('captureContent').innerHTML = target.innerHTML;
            html2canvas(document.getElementById('captureArea')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'jahyu_mood.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        // ë§¨ ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ ë¡œì§
        window.onscroll = () => {
            const btn = document.getElementById('scrollTopBtn');
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
        };
        window.scrollToTop = () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.closeModal = () => document.getElementById('writeModal').style.display = 'none';

        // ì•± ì‹œì‘
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAdmin = await checkIsAdmin(user.email);
                document.getElementById('authModal').style.display = 'none';
                renderTab('home');
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>