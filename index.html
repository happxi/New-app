<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>자휴레터 - 햅삐님을 위한 특별한 공간!</title>
    
    <meta property="og:title" content="자휴레터를 앱으로 만나보세요!">
    <meta property="og:description" content="에디터와 햅삐님만을 위한 공간!">
    <meta property="og:image" content="https://imgur.com/WQgaT6m.png"> 
    <meta property="og:url" content="https://assets.carat-api.im/files/2907633/97cb17f3-d538-4c40-9705-3f9e517a4d5a/jahyu_letter_app_final.html">
    <meta property="og:type" content="website">
    
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6B46C1;
            --primary-soft: #F3E8FF;
            --primary-light: #A78BFA;
            --accent: #FF6B9D;
            --accent-soft: #FFE4EC;
            --secondary: #4ECDC4;
            --secondary-soft: #E6FFF9;
            --text-main: #2D3748;
            --text-sub: #718096;
            --white: #FFFFFF;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-card: 0 8px 32px rgba(107, 70, 193, 0.12);
            --shadow-glass: 0 8px 32px rgba(31, 38, 135, 0.15);
            --shadow-hover: 0 12px 40px rgba(107, 70, 193, 0.2);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Nanum Round Gothic', 'Noto Sans KR', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #F8F9FA 0%, #E6FFF9 100%);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            align-items: center;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, var(--primary-soft) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--accent-soft) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--secondary-soft) 0%, transparent 50%);
            z-index: -2;
            opacity: 0.6;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-soft) 0%, var(--accent-soft) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }

        .loading-content {
            text-align: center;
            color: var(--white);
        }

        .loading-logo {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 1.5s ease-in-out infinite;
        }

        .loading-text {
            font-size: 24px;
            font-weight: 700;
            opacity: 0.9;
        }

        .loading-dots {
            margin-top: 10px;
        }

        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
            margin: 0 2px;
            animation: dotPulse 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(2) { animation-delay: -0.32s; }
        .loading-dot:nth-child(3) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        @keyframes dotPulse {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .app-container {
            width: 100%; 
            max-width: 480px; 
            min-height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 0;
            margin: 0;
            box-shadow: var(--shadow-glass);
            border: none;
            padding-bottom: 90px;
            position: relative;
            overflow-x: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .app-container.visible {
            opacity: 1;
        }

        @media (min-width: 769px) {
            .app-container {
                border-radius: 30px 30px 0 0;
                margin-top: 20px;
                border: 1px solid var(--glass-border);
            }
        }

        .header-section {
            padding: 40px 25px 20px;
            text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.9) 100%);
            border-radius: 0;
        }

        @media (min-width: 769px) {
            .header-section {
                border-radius: 30px 30px 0 0;
            }
        }

        .header-title {
            font-size: 24px; 
            font-weight: 800; 
            color: var(--primary);
            margin-bottom: 8px; 
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(107, 70, 193, 0.1);
        }
        .header-sub {
            font-size: 14px; 
            color: var(--text-sub); 
            font-weight: 500;
        }

        .hero-card {
            background: linear-gradient(180deg, var(--white) 0%, var(--glass-bg) 100%);
            border-radius: 25px;
            padding: 40px 30px;
            margin: 0 20px 30px;
            text-align: center;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative; 
            overflow: hidden;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .hero-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--primary-soft) 0%, transparent 50%);
            opacity: 0.4;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(30px, -30px) rotate(180deg); }
        }

        .hero-card h3 { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--text-main); 
            margin-bottom: 10px; 
            position: relative;
            z-index: 1;
        }
        .hero-card p { 
            font-size: 14px; 
            color: var(--text-sub); 
            margin-bottom: 30px; 
            position: relative;
            z-index: 1;
        }
        
        .hero-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white; 
            padding: 16px 36px; 
            border-radius: 28px;
            font-size: 16px; 
            font-weight: 700; 
            border: none;
            box-shadow: 0 6px 20px rgba(107, 70, 193, 0.3);
            cursor: pointer; 
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .hero-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(107, 70, 193, 0.4);
        }
        .hero-btn:active { 
            transform: scale(0.98); 
        }

        .quick-menu {
            display: flex; 
            justify-content: space-between; 
            padding: 0 20px; 
            margin-bottom: 30px;
            flex-wrap: nowrap; 
            overflow-x: auto; 
            gap: 15px;
            padding-bottom: 10px;
        }
        
        .quick-menu::-webkit-scrollbar {
            height: 3px;
        }
        
        .quick-menu::-webkit-scrollbar-thumb {
            background-color: var(--primary-soft);
            border-radius: 2px;
        }
        
        .quick-item {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            min-width: 80px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .quick-item:hover {
            transform: translateY(-5px);
        }
        
        .quick-icon {
            width: 70px; 
            height: 70px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 28px; 
            margin-bottom: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .icon-purple { 
            background: linear-gradient(135deg, #A78BFA 0%, var(--primary) 100%); 
            color: white; 
        }
        .icon-blue { 
            background: linear-gradient(135deg, #93C5FD 0%, #2196F3 100%); 
            color: white; 
        }
        .icon-pink { 
            background: linear-gradient(135deg, #FBCFE8 0%, var(--accent) 100%); 
            color: white; 
        }
        .icon-mint { 
            background: linear-gradient(135deg, #99F6E4 0%, var(--secondary) 100%); 
            color: white; 
        }
        .icon-yellow { 
            background: linear-gradient(135deg, #FDE68A 0%, #FFC107 100%); 
            color: white; 
        }
        
        .quick-text { 
            font-size: 12px; 
            color: var(--text-main); 
            font-weight: 600; 
            text-align: center;
            white-space: nowrap;
        }

        .content-area {
            padding: 0 20px 20px;
        }

        .content-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 25px; 
            padding: 25px;
            margin-bottom: 20px; 
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .content-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-content {
            font-size: 14px;
            color: var(--text-sub);
            line-height: 1.6;
            margin-bottom: 14px;
        }
        
        .badge-new {
            position: absolute; 
            top: 20px; 
            right: 20px; 
            background: var(--accent); 
            color: white; 
            font-size: 11px;
            padding: 5px 12px; 
            border-radius: 15px; 
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .post-actions {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 8px;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            user-select: none;
        }

        .action-btn .fa-heart {
            transition: transform 0.15s ease;
        }

        .action-btn.liked { color: var(--accent); }
        .action-btn.bookmarked { color: var(--primary); }

        .bottom-nav {
            position: fixed; 
            bottom: 0; 
            left: 50%; 
            transform: translateX(-50%);
            width: 100%; 
            max-width: 480px; 
            height: 80px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            z-index: 1000; 
            padding-bottom: 10px;
            box-shadow: 0 -5px 20px rgba(31, 38, 135, 0.1);
        }
        
        .nav-item {
            display: flex; 
            flex-direction: column; 
            align-items: center;
            color: var(--text-sub); 
            text-decoration: none; 
            width: 60px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-item i { 
            font-size: 24px; 
            margin-bottom: 4px; 
            transition: all 0.3s ease;
        }
        
        .nav-text { 
            font-size: 11px; 
            font-weight: 600;
        }

        /* Sections */
        section.app-section {
            padding: 10px 0 60px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-main);
            margin: 20px 0 12px;
        }

        /* Modal / Detail */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal {
            width: 92%;
            max-width: 460px;
            background: var(--white);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2);
        }
        .modal .modal-title {
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .modal .modal-body {
            color: var(--text-main);
            margin-bottom: 16px;
            line-height: 1.6;
        }
        .modal .modal-footer {
            display:flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* EditorTalk compose area */
        .editor-compose {
            display:flex;
            gap:10px;
            margin: 10px 0 20px;
        }
        .editor-compose textarea {
            flex:1;
            padding:12px;
            border-radius:12px;
            border:1px solid rgba(0,0,0,0.06);
            min-height:80px;
            resize:vertical;
            font-size:14px;
        }
        .editor-compose button {
            background:var(--primary);
            color:white;
            border:none;
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:700;
        }

        /* test results panel */
        #test-results {
            position: fixed;
            right: 12px;
            bottom: 100px;
            width: 300px;
            max-width: 40%;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 3000;
            display: none;
            white-space: pre-wrap;
        }

        /* small helpers */
        .view-detail {
            display:inline-block;
            margin-top:8px;
            font-size:13px;
            color:var(--primary);
            font-weight:700;
            cursor:pointer;
        }

    </style>
</head>
<body>
    <div class="loading-screen" id="loading">
        <div class="loading-content">
            <div class="loading-logo">자휴</div>
            <div class="loading-text">로딩 중…</div>
            <div class="loading-dots">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            </div>
        </div>
    </div>

    <div class="app-container" id="app">
        <header class="header-section">
            <div class="header-title">자휴레터</div>
            <div class="header-sub">햅삐님을 위한 특별한 공간</div>
        </header>

        <main class="content-area" id="main-content">
            <section id="home" class="app-section">
                <div class="hero-card">
                    <h3>오늘의 자휴</h3>
                    <p>잠깐 쉬어도 괜찮아요. 짧은 글과 추천을 만나보세요.</p>
                    <button class="hero-btn" id="discover-btn"><i class="fa-solid fa-compass"></i> 둘러보기</button>
                </div>

                <div class="quick-menu" aria-hidden="false">
                    <div class="quick-item" data-target="home">
                        <div class="quick-icon icon-purple"><i class="fa-solid fa-house"></i></div>
                        <div class="quick-text">홈</div>
                    </div>
                    <div class="quick-item" data-target="discover">
                        <div class="quick-icon icon-blue"><i class="fa-solid fa-magnifying-glass"></i></div>
                        <div class="quick-text">발견</div>
                    </div>
                    <div class="quick-item" data-target="editor-talk">
                        <div class="quick-icon icon-pink"><i class="fa-solid fa-pen"></i></div>
                        <div class="quick-text">에디터톡</div>
                    </div>
                    <div class="quick-item" data-target="notifications">
                        <div class="quick-icon icon-mint"><i class="fa-solid fa-bell"></i></div>
                        <div class="quick-text">알림</div>
                    </div>
                    <div class="quick-item" data-target="profile">
                        <div class="quick-icon icon-yellow"><i class="fa-solid fa-user"></i></div>
                        <div class="quick-text">내정보</div>
                    </div>
                </div>

                <div class="section-title">최신 게시물</div>

                <!-- sample posts -->
                <article class="content-card" data-post-id="p1">
                    <div class="card-title">따뜻한 오후의 음료</div>
                    <div class="card-content">오늘은 우유 한 잔과 함께 창밖을 보며 천천히 쉬었어요. 작은 호흡이 큰 도움이 되더군요.</div>
                    <div class="post-actions">
                        <div class="action-btn btn-like" data-post-id="p1"><i class="fa-regular fa-heart"></i><span class="count">12</span></div>
                        <div class="action-btn btn-bookmark" data-post-id="p1"><i class="fa-regular fa-bookmark"></i><span class="count">3</span></div>
                        <div class="action-btn btn-comment" data-post-id="p1"><i class="fa-regular fa-comment"></i><span class="count">2</span></div>
                        <div class="view-detail" data-post-id="p1">상세보기</div>
                    </div>
                </article>

                <article class="content-card" data-post-id="p2">
                    <div class="card-title">짧은 산책의 힘</div>
                    <div class="card-content">10분만 걸어도 생각 정리가 잘 되는 걸 느껴요. 가벼운 스트레칭도 함께 해보세요.</div>
                    <div class="post-actions">
                        <div class="action-btn btn-like" data-post-id="p2"><i class="fa-regular fa-heart"></i><span class="count">8</span></div>
                        <div class="action-btn btn-bookmark" data-post-id="p2"><i class="fa-regular fa-bookmark"></i><span class="count">1</span></div>
                        <div class="action-btn btn-comment" data-post-id="p2"><i class="fa-regular fa-comment"></i><span class="count">0</span></div>
                        <div class="view-detail" data-post-id="p2">상세보기</div>
                    </div>
                </article>
            </section>

            <section id="discover" class="app-section">
                <div class="section-title">발견</div>
                <div class="content-card" data-post-id="d1">
                    <div class="card-title">편안한 읽기 추천</div>
                    <div class="card-content">이번 주 추천 도서: 짧은 묵상집. 1일 1장으로 부담 없이 읽기 좋아요.</div>
                    <div class="post-actions">
                        <div class="action-btn btn-like" data-post-id="d1"><i class="fa-regular fa-heart"></i><span class="count">5</span></div>
                        <div class="action-btn btn-bookmark" data-post-id="d1"><i class="fa-regular fa-bookmark"></i><span class="count">2</span></div>
                        <div class="action-btn btn-comment" data-post-id="d1"><i class="fa-regular fa-comment"></i><span class="count">1</span></div>
                        <div class="view-detail" data-post-id="d1">상세보기</div>
                    </div>
                </div>
            </section>

            <section id="editor-talk" class="app-section">
                <div class="section-title">에디터톡</div>

                <!-- compose area: only visible to editors (controlled by JS) -->
                <div id="editor-compose-area" class="editor-compose" style="display:none;">
                    <textarea id="editor-text" placeholder="에디터 전용 글을 작성하세요..."></textarea>
                    <div>
                        <button id="editor-post-btn">게시</button>
                    </div>
                </div>

                <div id="editor-posts">
                    <!-- editor posts will be inserted here -->
                </div>

                <div id="editor-hint" style="color:var(--text-sub); font-size:13px; margin-top:8px;">
                    에디터 5명만 작성할 수 있는 게시판입니다.
                </div>
            </section>

            <section id="notifications" class="app-section">
                <div class="section-title">알림</div>
                <div class="content-card">
                    <div class="card-title">새 알림이 없습니다</div>
                    <div class="card-content">활동이 생기면 알려드릴게요.</div>
                </div>
            </section>

            <section id="profile" class="app-section">
                <div class="section-title">내정보</div>
                <div class="content-card">
                    <div class="card-title" id="profile-name">사용자</div>
                    <div class="card-content" id="profile-desc">간단한 프로필 설명이 들어갑니다.</div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav" role="navigation" aria-label="하단 메뉴">
            <div class="nav-item" data-target="home"><i class="fa-solid fa-house"></i><div class="nav-text">홈</div></div>
            <div class="nav-item" data-target="discover"><i class="fa-solid fa-magnifying-glass"></i><div class="nav-text">발견</div></div>
            <div class="nav-item" data-target="editor-talk"><i class="fa-solid fa-pen"></i><div class="nav-text">에디터톡</div></div>
            <div class="nav-item" data-target="notifications"><i class="fa-solid fa-bell"></i><div class="nav-text">알림</div></div>
            <div class="nav-item" data-target="profile"><i class="fa-solid fa-user"></i><div class="nav-text">내정보</div></div>
        </nav>
    </div>

    <!-- Modal for detail / comments -->
    <div class="modal-backdrop" id="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-title" id="modal-title">상세보기</div>
            <div class="modal-body" id="modal-body">...</div>
            <div style="margin-bottom:10px;">
                <input id="comment-input" placeholder="댓글을 입력하세요" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); margin-bottom:8px;">
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button id="btn-add-comment" style="background:var(--primary); color:#fff; padding:8px 12px; border-radius:8px; border:none;">댓글쓰기</button>
                    <button id="btn-close-modal" style="background:#eee; color:#333; padding:8px 12px; border-radius:8px; border:none;">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <pre id="test-results" aria-hidden="true"></pre>

    <script>
        /**************************************************************************
         * 가정 및 샘플 데이터
         * - currentUser: 현재 접속 사용자 시뮬레이션
         * - editors: 에디터ID 목록(최대 5명). 에디터만 에디터톡 작성 가능
         * - posts: 클라이언트 측 게시물 상태 관리(간단한 예시)
         **************************************************************************/

        const currentUser = { id: 'user_hyeran', name: '혜란' }; // 실제 환경에서는 서버에서 제공
        const editors = ['editor_a', 'editor_b', 'editor_c', 'editor_d', 'editor_e']; // 정확히 5명
        // 초기 posts: id, title, content, likes, bookmarks, comments(array)
        const posts = {
            p1: { id:'p1', title:'따뜻한 오후의 음료', content:'오늘은 우유 한 잔과 함께 창밖을 보며 천천히 쉬었어요. 작은 호흡이 큰 도움이 되더군요.', likes:12, bookmarks:3, comments: [{user:'guest',text:'좋아요'}] },
            p2: { id:'p2', title:'짧은 산책의 힘', content:'10분만 걸어도 생각 정리가 잘 되는 걸 느껴요. 가벼운 스트레칭도 함께 해보세요.', likes:8, bookmarks:1, comments: [] },
            d1: { id:'d1', title:'편안한 읽기 추천', content:'이번 주 추천 도서: 짧은 묵상집. 1일 1장으로 부담 없이 읽기 좋아요.', likes:5, bookmarks:2, comments:[{user:'reader',text:'저도 읽어볼게요'}] }
        };

        // 에디터톡 전용 게시물 저장
        const editorTalkPosts = [];

        // 간단한 유틸: 포맷 출력
        function $(sel, root=document) { return root.querySelector(sel); }
        function $all(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 프로필 표시
            $('#profile-name').textContent = currentUser.name;
            $('#profile-desc').textContent = currentUser.id;

            // 로딩 화면 숨기기
            setTimeout(()=> {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.add('visible');
            }, 600);

            // quick menu, bottom nav 이동 연결
            $all('.quick-item').forEach(item => {
                item.addEventListener('click', () => {
                    const target = item.dataset.target;
                    scrollToSection(target);
                });
            });
            $all('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const target = item.dataset.target;
                    scrollToSection(target);
                });
            });
            $('#discover-btn').addEventListener('click', ()=> scrollToSection('discover'));

            // 게시물 액션 연결
            attachPostActionHandlers();

            // 상세보기 열기 연결
            $all('.view-detail').forEach(btn => {
                btn.addEventListener('click', (e)=> {
                    const id = btn.dataset.postId;
                    openDetailModal(id);
                });
            });

            // 카드 클릭 시에도 상세보기
            $all('.content-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // 카드 내부의 버튼 클릭이면 무시
                    if (e.target.closest('.action-btn') || e.target.classList.contains('view-detail')) return;
                    const id = card.dataset.postId;
                    if (id) openDetailModal(id);
                });
            });

            // 모달 버튼 핸들러
            $('#btn-close-modal').addEventListener('click', closeModal);
            $('#btn-add-comment').addEventListener('click', addCommentFromModal);

            // 에디터톡: 표시 여부 결정
            const editorArea = $('#editor-compose-area');
            if (editors.includes(currentUser.id)) {
                editorArea.style.display = 'flex';
            } else {
                editorArea.style.display = 'none';
            }
            $('#editor-post-btn').addEventListener('click', attemptEditorPost);

            // 에디터톡 기존 게시물 렌더
            renderEditorTalkPosts();

            // 자동 점검(10번) 실행
            runSelfTests(10);
        });

        // 스크롤/섹션 이동
        function scrollToSection(id) {
            const section = document.getElementById(id);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                console.warn('해당 섹션을 찾을 수 없습니다:', id);
            }
        }

        // 게시물 액션 연결 함수
        function attachPostActionHandlers() {
            // 좋아요
            $all('.btn-like').forEach(btn => {
                btn.addEventListener('click', (e)=> {
                    e.stopPropagation();
                    const id = btn.dataset.postId;
                    toggleLike(btn, id);
                });
            });
            // 북마크
            $all('.btn-bookmark').forEach(btn => {
                btn.addEventListener('click', (e)=> {
                    e.stopPropagation();
                    const id = btn.dataset.postId;
                    toggleBookmark(btn, id);
                });
            });
            // 댓글 열기
            $all('.btn-comment').forEach(btn => {
                btn.addEventListener('click', (e)=> {
                    e.stopPropagation();
                    const id = btn.dataset.postId;
                    openDetailModal(id, true);
                });
            });
        }

        // 좋아요 토글(모든 사용자 가능)
        function toggleLike(btn, postId) {
            const post = posts[postId] || editorTalkPosts.find(p=>p.id===postId);
            if (!post) return;
            // 간단히: 짝수/홀수로 Liked 토글 시뮬레이션
            const liked = btn.classList.toggle('liked');
            const icon = btn.querySelector('i');
            if (liked) {
                // solid heart
                if (icon) { icon.className = 'fa-solid fa-heart'; }
                post.likes = (post.likes || 0) + 1;
            } else {
                if (icon) { icon.className = 'fa-regular fa-heart'; }
                post.likes = Math.max(0, (post.likes || 1) - 1);
            }
            const count = btn.querySelector('.count');
            if (count) count.textContent = post.likes;
            console.log('like toggled', postId, 'liked=', liked, 'likes=', post.likes);
        }

        // 북마크 토글(모든 사용자 가능)
        function toggleBookmark(btn, postId) {
            const post = posts[postId] || editorTalkPosts.find(p=>p.id===postId);
            if (!post) return;
            const bookmarked = btn.classList.toggle('bookmarked');
            const icon = btn.querySelector('i');
            if (bookmarked) {
                if (icon) { icon.className = 'fa-solid fa-bookmark'; }
                post.bookmarks = (post.bookmarks || 0) + 1;
            } else {
                if (icon) { icon.className = 'fa-regular fa-bookmark'; }
                post.bookmarks = Math.max(0, (post.bookmarks || 1) - 1);
            }
            const count = btn.querySelector('.count');
            if (count) count.textContent = post.bookmarks;
            console.log('bookmark toggled', postId, 'bookmarked=', bookmarked, 'bookmarks=', post.bookmarks);
        }

        // 상세 모달 열기. focusComment true면 모달에서 댓글 입력에 포커스
        function openDetailModal(postId, focusComment=false) {
            const post = posts[postId] || editorTalkPosts.find(p=>p.id===postId);
            if (!post) return;
            $('#modal-title').textContent = post.title;
            $('#modal-body').textContent = post.content;
            $('#modal-backdrop').classList.add('show');
            const commentInput = $('#comment-input');
            commentInput.value = '';
            if (focusComment) {
                setTimeout(()=> commentInput.focus(), 300);
            }
            // 실제로는 댓글 목록을 렌더해야 하지만 간단히 유지
            $('#modal-backdrop').dataset.postId = postId;
        }

        function closeModal() {
            $('#modal-backdrop').classList.remove('show');
            delete $('#modal-backdrop').dataset.postId;
        }

        // 모달에서 댓글 추가
        function addCommentFromModal() {
            const postId = $('#modal-backdrop').dataset.postId;
            if (!postId) return;
            const txt = $('#comment-input').value.trim();
            if (!txt) { alert('댓글 내용을 입력해주세요.'); return; }
            const post = posts[postId] || editorTalkPosts.find(p=>p.id===postId);
            if (!post) return;
            post.comments = post.comments || [];
            post.comments.push({ user: currentUser.name, text: txt });
            // 업데이트: 댓글 카운트 표시
            const commentBtn = document.querySelector(`.btn-comment[data-post-id="${postId}"]`);
            if (commentBtn) {
                const cspan = commentBtn.querySelector('.count');
                if (cspan) cspan.textContent = post.comments.length;
            }
            $('#comment-input').value = '';
            alert('댓글이 등록되었습니다.');
            console.log('comment added', postId, txt);
        }

        // 에디터 전용 게시물 작성 시도
        function attemptEditorPost() {
            if (!editors.includes(currentUser.id)) {
                alert('에디터만 작성할 수 있습니다.');
                return;
            }
            const content = $('#editor-text').value.trim();
            if (!content) { alert('내용을 입력하세요.'); return; }
            // 새 게시물 객체 생성
            const id = 'et_' + Date.now();
            const newPost = { id, title: content.slice(0,20), content, likes:0, bookmarks:0, comments:[] };
            editorTalkPosts.unshift(newPost); // 최신순
            $('#editor-text').value = '';
            renderEditorTalkPosts();
            attachPostActionHandlers(); // 새로 생긴 버튼들에 이벤트 연결
            alert('게시되었습니다 (에디터톡).');
        }

        // 에디터톡 게시물 렌더링
        function renderEditorTalkPosts() {
            const container = $('#editor-posts');
            container.innerHTML = '';
            if (editorTalkPosts.length === 0) {
                container.innerHTML = '<div class="content-card"><div class="card-title">에디터의 첫 글을 기다립니다</div><div class="card-content">에디터 5명만 작성 가능한 공간입니다.</div></div>';
                return;
            }
            editorTalkPosts.forEach(p => {
                const el = document.createElement('article');
                el.className = 'content-card';
                el.dataset.postId = p.id;
                el.innerHTML = `
                    <div class="card-title">${escapeHtml(p.title)}</div>
                    <div class="card-content">${escapeHtml(truncate(p.content,120))}</div>
                    <div class="post-actions">
                        <div class="action-btn btn-like" data-post-id="${p.id}"><i class="fa-regular fa-heart"></i><span class="count">${p.likes}</span></div>
                        <div class="action-btn btn-bookmark" data-post-id="${p.id}"><i class="fa-regular fa-bookmark"></i><span class="count">${p.bookmarks}</span></div>
                        <div class="action-btn btn-comment" data-post-id="${p.id}"><i class="fa-regular fa-comment"></i><span class="count">${(p.comments||[]).length}</span></div>
                        <div class="view-detail" data-post-id="${p.id}">상세보기</div>
                    </div>
                `;
                container.appendChild(el);
            });
            // 세팅 후 이벤트 재연결
            $all('.view-detail').forEach(btn => {
                btn.removeEventListener('click', viewDetailHandler);
                btn.addEventListener('click', viewDetailHandler);
            });
            attachPostActionHandlers();
            // 카드 클릭 시 상세보기
            $all('#editor-posts .content-card').forEach(card => {
                card.addEventListener('click', (e)=>{
                    if (e.target.closest('.action-btn') || e.target.classList.contains('view-detail')) return;
                    const id = card.dataset.postId;
                    openDetailModal(id);
                });
            });
        }
        function viewDetailHandler(e) {
            const id = e.currentTarget.dataset.postId;
            openDetailModal(id);
            e.stopPropagation();
        }

        // 안전한 텍스트 렌더용
        function escapeHtml(s) {
            return (s+'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; });
        }
        function truncate(s, n) {
            return s.length > n ? s.slice(0,n-1) + '…' : s;
        }

        /**************************************************************************
         * 자동 점검: runSelfTests(n)
         * - 페이지 동작을 10번(혹은 n번) 시뮬레이션하여 성공/실패 로그 생성
         * - 결과를 화면과 콘솔에 출력
         **************************************************************************/
        function runSelfTests(n=10) {
            const results = [];
            // 간단 시뮬레이션 루틴
            for (let i=0;i<n;i++) {
                try {
                    // 1) 네비게이션: 홈->발견->에디터톡
                    scrollToSection('home');
                    scrollToSection('discover');
                    scrollToSection('editor-talk');

                    // 2) 상세보기 열기/닫기 (p1)
                    openDetailModal('p1');
                    if (!$('#modal-backdrop').classList.contains('show')) throw 'modal failed to open';
                    closeModal();

                    // 3) 좋아요 토글 (p1)
                    const likeBtn = document.querySelector(`.btn-like[data-post-id="p1"]`);
                    if (!likeBtn) throw 'likeBtn not found';
                    const beforeLikes = posts.p1.likes;
                    toggleLike(likeBtn, 'p1');
                    // 되돌려서 항상 같은 상태 유지
                    toggleLike(likeBtn, 'p1');
                    if (posts.p1.likes !== beforeLikes) throw 'like count mismatch after toggles';

                    // 4) 북마크 토글 (p1)
                    const bmBtn = document.querySelector(`.btn-bookmark[data-post-id="p1"]`);
                    const beforeB = posts.p1.bookmarks;
                    toggleBookmark(bmBtn, 'p1');
                    toggleBookmark(bmBtn, 'p1');
                    if (posts.p1.bookmarks !== beforeB) throw 'bookmark count mismatch';

                    // 5) 댓글 추가 테스트 (임시)
                    const prevComments = posts.p1.comments.length;
                    posts.p1.comments.push({user: 'test', text: 'ok'});
                    posts.p1.comments.pop();
                    if (posts.p1.comments.length !== prevComments) throw 'comments mismatch';

                    // 6) 에디터톡 접근: currentUser이 에디터면 작성 시도, 아니면 접근 제한 확인
                    if (editors.includes(currentUser.id)) {
                        // 작성 후 삭제 (cleanup)
                        const tmpId = 'test_e_'+Date.now();
                        editorTalkPosts.unshift({id: tmpId, title:'t', content:'t', likes:0, bookmarks:0, comments:[]});
                        editorTalkPosts.shift();
                    } else {
                        // 작성 버튼 클릭 시 alert 발생(handled by attemptEditorPost), 여기선 단순 체크
                        // nothing to do; ensure compose area hidden
                        if ($('#editor-compose-area').style.display !== 'none') {
                            throw 'editor area visibility mismatch';
                        }
                    }

                    results.push(`Test ${i+1}: OK`);
                } catch (err) {
                    results.push(`Test ${i+1}: FAIL - ${String(err)}`);
                }
            }

            // 결과 표시
            const out = results.join('\\n');
            console.log('Self tests results:\\n' + out);
            const panel = document.getElementById('test-results');
            panel.textContent = '자동 점검 결과\\n' + out;
            panel.style.display = 'block';
            // 6초 뒤 사라지게 (사용자 확인용)
            setTimeout(()=> { panel.style.display = 'none'; }, 6000);
        }

        // 간단한 핸들러 참조 제거/추가 안정화
        function viewDetailHandlerRef(e) {
            const id = e.currentTarget.dataset.postId;
            openDetailModal(id);
            e.stopPropagation();
        }

    </script>
</body>
</html>