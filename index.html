<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 1. ë§í¬ ë¯¸ë¦¬ë³´ê¸° (Open Graph) -->
    <meta property="og:title" content="Jahyu Letter">
    <meta property="og:description" content="ë‹¹ì‹ ì„ ìœ„í•œ ì‰¼í‘œ, ìíœ´ë ˆí„° ğŸŒ¿">
    <meta property="og:image" content="https://images.unsplash.com/photo-1499750310159-5b5f226932b7?q=80&w=200&auto=format&fit=crop"> <!-- ì„ì‹œ íë§ ì´ë¯¸ì§€ -->
    <title>Jahyu Letter</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Gaegu:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #9D76C1; --primary-soft: #F3E5F5;
            --pink-bg: #FFF0F5; --pink-input: #FFEFF2; --pink-popup: #FFE4EC;
            --accent: #FFB7B2; --bg-body: #FFFCF9;
            --text-main: #4A4A4A; --text-sub: #9B9B9B;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 25px rgba(157, 118, 193, 0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nanum Round Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* 2. ë“œë˜ê·¸ ë°©ì§€ ë° í„°ì¹˜ê° ê°œì„  */
        .no-select { user-select: none; -webkit-user-select: none; }
        button:active, .btn-pretty:active, .tab-btn:active, .quick-item:active, .card:active, .nav-item:active { 
            transform: scale(0.96); opacity: 0.8; transition: 0.1s;
        }

        body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--bg-body); position: relative; padding-bottom: 100px; }

        /* í—¤ë” */
        .header { height: 60px; display: flex; align-items: center; justify-content: center; position: relative; margin-top: 10px; padding: 0 20px; }
        .logo { font-family: 'Dancing Script', cursive; font-size: 32px; color: var(--primary); font-weight: 700; }
        .header-right { position: absolute; right: 20px; display: flex; gap: 15px; align-items: center; }
        .icon-btn { font-size: 20px; color: #ccc; cursor: pointer; }
        .back-icon { font-size: 20px; color: var(--text-main); cursor: pointer; }

        /* í™ˆ */
        .home-section { text-align: center; width: 100%; padding-top: 20px; }
        .greeting { margin: 20px 0 30px; width: 100%; }
        .greeting h2 { font-size: 22px; color: var(--text-main); margin-bottom: 8px; font-weight: 800; }
        .hero-card { width: 90%; margin: 20px auto; padding: 30px; background: linear-gradient(135deg, #E0C3FC, #8EC5FC); border-radius: 25px; color: white; text-align: center; box-shadow: var(--shadow); }
        
        /* í€µë©”ë‰´ */
        .quick-menu { display: flex; justify-content: space-between; padding: 0 30px; margin-bottom: 40px; }
        .quick-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .quick-icon { width: 60px; height: 60px; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: var(--shadow); }
        .icon-1 { background: #FFD1DC; } .icon-2 { background: #C1E1C1; } .icon-3 { background: #B5EAD7; } .icon-4 { background: #FFDAC1; }
        .quick-text { font-size: 12px; font-weight: 700; color: var(--text-sub); }

        /* íƒ­ ë²„íŠ¼ */
        .archive-tabs { display: flex; justify-content: center; gap: 8px; margin: 20px 0; padding: 0 10px; flex-wrap: wrap; }
        .tab-btn { padding: 8px 16px; border-radius: 20px; background: white; border: 1px solid #eee; color: var(--text-sub); font-size: 13px; font-weight: 700; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(157, 118, 193, 0.2); }

        /* ì¹´ë“œ */
        .card-list { padding: 0 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02); position: relative; cursor: pointer; }
        .card-badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; margin-bottom: 8px; background: #eee; color: #666; }
        .card-badge.notice { background: #FFD43B; color: #862E9C; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; line-height: 1.4; color: #333; }
        .more-btn { position: absolute; top: 15px; right: 15px; color: #ccc; padding: 5px; font-size: 18px; }

        /* ì±Œë¦°ì§€ */
        .challenge-header { text-align: center; background: #F3E5F5; padding: 30px 20px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
        .challenge-tip { background: rgba(255,255,255,0.6); padding: 10px; border-radius: 15px; display: inline-block; font-size: 11px; color: var(--primary); font-weight: 700; margin-top: 10px; }
        .challenge-card { background: white; border-radius: 20px; overflow: hidden; margin: 0 20px 20px; box-shadow: var(--shadow); cursor: pointer; }
        .ch-img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .ch-info { padding: 20px; }
        .ch-meta { font-size: 12px; color: #888; display: flex; gap: 10px; margin-bottom: 15px; }

        /* ë¬´ë“œ */
        .mood-header { text-align: center; padding: 20px; margin-bottom: 10px; }
        .cal-wrap { background: #F3E5F5; border-radius: 25px; padding: 20px; margin: 0 20px 20px; box-shadow: var(--shadow); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; margin-top: 10px; }
        .day-cell { aspect-ratio: 1/1; border-radius: 10px; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; position: relative; }
        .day-cell.today { border: 2px solid var(--primary); background: white; font-weight: 700; }
        .day-emoji { font-size: 20px; }

        /* íŒì—… (ì—°í•‘í¬) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .write-box { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 30px; position: relative; max-height: 90vh; overflow-y: auto; border: 3px solid var(--pink-bg); }
        .pink-input { width: 100%; padding: 15px; background: var(--pink-input); border: 1px solid #FFE0E6; border-radius: 15px; margin-bottom: 12px; font-size: 14px; outline: none; }
        .btn-pretty { width:100%; padding: 15px; border-radius: 15px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; margin-top: 5px; }
        .btn-ok { background: linear-gradient(135deg, #FF9A9E, #FECFEF); color: white; box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4); }
        .btn-no { background: #f1f3f5; color: #868e96; margin-top: 10px; }

        /* í•˜ë‹¨ë°” & FAB */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 80px; background: rgba(255,255,255,0.95); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 1px solid #eee; padding-bottom: 10px; backdrop-filter: blur(10px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); width: 60px; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .fab { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: var(--text-main); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 900; }

        .hidden { display: none !important; }
        .custom-alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #FFF0F5; padding: 25px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 5000; text-align: center; width: 80%; max-width: 300px; display: none; border: 2px solid white; }
        
        /* ë§ˆì´í˜ì´ì§€ ìŠ¤íƒ¬í”„ */
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .stamp { aspect-ratio: 1/1; border-radius: 50%; background: #F5F5F5; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #CCC; font-weight: 700; border: 1px solid #eee; }
        .stamp.active { background: var(--primary); color: white; border-color: var(--primary); animation: pop 0.5s ease; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="no-select">

    <!-- í•‘í¬ íŒì—… -->
    <div id="customAlert" class="custom-alert">
        <div style="font-size:35px; margin-bottom:10px;">ğŸŒ¸</div>
        <div id="alertTitle" style="font-size:18px; font-weight:800; color:#D6336C; margin-bottom:10px;">ì•Œë¦¼</div>
        <div id="alertMsg" style="margin-bottom:20px; font-weight:700; color:#666; word-break: keep-all; line-height:1.5;">ë©”ì‹œì§€</div>
        <button onclick="closeAlert()" class="btn-pretty btn-ok">í™•ì¸í–ˆì–´ìš”</button>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo" onclick="renderTab('home')">Jahyu Letter</div>
        <div class="header-right" id="headerIcons"></div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="app-container"></div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ -->
    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="renderTab('home')"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item" id="nav-letter" onclick="renderTab('letter')"><i class="fas fa-envelope-open-text"></i>ë ˆí„°</div>
        <div class="nav-item" id="nav-mood" onclick="renderTab('mood')"><i class="fas fa-calendar-alt"></i>ë¬´ë“œ</div>
        <div class="nav-item" id="nav-challenge" onclick="renderTab('challenge')"><i class="fas fa-running"></i>ì±Œë¦°ì§€</div>
        <div class="nav-item" id="nav-mypage" onclick="renderTab('mypage')"><i class="fas fa-user-circle"></i>ë§ˆì´</div>
    </nav>

    <!-- FAB -->
    <div id="fab" class="fab" onclick="openWriteModal()"><i class="fas fa-pen"></i></div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="write-box">
            <h3 style="text-align:center; color:var(--primary); margin-bottom:20px;">ê¸°ë¡ ë‚¨ê¸°ê¸° âœï¸</h3>
            
            <div id="letterOptions" class="hidden">
                <select id="postCategory" class="pink-input">
                    <option value="ê³µì§€ì‚¬í•­">ğŸ“¢ ê³µì§€ì‚¬í•­</option>
                    <option value="ìíœ´ë ˆí„°">ğŸ’Œ ìíœ´ë ˆí„°</option>
                    <option value="ìíœ´ë©">ğŸ”¬ ìíœ´ë©</option>
                    <option value="ì—ë””í„°í†¡">ğŸ’¬ ì—ë””í„°í†¡</option>
                </select>
                <input type="text" id="linkUrl" class="pink-input" placeholder="ğŸ”— ì—°ê²°í•  ë§í¬ (http://...)">
                <input type="text" id="linkText" class="pink-input" placeholder="ë²„íŠ¼ ì´ë¦„ (ì˜ˆ: ë³´ëŸ¬ê°€ê¸°)">
            </div>

            <div id="challengeOptions" class="hidden">
                <label style="font-size:12px; color:#888;">ì‹œì‘ì¼</label>
                <input type="date" id="chStartDate" class="pink-input">
                <label style="font-size:12px; color:#888;">ì¢…ë£Œì¼</label>
                <input type="date" id="chEndDate" class="pink-input">
                <input type="number" id="chStampReward" class="pink-input" value="5" placeholder="ì„±ê³µ ì‹œ ìŠ¤íƒ¬í”„ ë³´ìƒ">
            </div>

            <div id="moodOptions" class="hidden" style="margin-bottom:15px; overflow-x:auto; white-space:nowrap;">
                <!-- ì´ëª¨ì§€ JS ë¡œë“œ -->
            </div>

            <input type="text" id="postTitle" class="pink-input" placeholder="ì œëª©">
            <textarea id="postContent" class="pink-input" style="height:120px; resize:none;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            
            <div onclick="document.getElementById('fileInput').click()" style="padding:15px; border:2px dashed #FFD1DC; border-radius:15px; text-align:center; color:#D66D75; cursor:pointer; margin:15px 0; font-size:13px;">
                <i class="fas fa-camera"></i> ì‚¬ì§„ ì¶”ê°€
            </div>
            <input type="file" id="fileInput" hidden accept="image/*">

            <button onclick="submitPost()" class="btn-pretty btn-ok">ë“±ë¡í•˜ê¸°</button>
            <button onclick="closeModal()" class="btn-pretty btn-no">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="write-box" style="text-align:center;">
            <div style="font-family:'Dancing Script'; font-size:40px; color:var(--primary); margin-bottom:10px;">Jahyu Letter</div>
            <p style="color:#aaa; margin-bottom:30px;">ë‹¹ì‹ ì„ ìœ„í•œ ì‰¼í‘œ ğŸŒ¿</p>
            <input type="email" id="email" class="pink-input" placeholder="ì´ë©”ì¼">
            <input type="password" id="pw" class="pink-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="doLogin()" class="btn-pretty btn-ok">ë‚˜ë§Œì˜ ì‰¼í„° ì…ì¥í•˜ê¸°</button>
            <button onclick="doSignup()" class="btn-pretty btn-no">ì²˜ìŒ ì˜¤ì…¨ë‚˜ìš”? (íšŒì›ê°€ì…)</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="adminManageModal" class="modal-overlay">
        <div class="write-box">
            <h3>ğŸ‘‘ ê´€ë¦¬ì ê´€ë¦¬</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="email" id="newAdminEmail" class="pink-input" placeholder="ì´ë©”ì¼ ì…ë ¥" style="margin-bottom:0;">
                <button onclick="addNewAdmin()" class="btn-pretty btn-ok" style="width:80px; margin-top:0;">ì¶”ê°€</button>
            </div>
            <div id="adminList" style="max-height:200px; overflow-y:auto;"></div>
            <button onclick="document.getElementById('adminManageModal').style.display='none'" class="btn-pretty btn-no">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, orderBy, updateDoc, deleteDoc, arrayUnion, arrayRemove, setDoc, where, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ í‚¤ê°’ ì…ë ¥ í•„ìˆ˜ ğŸ”´
        const firebaseConfig = {
            // ... ì—¬ê¸°ì— í–…ì‚ë‹˜ í‚¤ê°’ ë³µë¶™ ...
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isAdmin = false;
        let isSuperAdmin = false;
        let currentTab = 'home';
        let currentChallengeId = null; // ì¸ì¦ ì‹œ ì‚¬ìš©í•  ì±Œë¦°ì§€ ID
        const SUPER_ADMIN = 'hyeran5382@naver.com';
        const MOODS = ['ğŸ˜Š','ğŸ¥°','ğŸ˜Œ','ğŸ˜­','ğŸ˜¡','ğŸ˜´','ğŸ¤©','ğŸ¤”','ğŸ¥º','ğŸ”¥','â˜”','ğŸ€'];

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMsg').innerHTML = msg;
            document.getElementById('customAlert').style.display = 'block';
        };
        window.closeAlert = () => document.getElementById('customAlert').style.display = 'none';
        window.closeModal = () => document.getElementById('writeModal').style.display = 'none';

        async function checkIsAdmin(email) {
            if(email === SUPER_ADMIN) return true;
            try {
                const docRef = doc(db, "admins", email);
                const docSnap = await getDoc(docRef);
                return docSnap.exists();
            } catch(e) { return false; }
        }

        window.doLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value); }
            catch(e) { showAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨", "ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"); }
        };
        window.doSignup = async () => {
            const nick = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if(!nick) return;
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value);
                await updateProfile(cred.user, { displayName: nick });
                await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, name: nick, stamps: 0 });
                if(cred.user.email === SUPER_ADMIN) await setDoc(doc(db, "admins", cred.user.email), { role: 'super' });
                showAlert("í™˜ì˜í•©ë‹ˆë‹¤!", "ê°€ì…ì´ ì™„ë£Œë˜ì—ˆì–´ìš” ğŸŒ¸");
            } catch(e) { showAlert("ì˜¤ë¥˜", "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤."); }
        };
        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        // íƒ­ ë Œë”ë§
        window.renderTab = (tab) => {
            currentTab = tab;
            const container = document.getElementById('appContainer');
            const headerRight = document.getElementById('headerIcons');
            container.innerHTML = '';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`)?.classList.add('active');

            if(headerRight) {
                if(tab === 'home') headerRight.innerHTML = '';
                else headerRight.innerHTML = `<i class="fas fa-arrow-right back-icon" onclick="renderTab('home')"></i>`;
            }

            // FAB ì œì–´
            const fab = document.getElementById('fab');
            if(tab === 'mood') fab.style.display = 'flex';
            else if(isAdmin && (tab === 'letter' || tab === 'challenge')) fab.style.display = 'flex';
            else fab.style.display = 'none';

            if (tab === 'home') {
                container.innerHTML = `
                    <div class="home-section">
                        <div class="greeting">
                            <h2>${currentUser.displayName}ë‹˜, ì˜¤ëŠ˜ ë§ˆìŒì€ ì–´ë•Œìš”?</h2>
                            <p>ìíœ´ë ˆí„°ì™€ í•¨ê»˜ ì ì‹œ ì‰¬ì–´ê°€ì„¸ìš” ğŸŒ¿</p>
                        </div>
                        <div class="hero-card">
                            <div style="font-size:18px; font-weight:700;">ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì‰¼ ìœ í˜•ì€?</div>
                            <div style="font-size:13px; margin-top:5px;">íë§ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸° ğŸ‘‰</div>
                        </div>
                        <div class="quick-menu">
                            <div class="quick-item" onclick="renderTab('letter')"><div class="quick-icon icon-1"><i class="fas fa-envelope-open-text"></i></div><span class="quick-text">ë ˆí„°</span></div>
                            <div class="quick-item" onclick="renderTab('challenge')"><div class="quick-icon icon-2"><i class="fas fa-running"></i></div><span class="quick-text">ì±Œë¦°ì§€</span></div>
                            <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn/111753149')"><div class="quick-icon icon-3"><i class="fas fa-pen-nib"></i></div><span class="quick-text">ë¬¸ì¥ìˆ˜ì§‘</span></div>
                            <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn')"><div class="quick-icon icon-4"><i class="fas fa-comments"></i></div><span class="quick-text">ì±„íŒ…</span></div>
                        </div>
                    </div>
                `;
            }
            else if (tab === 'letter') {
                container.innerHTML = `
                    <div style="padding:20px;">
                        <h2 style="color:var(--primary); text-align:center;">Archive</h2>
                        <div class="archive-tabs">
                            <div class="tab-btn active" onclick="fetchPosts('all', 'letterList', this)">ì „ì²´</div>
                            <div class="tab-btn" onclick="fetchPosts('ê³µì§€ì‚¬í•­', 'letterList', this)">ê³µì§€ì‚¬í•­</div>
                            <div class="tab-btn" onclick="fetchPosts('ìíœ´ë ˆí„°', 'letterList', this)">ìíœ´ë ˆí„°</div>
                            <div class="tab-btn" onclick="fetchPosts('ìíœ´ë©', 'letterList', this)">ìíœ´ë©</div>
                        </div>
                        <div id="letterList" class="card-list">ë¡œë”©ì¤‘...</div>
                    </div>
                `;
                fetchPosts('all', 'letterList');
            }
            else if (tab === 'challenge') {
                container.innerHTML = `
                    <div class="challenge-header">
                        <h3>í•¨ê»˜í•˜ëŠ” ë¦¬ì¶”ì–¼ ğŸƒâ€â™€ï¸</h3>
                        <p style="font-size:13px; color:#888;">í•¨ê»˜í•˜ë©´ ë” ë©€ë¦¬ ê°ˆ ìˆ˜ ìˆì–´ìš”.<br>ì¸ì¦ìƒ·ìœ¼ë¡œ ì„œë¡œì˜ ë¦¬ì¶”ì–¼ì„ ì‘ì›í•´ìš” ğŸ™Œ</p>
                        <div class="challenge-tip">âœ¨ Tip: ê¸°ê°„ ë‚´ 100% ë‹¬ì„± ì‹œ ìŠ¤íƒ¬í”„ 5ê°œ ì ë¦½!</div>
                        <div class="archive-tabs" style="margin-top:20px;">
                            <div class="tab-btn active" onclick="fetchChallenges('ongoing', this)">ì§„í–‰ì¤‘</div>
                            <div class="tab-btn" onclick="fetchChallenges('upcoming', this)">ì˜ˆì •</div>
                            <div class="tab-btn" onclick="fetchChallenges('ended', this)">ì¢…ë£Œ</div>
                        </div>
                    </div>
                    <div id="challengeList" class="card-list"></div>
                `;
                fetchChallenges('ongoing');
            }
            else if (tab === 'mood') {
                container.innerHTML = `
                    <div class="mood-header">
                        <h2>My Mood Log</h2>
                        <p style="font-size:13px; color:#aaa;">ì˜¤ëŠ˜ í•˜ë£¨, ì†”ì§í•œ ê°ì •ì„ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ”’</p>
                        <div style="height:20px;"></div>
                        <div id="moodCalendar" class="cal-wrap">
                            <div style="font-weight:700; margin-bottom:10px;">${new Date().getMonth()+1}ì›”</div>
                            <div id="calGrid" class="cal-grid"></div>
                        </div>
                        <button class="btn-pretty" style="background:#E3F2FD; color:#1976D2; width:auto; padding:10px 20px;" onclick="openWriteModal('mood')">ğŸ“ ì˜¤ëŠ˜ ê¸°ë¶„ ë‚¨ê¸°ê¸°</button>
                    </div>
                    <div style="padding:0 20px;">
                        <h4 style="margin-bottom:10px;">ìµœê·¼ ê¸°ë¡</h4>
                        <div id="moodList"></div>
                    </div>
                `;
                loadCalendar();
                fetchList('mood', 'moodList');
            }
            else if (tab === 'mypage') {
                renderMyPage(container);
            }
        };

        // --- ê¸€ì“°ê¸° ë¡œì§ ---
        window.openWriteModal = (forceType) => {
            const modal = document.getElementById('writeModal');
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            
            // ì˜µì…˜ ì´ˆê¸°í™”
            document.getElementById('letterOptions').classList.add('hidden');
            document.getElementById('challengeOptions').classList.add('hidden');
            document.getElementById('moodOptions').classList.add('hidden');
            document.getElementById('postTitle').classList.remove('hidden');

            if (currentTab === 'letter') {
                document.getElementById('letterOptions').classList.remove('hidden');
            } else if (currentTab === 'challenge') {
                document.getElementById('challengeOptions').classList.remove('hidden');
                document.getElementById('postTitle').placeholder = "ì±Œë¦°ì§€ ì´ë¦„";
            } else if (currentTab === 'mood' || forceType === 'mood') {
                document.getElementById('moodOptions').classList.remove('hidden');
                document.getElementById('postTitle').classList.add('hidden');
                document.getElementById('emojiList').innerHTML = MOODS.map(m => `<span style="font-size:28px; margin:5px; cursor:pointer;" onclick="selectEmoji('${m}')">${m}</span>`).join('');
            }
            // ì±Œë¦°ì§€ ì¸ì¦
            if(forceType === 'certify') {
                document.getElementById('postTitle').value = "ì±Œë¦°ì§€ ì¸ì¦";
                document.getElementById('postTitle').disabled = true;
            }

            modal.style.display = 'flex';
        };

        let selectedEmoji = null;
        window.selectEmoji = (m) => { selectedEmoji = m; showAlert("ì„ íƒ ì™„ë£Œ", `${m} ê¸°ë¶„ì„ ì„ íƒí–ˆì–´ìš”!`); };

        window.submitPost = async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const file = document.getElementById('fileInput').files[0];
            
            let imgStr = null;
            if(file) {
                imgStr = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(file); });
            }

            const data = {
                title: title || selectedEmoji || 'ë¬´ì œ',
                content: content,
                image: imgStr,
                date: new Date().toISOString(),
                author: currentUser.displayName,
                authorId: currentUser.uid,
                type: currentTab === 'mood' ? 'mood' : 'post',
                category: currentTab === 'letter' ? document.getElementById('postCategory').value : 'ì¼ë°˜',
                emoji: selectedEmoji,
                link: document.getElementById('linkUrl')?.value ? { url: document.getElementById('linkUrl').value, text: document.getElementById('linkText').value } : null
            };

            // ì±Œë¦°ì§€ ìƒì„±
            if(currentTab === 'challenge' && !currentChallengeId) {
                data.type = 'challenge';
                data.startDate = document.getElementById('chStartDate').value;
                data.endDate = document.getElementById('chEndDate').value;
                data.stampReward = 5; 
            }
            // ì±Œë¦°ì§€ ì¸ì¦
            else if(currentChallengeId) {
                data.type = 'certification';
                data.challengeId = currentChallengeId;
                
                // Nì¼ì°¨ ê³„ì‚° ë¡œì§ & ìŠ¤íƒ¬í”„ ë³´ìƒ
                const q = query(collection(db, "posts"), where("challengeId", "==", currentChallengeId), where("authorId", "==", currentUser.uid));
                const snap = await getDocs(q);
                const count = snap.size + 1; // ì´ë²ˆêº¼ í¬í•¨
                
                showAlert("ì¸ì¦ ì„±ê³µ!", `ğŸ‰ ${count}ì¼ì°¨ ì¸ì¦ì— ì„±ê³µí–ˆì–´ìš”!<br>ê¾¸ì¤€í•¨ì´ ë¹›ë‚˜ê³  ìˆì–´ìš” âœ¨`);
                
                // ë§Œì•½ ì±Œë¦°ì§€ ê¸°ê°„ê³¼ ì¸ì¦ íšŸìˆ˜ê°€ ê°™ë‹¤ë©´? (ì—¬ê¸°ì„  ë‹¨ìˆœí™”í•´ì„œ 5íšŒë¡œ ê°€ì •)
                if(count === 5) {
                    // ìŠ¤íƒ¬í”„ ì§€ê¸‰
                    const userRef = doc(db, "users", currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    const currentStamps = userSnap.data().stamps || 0;
                    await updateDoc(userRef, { stamps: currentStamps + 5 });
                    setTimeout(() => showAlert("ğŸ† ì±Œë¦°ì§€ ì™„ì£¼!", "ì¶•í•˜í•©ë‹ˆë‹¤! ìŠ¤íƒ¬í”„ 5ê°œê°€ ì ë¦½ë˜ì—ˆì–´ìš”!"), 2000);
                }
            }

            await addDoc(collection(db, "posts"), data);
            window.closeModal();
            currentChallengeId = null; // ì´ˆê¸°í™”
            renderTab(currentTab);
        };

        // ì±Œë¦°ì§€ ì¸ì¦í•˜ê¸° ë²„íŠ¼
        window.openCertifyModal = (chId) => {
            currentChallengeId = chId;
            openWriteModal('certify');
        };

        // ë°ì´í„° ë¡œì§ (ë‹¨ìˆœí™”: ì „ì²´ ë¶ˆëŸ¬ì™€ì„œ í•„í„°ë§)
        async function fetchPosts(filter, targetId, btnEl) {
            if(btnEl) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btnEl.classList.add('active'); }
            const target = document.getElementById(targetId);
            target.innerHTML = '';
            
            const q = query(collection(db, "posts"));
            const snap = await getDocs(q);
            let posts = [];
            snap.forEach(d => posts.push({id:d.id, ...d.data()}));
            posts.sort((a,b) => new Date(b.date) - new Date(a.date));

            posts.forEach(p => {
                if(p.type !== 'post') return;
                if(filter !== 'all' && p.category !== filter) return;
                
                const isMyPost = p.authorId === currentUser.uid || isAdmin;
                target.innerHTML += `
                    <div class="card">
                        ${isMyPost ? `<div class="more-btn" onclick="deletePost('${p.id}')">â‹®</div>` : ''}
                        ${p.image ? `<img src="${p.image}" style="width:100%; border-radius:10px; margin-bottom:10px;">` : ''}
                        <span class="card-badge ${p.category==='ê³µì§€ì‚¬í•­'?'notice':''}">${p.category}</span>
                        <div class="card-title">${p.title}</div>
                        <div class="card-meta"><span>${p.author}</span><span>${new Date(p.date).toLocaleDateString()}</span></div>
                        ${p.link ? `<a href="${p.link.url}" target="_blank" style="display:block; background:#f8f9fa; padding:10px; margin-top:10px; text-align:center; border-radius:10px; text-decoration:none; color:var(--primary); font-weight:700;">ğŸ”— ${p.link.text}</a>` : ''}
                    </div>
                `;
            });
        }

        async function fetchChallenges(status, btnEl) {
            if(btnEl) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btnEl.classList.add('active'); }
            const target = document.getElementById('challengeList');
            target.innerHTML = '';
            
            const q = query(collection(db, "posts"), where("type", "==", "challenge"));
            const snap = await getDocs(q);
            let posts = [];
            snap.forEach(d => posts.push({id:d.id, ...d.data()}));
            
            const today = new Date().toISOString().split('T')[0];
            posts = posts.filter(p => {
                if(status === 'ongoing') return p.startDate <= today && p.endDate >= today;
                if(status === 'upcoming') return p.startDate > today;
                if(status === 'ended') return p.endDate < today;
                return true;
            });

            if(posts.length === 0) target.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ì–´ìš” â˜ï¸</div>';

            posts.forEach(p => {
                target.innerHTML += `
                    <div class="challenge-card">
                        ${p.image ? `<img src="${p.image}" class="ch-img">` : '<div class="ch-img"></div>'}
                        <div class="ch-info">
                            <span style="background:var(--primary-soft); color:var(--primary); padding:3px 8px; border-radius:10px; font-size:11px; font-weight:700;">${p.startDate}~${p.endDate}</span>
                            <div class="ch-title">${p.title}</div>
                            <button class="btn-pretty btn-ok" onclick="openCertifyModal('${p.id}')">ğŸ“· ì¸ì¦í•˜ê¸°</button>
                        </div>
                    </div>
                `;
            });
        }

        async function loadCalendar() {
            const grid = document.getElementById('calGrid');
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            const lastDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            
            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const map = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === today.getMonth()) map[date.getDate()] = d.data().emoji;
            });

            for(let i=1; i<=lastDate; i++) {
                grid.innerHTML += `<div class="day-cell ${i===today.getDate()?'today':''}"><span style="position:absolute; top:3px; left:5px;">${i}</span><span class="day-emoji">${map[i]||''}</span></div>`;
            }
        }

        // ë§ˆì´í˜ì´ì§€
        async function renderMyPage(container) {
            const userSnap = await getDoc(doc(db, "users", currentUser.uid));
            const userData = userSnap.data() || { stamps: 0 };
            
            container.innerHTML = `
                <div style="padding:40px 20px; text-align:center;">
                    <h3>${currentUser.displayName}ë‹˜ ${isAdmin?'<span class="admin-badge">ê´€ë¦¬ì</span>':''}</h3>
                    <p style="color:#aaa; font-size:13px;">${currentUser.email}</p>
                </div>
                <div class="stamp-board">
                    <h4>ë‚˜ì˜ ìŠ¤íƒ¬í”„ ğŸ¾</h4>
                    <div id="stampGrid" class="stamp-grid"></div>
                </div>
                <div style="padding:0 20px;">
                    <div class="card" style="padding:0;">
                        <div class="menu-item" style="padding:15px; border-bottom:1px solid #eee;" onclick="alert('êµ¬í˜„ì˜ˆì •')">ğŸ“ ë‚´ê°€ ì“´ ê¸€</div>
                        <div class="menu-item" style="padding:15px; border-bottom:1px solid #eee;" onclick="alert('êµ¬í˜„ì˜ˆì •')">ğŸ’¬ ë‚´ê°€ ì“´ ëŒ“ê¸€</div>
                        <div class="menu-item" style="padding:15px;" onclick="alert('êµ¬í˜„ì˜ˆì •')">ğŸ”– ë¶ë§ˆí¬</div>
                    </div>
                    <button class="btn-pretty btn-no" onclick="handleLogout()" style="color:#FF6B6B;">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            `;
            
            const grid = document.getElementById('stampGrid');
            for(let i=1; i<=30; i++) {
                grid.innerHTML += `<div class="stamp ${i<=userData.stamps?'active':''}">${i}</div>`;
            }
        }

        // ê´€ë¦¬ì ê´€ë¦¬
        window.openAdminModal = async () => {
            document.getElementById('adminManageModal').style.display = 'flex';
            const list = document.getElementById('adminList');
            list.innerHTML = 'ë¡œë”©ì¤‘...';
            const q = query(collection(db, "admins"));
            const snap = await getDocs(q);
            list.innerHTML = '';
            snap.forEach(d => {
                list.innerHTML += `<div class="admin-item"><span>${d.id}</span><span class="del-btn" onclick="removeAdmin('${d.id}')">ì‚­ì œ</span></div>`;
            });
        };
        window.addNewAdmin = async () => {
            const email = document.getElementById('newAdminEmail').value;
            if(email) {
                await setDoc(doc(db, "admins", email), { addedBy: currentUser.email });
                openAdminModal();
            }
        };
        window.removeAdmin = async (email) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "admins", email));
                openAdminModal();
            }
        };

        window.deletePost = async (id) => {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await deleteDoc(doc(db, "posts", id));
                renderTab(currentTab);
            }
        }

        // ì•± ì‹œì‘
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAdmin = await checkIsAdmin(user.email);
                document.getElementById('authModal').style.display = 'none';
                renderTab('home');
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>