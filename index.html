<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jahyu Letter</title>
    
    <!-- í°íŠ¸ ë° ì•„ì´ì½˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #9D76C1; 
            --primary-dark: #7B52A9; /* ë°¸ëŸ°ìŠ¤ê²Œì„ Bë²„íŠ¼ìš© */
            --primary-light: #F3E5F5;
            --bg-body: #FFFEF5;
            --white: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border: #EAEAEA; 
            --pink-popup: #FFF0F5;
            --badge-editor: #9D76C1;
            --badge-new: #FF8A80;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--bg-body); padding-bottom: 100px; padding-top: 60px; position: relative; }
        .clickable { cursor: pointer; transition: transform 0.1s, opacity 0.1s; }
        .clickable:active { transform: scale(0.96); opacity: 0.8; }

        /* í—¤ë” */
        .header { position: fixed; top: 0; width: 100%; max-width: 480px; height: 60px; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 9000; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'Dancing Script', cursive; font-size: 26px; color: var(--primary); font-weight: 700; cursor: pointer; }
        .home-btn { position: absolute; right: 20px; font-size: 20px; color: #888; cursor: pointer; }

        /* ê¸€ì“°ê¸° ë²„íŠ¼ (ìµœìƒë‹¨ ë°°ì¹˜) */
        .fab { 
            position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; 
            background: #333; border-radius: 50%; color: white; 
            display: none; align-items: center; justify-content: center; 
            font-size: 22px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            z-index: 10000; /* ë¬´ì¡°ê±´ ë§¨ ìœ„ */
            cursor: pointer;
        }
        .fab.show { display: flex !important; }

        /* ë²¤í†  ê·¸ë¦¬ë“œ */
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px; }
        .bento-item { background: var(--white); border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between; min-height: 120px; }
        .bento-full { grid-column: span 2; background: linear-gradient(135deg, #B39CD0 0%, #E6E6FA 100%); color: white; border: none; }
        .bento-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; color: var(--text-main); }
        .bento-full .bento-title { color: white; }
        .bento-desc { font-size: 12px; color: var(--text-sub); line-height: 1.4; }
        .bento-full .bento-desc { color: rgba(255,255,255,0.95); }
        .bento-icon { font-size: 32px; align-self: flex-end; margin-top: 10px; }

        /* ì¹´ë“œ & ë²„íŠ¼ */
        .card { background: var(--white); border-radius: 18px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid var(--border); margin-bottom: 15px; }
        .section-header { font-size: 18px; font-weight: 700; margin-bottom: 15px; padding: 0 20px; color: #444; }
        .pill-container { display: flex; gap: 8px; margin: 15px 0; justify-content: center; }
        .pill-btn { flex: 1; padding: 12px 5px; border-radius: 50px; border: 1px solid var(--primary-light); background: white; color: var(--primary); font-size: 12px; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .pill-btn:hover { background: var(--primary-light); transform: translateY(-2px); }
        .btn-main { width: 100%; padding: 14px; border-radius: 15px; border: none; font-weight: 700; font-size: 15px; margin-top: 10px; cursor: pointer; background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(157, 118, 193, 0.4); }
        .btn-sub { background: #f5f5f5; color: #666; width: 100%; padding: 12px; border-radius: 15px; border: 1px solid #eee; font-weight: 600; margin-top: 5px; cursor: pointer; }

        /* ìº˜ë¦°ë” */
        .cal-container { background: var(--white); border-radius: 20px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; margin-bottom: 15px; color: #555; }
        .cal-nav-btn { cursor: pointer; padding: 5px 10px; color: #888; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-cell { aspect-ratio: 1/1; border-radius: 12px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #ccc; position: relative; cursor: pointer; }
        .day-cell.today { border: 2px solid var(--primary); background: #fff; color: var(--primary); font-weight: 700; }
        .day-emoji { font-size: 24px; position: absolute; margin-top:-2px; }

        /* ì—ë””í„° */
        .editor-container { display: flex; justify-content: space-between; padding: 0 10px; margin-bottom: 20px; }
        .editor-item { display: flex; flex-direction: column; align-items: center; width: 19%; cursor: pointer; }
        .editor-circle { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 8px; transition: 0.2s; background-color: #fff; font-size: 28px; }
        .editor-circle.active { border-color: var(--primary); transform: scale(1.1); }
        .editor-name { font-size: 11px; font-weight: 600; text-align: center; color: #555; }

        /* íŒì—… */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .popup-box { background: var(--pink-popup); width: 85%; max-width: 340px; padding: 30px 25px; border-radius: 30px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.15); border: 4px solid #fff; position: relative; }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 480px; height: 80px; background: rgba(255,255,255,0.98); border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 9000; padding-bottom: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
        .nav-item { color: #bbb; text-align: center; font-size: 10px; font-weight: 500; width: 20%; display: flex; flex-direction: column; align-items: center; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; }
        .nav-item.active { color: var(--primary); font-weight: 700; transform: translateY(-3px); }

        /* ìŠ¤íƒ¬í”„ Grid */
        .stamp-grid { display: grid !important; grid-template-columns: repeat(5, 1fr) !important; gap: 10px; margin: 20px 0; }
        .stamp-slot { aspect-ratio: 1/1; background: #F0F0F0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #bbb; position: relative; border: 1px solid #eee; }
        .stamp-slot.active { background: var(--primary); color: white; box-shadow: 0 3px 8px rgba(157, 118, 193, 0.4); font-weight: 700; border: none; }
        .gift-box { position: absolute; right: -3px; bottom: -3px; background: white; border-radius: 50%; padding: 2px; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ë¦¬ì›Œë“œ ë°•ìŠ¤ */
        .reward-box { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 8px; text-align: left; display: flex; align-items: center; gap: 10px; }
        .reward-icon { font-size: 24px; background: #FFF9C4; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .reward-text { font-size: 13px; color: #444; font-weight: 600; }
        .reward-sub { font-size: 11px; color: #888; font-weight: 400; margin-top: 2px; }

        .hidden { display: none !important; }
        .badge-editor { background: var(--badge-editor); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; margin-left: 5px; vertical-align: middle; font-weight: 400; }
        .badge-notice { background: #FF8A80; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        
        .admin-list-item { background:white; padding:10px; margin-bottom:5px; border-radius:10px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; text-align:left; font-size:13px; }
        .input-popup { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; outline: none; }
        .empathy-bar { display: flex; gap: 8px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .empathy-btn { flex: 1; padding: 8px; border-radius: 12px; background: #fafafa; border: 1px solid #eee; font-size: 11px; color: #666; }
    </style>
</head>
<body>

    <!-- ğŸŒ¸ ì•Œë¦¼ íŒì—… -->
    <div id="customAlert" class="modal-overlay" style="z-index: 12000;">
        <div class="popup-box">
            <div style="font-size:40px; margin-bottom:15px;">ğŸŒ¸</div>
            <div id="alertMsg" style="margin-bottom:20px; font-weight:600; color:#555; line-height:1.5; word-break:keep-all;">ì•Œë¦¼ ë‚´ìš©</div>
            <button onclick="window.closeAlert()" class="btn-main" id="alertBtn">í™•ì¸</button>
        </div>
    </div>

    <!-- ğŸ”‘ ì…ë ¥ íŒì—… -->
    <div id="inputModal" class="modal-overlay" style="z-index: 11500;">
        <div class="popup-box">
            <h3 id="inputTitle" style="margin-bottom:15px; color:var(--primary);">ì…ë ¥í•´ì£¼ì„¸ìš”</h3>
            <input type="text" id="popupInput" class="input-popup">
            <button id="inputConfirmBtn" class="btn-main">í™•ì¸</button>
            <button onclick="document.getElementById('inputModal').style.display='none'" class="btn-sub">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo clickable" onclick="window.renderTab('home')">Jahyu Letter</div>
        <div class="home-btn" onclick="window.renderTab('home')"><i class="fas fa-home"></i></div>
    </header>

    <div id="appContainer" class="app-container"></div>

    <nav class="bottom-nav">
        <div class="nav-item clickable" onclick="window.renderTab('home')"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item clickable" onclick="window.renderTab('letter')"><i class="fas fa-envelope-open-text"></i>ë ˆí„°</div>
        <div class="nav-item clickable" onclick="window.renderTab('mood')"><i class="fas fa-calendar-check"></i>ë¬´ë“œ</div>
        <div class="nav-item clickable" onclick="window.renderTab('editor')"><i class="fas fa-comment-dots"></i>ìíœ´ë©”ì´íŠ¸</div>
        <div class="nav-item clickable" onclick="window.renderTab('mypage')"><i class="fas fa-user"></i>ë§ˆì´</div>
    </nav>

    <!-- âœï¸ ê¸€ì“°ê¸° ë²„íŠ¼ (z-index ìµœìƒìœ„) -->
    <div id="fab" class="fab clickable" onclick="window.openWriteModal()"><i class="fas fa-pen"></i></div>

    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="popup-box">
            <h2 style="font-family:'Dancing Script'; color:var(--primary); margin-bottom:10px; font-size:32px;">Jahyu</h2>
            <p style="color:#888; margin-bottom:25px; font-size:14px;">ë©”ë§ˆë¥¸ ì¼ìƒì„ ì´‰ì´‰í•˜ê²Œ ğŸ’§</p>
            
            <div id="loginForm">
                <input type="email" id="authEmail" class="btn-sub" style="background:white; text-align:left;" placeholder="ì´ë©”ì¼">
                <input type="password" id="authPw" class="btn-sub" style="background:white; text-align:left;" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button onclick="window.doLogin()" class="btn-main" id="loginBtn">ë¡œê·¸ì¸</button>
                <button onclick="window.toggleSignupMode()" class="btn-sub">íšŒì›ê°€ì…</button>
                <p onclick="window.resetPw()" style="font-size:12px; color:#aaa; margin-top:15px; cursor:pointer; text-decoration:underline;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</p>
            </div>

            <div id="signupForm" class="hidden">
                <h4 style="margin-bottom:15px; color:#666;">íšŒì›ê°€ì…</h4>
                <input type="text" id="regNick" class="btn-sub" style="background:white; text-align:left;" placeholder="ë‹‰ë„¤ì„">
                <input type="email" id="regEmail" class="btn-sub" style="background:white; text-align:left;" placeholder="ì´ë©”ì¼">
                <input type="password" id="regPw" class="btn-sub" style="background:white; text-align:left;" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)">
                <button onclick="window.doSignup()" class="btn-main">ê°€ì… ì™„ë£Œ</button>
                <button onclick="window.toggleSignupMode()" class="btn-sub">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="popup-box" style="text-align:left; max-width:400px; width:90%;">
            <h3 id="modalTitle" style="text-align:center; color:#555; margin-bottom:20px;">ê¸°ë¡í•˜ê¸°</h3>
            
            <div id="moodForm" class="hidden">
                <div id="emojiList" style="display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:15px;"></div>
                <textarea id="moodContent" class="btn-sub" style="background:white; height:80px; text-align:left; resize:none;" placeholder="ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?"></textarea>
            </div>

            <div id="adminForm" class="hidden">
                <select id="postType" class="btn-sub" style="background:white;">
                    <option value="editor">â˜•ï¸ ì—ë””í„°í†¡</option>
                    <option value="letter">ğŸ’Œ ë ˆí„°</option>
                    <option value="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</option>
                </select>
                <input type="text" id="postTitle" class="btn-sub" style="background:white; text-align:left;" placeholder="ì œëª© (ì—ë””í„°í†¡ì€ ì—ë””í„° ë‹‰ë„¤ì„)">
                <textarea id="postContent" class="btn-sub" style="background:white; height:100px; text-align:left; resize:none;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-top:10px; border:1px solid #eee;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">ğŸ”— ì—°ê²° ë§í¬ (ì„ íƒ)</div>
                    <input type="text" id="postUrl" class="btn-sub" style="background:white; text-align:left; margin-top:0;" placeholder="https://...">
                    <input type="text" id="btnText" class="btn-sub" style="background:white; text-align:left;" placeholder="ë²„íŠ¼ ì´ë¦„ (ì˜ˆ: ë³´ëŸ¬ê°€ê¸°)">
                </div>
            </div>

            <button onclick="window.submitPost()" class="btn-main">ë“±ë¡í•˜ê¸°</button>
            <button onclick="window.closeModal()" class="btn-sub">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
    <div id="adminDashboardModal" class="modal-overlay">
        <div class="popup-box" style="text-align:left; max-height:80vh; overflow-y:auto;">
            <h3 style="text-align:center;">ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
            
            <div id="superAdminSection" class="hidden" style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h4 style="margin-bottom:5px;">ê´€ë¦¬ì ê¶Œí•œ ê´€ë¦¬</h4>
                <div style="display:flex; gap:5px;">
                    <input type="email" id="adminEmailInput" class="btn-sub" style="background:white; flex:1;" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    <button onclick="window.adminAction('add')" class="btn-main" style="width:auto; margin-top:5px;">ì¶”ê°€</button>
                </div>
                <h4 style="margin-top:15px; margin-bottom:5px;">ì „ì²´ ì‚¬ìš©ì ëª©ë¡</h4>
                <button onclick="window.loadAllUsers()" class="btn-sub" style="margin-bottom:10px;">ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <div id="allUserList" style="max-height:150px; overflow-y:auto; background:#f9f9f9; padding:10px; border-radius:10px; font-size:12px;"></div>
            </div>

            <div style="margin-bottom:20px;">
                <h4 style="margin-bottom:10px;">íœ´ì‹ë°¸ëŸ°ìŠ¤ / ìíœ´ì¿ í‚¤ ê´€ë¦¬</h4>
                <select id="manageContentType" class="btn-sub" style="background:white; margin-bottom:10px;" onchange="window.loadContentList()">
                    <option value="balance">âš–ï¸ íœ´ì‹ ë°¸ëŸ°ìŠ¤</option>
                    <option value="cookie">ğŸ¥  ìíœ´ ì¿ í‚¤</option>
                </select>
                
                <div id="balanceInputArea">
                    <input type="text" id="mBalQ" class="btn-sub" style="background:white;" placeholder="ì§ˆë¬¸ (ì˜ˆ: ì£¼ë§ì—”?)">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="mBalA" class="btn-sub" style="background:white;" placeholder="ì„ íƒ A">
                        <input type="text" id="mBalB" class="btn-sub" style="background:white;" placeholder="ì„ íƒ B">
                    </div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="mBalAMsg" class="btn-sub" style="background:white;" placeholder="A ë©˜íŠ¸">
                        <input type="text" id="mBalBMsg" class="btn-sub" style="background:white;" placeholder="B ë©˜íŠ¸">
                    </div>
                </div>
                <div id="cookieInputArea" class="hidden">
                    <input type="text" id="mCookieMsg" class="btn-sub" style="background:white;" placeholder="ìœ„ë¡œ ë¬¸êµ¬ ì…ë ¥">
                </div>
                <button onclick="window.addContentItem()" class="btn-main" style="padding:10px; margin-bottom:15px;">ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button>

                <div id="contentListArea" style="max-height:150px; overflow-y:auto; background:#f9f9f9; padding:10px; border-radius:10px;"></div>
            </div>

            <button onclick="document.getElementById('adminDashboardModal').style.display='none'" class="btn-sub">ë‹«ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTab = 'home';
        let isAdmin = false;
        let isSuperAdmin = false;
        let selectedEmoji = null;
        let currentEditorFilter = null;
        let currentLetterFilter = 'all';
        let currentMoodDate = new Date(); // ìº˜ë¦°ë” ë‚ ì§œ ìƒíƒœ

        // ê´€ë¦¬ì ëª©ë¡
        let ADMIN_EMAILS = ['hyeran5382@naver.com', 'happci@test.com', 'gocal@test.com', 'yudan@test.com', 'sunny@test.com', 'elly@test.com'];
        const SUPER_ADMIN = 'hyeran5382@naver.com';

        // ì—ë””í„° ìºë¦­í„°
        const EDITORS = [
            { id: 'happci', name: 'í–…ì”¨', icon: 'âœï¸' },
            { id: 'gocal', name: 'ê³ ì¹¼', icon: 'ğŸª´' },
            { id: 'elly', name: 'ì—˜ë¦¬', icon: 'ğŸ¥¯' },
            { id: 'yudan', name: 'ìœ ë‹¨', icon: 'âš½' },
            { id: 'sunny', name: 'ì¨ë‹ˆ', icon: 'ğŸª' }
        ];

        // ê¸°ë³¸ ë°ì´í„°
        let COOKIE_MSGS = ["ì ì‹œ ë©ˆì¶°ë„ ê´œì°®ì•„ìš”.", "ë‹¹ì‹ ì˜ ì†ë„ëŠ” í‹€ë¦¬ì§€ ì•Šì•˜ì–´ìš”."];
        let BALANCE_GAMES = [{ q: "ì£¼ë§ì—”?", a: "ì§‘ì½•", b: "ì™¸ì¶œ", aMsg: "ì§‘ì´ ìµœê³ ì£ !", bMsg: "ë‚˜ê°€ì„œ ë†€ì•„ìš”!" }];
        const MOODS = ['â˜ï¸','ğŸ˜Š','ğŸ¥°','ğŸ˜­','ğŸ˜¡','ğŸ”¥','â˜”','ğŸ€','ğŸ·','ğŸ§¸','ğŸ§','ğŸ’¸','ğŸ¥‘','ğŸ§','ğŸ§˜â€â™€ï¸','ğŸ‘»','ğŸ¤§','ğŸ§¶','ğŸŒ™','ğŸ°'];

        // --- ìœ í‹¸ë¦¬í‹° ---
        window.showAlert = (msg, btnText="í™•ì¸") => {
            document.getElementById('alertMsg').innerHTML = msg;
            document.getElementById('alertBtn').innerText = btnText;
            document.getElementById('customAlert').style.display = 'flex';
        };
        window.closeAlert = () => document.getElementById('customAlert').style.display = 'none';

        window.showInputPopup = (title, callback) => {
            document.getElementById('inputTitle').innerText = title;
            document.getElementById('popupInput').value = '';
            document.getElementById('inputModal').style.display = 'flex';
            document.getElementById('inputConfirmBtn').onclick = () => {
                const val = document.getElementById('popupInput').value;
                if(val) {
                    document.getElementById('inputModal').style.display = 'none';
                    callback(val);
                }
            };
        };

        window.closeModal = () => {
            document.getElementById('writeModal').style.display = 'none';
            checkFabVisibility();
        };

        function checkFabVisibility() {
            const fab = document.getElementById('fab');
            fab.classList.remove('show'); 
            if (currentTab === 'mood') {
                fab.classList.add('show');
            } else if (isAdmin && (currentTab === 'editor' || currentTab === 'letter' || currentTab === 'mypage')) {
                fab.classList.add('show');
            }
        }

        // --- íƒ­ ë Œë”ë§ ---
        window.renderTab = (tab, filter = null) => {
            currentTab = tab;
            if(tab === 'editor') currentEditorFilter = filter;
            if(tab === 'letter' && filter) currentLetterFilter = filter;
            else if(tab === 'letter') currentLetterFilter = 'all';

            window.scrollTo(0, 0);
            const container = document.getElementById('appContainer');
            container.innerHTML = '';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[onclick*="${tab}"]`);
            if (activeNav) activeNav.classList.add('active');

            checkFabVisibility();

            if (tab === 'home') renderHome(container);
            else if (tab === 'letter') renderLetter(container);
            else if (tab === 'mood') renderMood(container);
            else if (tab === 'editor') renderEditor(container);
            else if (tab === 'mypage') renderMyPage(container);
            else if (tab === 'play') renderPlay(container);
        };

        function renderHome(container) {
            container.innerHTML = `
                <div style="padding:0 20px 20px;">
                    <div class="bento-item bento-full clickable" onclick="window.open('https://index-html-zak5.vercel.app/', '_blank')" style="background:linear-gradient(135deg, #9D76C1, #F3E5F5);">
                        <div><div style="font-size:12px; opacity:0.9; margin-bottom:5px;">ë‚˜ë¥¼ ìœ„í•œ ì‰¼í‘œ ğŸŒ¿</div><div class="bento-title">ë‚˜ì—ê²Œ ë”± ë§ëŠ” íœ´ì‹ì„ ì°¾ì•„ë³´ì„¸ìš”!</div></div>
                        <div style="text-align:right; font-size:13px;">í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ ê°€ê¸° ğŸ‘‰</div>
                    </div>
                </div>
                <div class="bento-grid">
                    <div class="bento-item clickable" onclick="window.renderTab('mood')" style="background:#FFF8E1;"><div><div class="bento-title">ì˜¤ëŠ˜ì˜ ë¬´ë“œ</div><div class="bento-desc">ë§ˆìŒ ë‚ ì”¨ ê¸°ë¡í•˜ê¸°</div></div><div class="bento-icon">ğŸ¨</div></div>
                    <div class="bento-item clickable" onclick="window.renderTab('play')" style="background:#F3E5F5;"><div><div class="bento-title">í”Œë ˆì´</div><div class="bento-desc">ê°™ì´ íœ´ì‹ì„ ì¦ê²¨ìš”!</div></div><div class="bento-icon">ğŸ¡</div></div>
                    <div class="bento-item clickable" onclick="window.renderTab('letter')" style="background:#E0F2F1;"><div><div class="bento-title">ë ˆí„° ì½ê¸°</div><div class="bento-desc">ë©”ë§ˆë¥¸ ì¼ìƒì„ ì´‰ì´‰í•˜ê²Œ!</div></div><div class="bento-icon">ğŸ’Œ</div></div>
                    <div class="bento-item clickable" onclick="window.renderTab('editor')" style="background:#FFEBEE;"><div><div class="bento-title">ë‹µì¥ì„ ê¸°ë‹¤ë ¤ìš”!</div><div class="bento-desc">ì´ë²ˆ ë ˆí„°ëŠ” ì–´ë• ë‚˜ìš”?</div></div><div class="bento-icon">ğŸ’¬</div></div>
                    <div class="bento-item bento-full clickable" onclick="window.open('http://pf.kakao.com/_Jfjxgn/111753149', '_blank')" style="background:#E8F5E9;">
                        <div style="display:flex; justify-content:space-between; align-items:center;"><div><div class="bento-title" style="color:#333;">ì—ë””í„° PICK! ë¬¸ì¥ìˆ˜ì§‘</div><div class="bento-desc" style="color:#666;">ì‘ì›ì„ ê¾¹ê¾¹ ëˆŒëŸ¬ë‹´ì•˜ì–´ìš”!</div></div><div style="font-size:24px;">ğŸ”–</div></div>
                    </div>
                </div>`;
        }

        function renderLetter(container) {
            container.innerHTML = `
                <div style="padding:0 20px;">
                    <div class="card" style="text-align:center;">
                        <h3 style="margin-bottom:10px;">ì´ë²ˆ ì£¼ ë ˆí„°, ì¦ê²ê²Œ ì½ìœ¼ì…¨ë‚˜ìš”? ğŸ’•</h3>
                        <div class="pill-container">
                            <div class="pill-btn clickable" onclick="window.checkRate(25)"><i class="fas fa-heart"></i> 25%</div>
                            <div class="pill-btn clickable" onclick="window.checkRate(50)"><i class="fas fa-heart"></i> 50%</div>
                            <div class="pill-btn clickable" onclick="window.checkRate(75)"><i class="fas fa-heart"></i> 75%</div>
                            <div class="pill-btn clickable" onclick="window.checkRate(100)"><i class="fas fa-heart"></i> 100%</div>
                        </div>
                        <button onclick="window.open('https://maily.so/happci', '_blank')" class="btn-main">ë ˆí„° ë³´ëŸ¬ê°€ê¸° ğŸ’Œ</button>
                    </div>
                    <div class="section-header">ì˜¤ëŠ˜ ë‚˜ì—ê²Œ í•„ìš”í•œ íœ´ì‹ì€?</div>
                    <div id="letterList" class="card-list"></div>
                </div>`;
            window.fetchPosts('letter', 'letterList');
        }

        window.checkRate = (rate) => {
            let msg = "";
            if(rate === 25) msg = "ì˜¤~ ì´ë²ˆì£¼ ë ˆí„°ë¥¼ ì½ê¸° ì‹œì‘í•˜ì…¨êµ°ìš”!<br>íë§ ê°€ë“ ë°›ì•„ê°€ì„¸ìš”! :)";
            else if(rate === 50) msg = "ìš°ì™€~ ë²Œì¨ ë°˜ì´ë‚˜ ì½ì—ˆì–´ìš”!<br>íë§ì—ë„ˆì§€ê°€ ì°¨ì˜¤ë¥´ëŠ” ì¤‘ì…ë‹ˆë‹¤! ğŸŒ¿";
            else if(rate === 75) msg = "ìíœ´ë ˆí„°ì˜ ì° íŒ¬ì´ì‹œêµ°ìš”!<br>í–…ì‚ë‹˜ ì‚¬ë‘í•©ë‹ˆë‹¤ â¤ï¸";
            else msg = "ì¶•í•˜í•´ìš”! ì™„ë… ì„±ê³µ! âœ¨<br>ìŠ¤íƒ¬í”„ ë¯¸ì…˜ì—ë„ ë„ì „í•´ ë³¼ê¹Œìš”?<br>(ìíœ´ë ˆí„° VIPê°€ ë  ìˆ˜ ìˆì–´ìš”!)";
            window.showAlert(msg, "ì—ë„ˆì§€ ì¶©ì „ ì™„ë£Œ! âœ¨");
        };

        function renderMood(container) {
            container.innerHTML = `
                <div style="padding:0 20px;">
                    <div class="section-header">ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?</div>
                    <div class="cal-container" id="moodCapture">
                        <div class="cal-header">
                            <i class="fas fa-chevron-left cal-nav-btn" onclick="window.changeMonth(-1)"></i>
                            <span id="calTitle">Mood Log</span>
                            <i class="fas fa-chevron-right cal-nav-btn" onclick="window.changeMonth(1)"></i>
                        </div>
                        <div class="cal-grid" style="margin-bottom:10px; font-size:12px; color:#888;"><div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
                        <div id="calGrid" class="cal-grid"></div>
                    </div>
                    <button onclick="window.saveImage('moodCapture')" class="btn-sub" style="margin-bottom:20px;"><i class="fas fa-download"></i> ìº˜ë¦°ë” ì´ë¯¸ì§€ ì €ì¥</button>
                    <div class="section-header">ì§€ë‚œ ì´ì•¼ê¸°ë“¤</div>
                    <div id="moodList"></div>
                    <button onclick="window.fetchPosts('mood', 'moodList', 100)" class="btn-sub">ì´ì „ ê¸°ë¡ ë”ë³´ê¸°</button>
                </div>`;
            window.loadCalendar();
            window.fetchPosts('mood', 'moodList', 5);
        }

        window.changeMonth = (delta) => {
            currentMoodDate.setMonth(currentMoodDate.getMonth() + delta);
            window.loadCalendar();
        };

        function renderEditor(container) {
            let filterHtml = currentEditorFilter ? `<div style="text-align:center; margin-bottom:20px; font-size:16px; font-weight:700; color:var(--primary);">ì—ë””í„° ${currentEditorFilter}ì…ë‹ˆë‹¤! <i class="fas fa-times clickable" onclick="window.renderTab('editor')"></i></div>` : `<div style="margin-top:20px;" class="section-header">ì—ë””í„°ì˜ ì‘ì—…ì‹¤ â˜•ï¸</div>`;
            
            container.innerHTML = `
                <div style="padding:0 20px;">
                    ${currentEditorFilter ? '' : '<div class="section-header" style="margin-top:20px;">ìíœ´ ë©”ì´íŠ¸</div>'}
                    <div class="editor-container">
                        ${EDITORS.map(e => `<div class="editor-item" onclick="window.renderTab('editor', '${e.name}')"><div class="editor-circle ${currentEditorFilter === e.name ? 'active' : ''}">${e.icon}</div><div class="editor-name">${e.name}</div></div>`).join('')}
                    </div>
                    ${filterHtml}
                    <div id="editorList" class="card-list"></div>
                </div>`;
            window.fetchPosts('editor', 'editorList');
        }

        function renderMyPage(container) {
            let adminHtml = '';
            if (isSuperAdmin || isAdmin) {
                adminHtml = `<button onclick="window.openAdminDashboard()" class="btn-sub" style="margin-top:10px; background:#333; color:white;">ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</button>`;
            }

            container.innerHTML = `
                <div style="text-align:center; padding:30px 20px;">
                    <div style="width:70px; height:70px; background:#eee; border-radius:50%; margin:0 auto 10px; font-size:30px; display:flex; align-items:center; justify-content:center;">ğŸ™‚</div>
                    <h3 style="margin-bottom:5px;">${currentUser.displayName}ë‹˜${isAdmin ? ' <span class="badge-editor">ì—ë””í„°</span>' : ''}</h3>
                    <p style="font-size:13px; color:#888;">${currentUser.displayName}ë‹˜ë§Œì˜ íë§ë¡œê·¸</p>
                    ${adminHtml}
                </div>
                <div style="padding:0 20px;">
                    <div class="card">
                        <div style="font-weight:700; margin-bottom:10px;">ğŸ ë§¤ì¼ ë¬´ë“œë¥¼ ê¸°ë¡í•˜ê³  ì„ ë¬¼ì„ ë°›ì•„ê°€ì„¸ìš”!</div>
                        <div id="stampGrid" class="stamp-grid"></div>
                        <div style="background:#f9f9f9; padding:15px; border-radius:12px; font-size:12px; color:#666; line-height:1.6; margin-bottom:15px;">
                            <b>ğŸ’¡ ìŠ¤íƒ¬í”„ í˜œíƒ ì•ˆë‚´</b><br>
                            10ê°œ: ê°ì„±ê°€ë“ ë°°ê²½í™”ë©´ (ë¹„ë°€ì½”ë“œ: <b>[êµ¬ë¦„í•œì ]</b>)<br>
                            20ê°œ: íœ´ì‹ í—ˆê°€ì¦ & íë§ë¹™ê³  (ë¹„ë°€ì½”ë“œ: <b>[ë‹¬ë¹›ì‚°ì±…]</b>)<br>
                            30ê°œ: ìíœ´ë ˆí„° VIP ëª¨ë°”ì¼ ì¹´ë“œ (ë¹„ë°€ì½”ë“œ: <b>[ì˜¨ì „í•œì‰¼]</b>)<br>
                            * ìŠ¤íƒ¬í”„ë¥¼ í´ë¦­í•˜ë©´ ë¹„ë°€ì½”ë“œë¥¼ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´ìš”!
                        </div>
                        <button onclick="window.open('https://pf.kakao.com/_Jfjxgn', '_blank')" class="btn-main">ğŸ ìŠ¤íƒ¬í”„ ì¸ì¦í•˜ê³  ì„ ë¬¼ ë°›ê¸°</button>
                    </div>
                    <div class="card clickable" onclick="window.resetPw()">
                        <div style="display:flex; justify-content:space-between; color:#555;"><span>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="card clickable" onclick="window.handleLogout()">
                        <div style="display:flex; justify-content:space-between; color:#FF6B6B;"><span>ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ</span></div>
                    </div>
                </div>`;
            window.loadStamps();
        }

        function renderPlay(container) {
            const weekNum = Math.ceil((((new Date() - new Date(new Date().getFullYear(),0,1)) / 86400000) + 1)/7);
            const bg = (window.cachedBalance && window.cachedBalance.length > 0) ? window.cachedBalance[weekNum % window.cachedBalance.length] : BALANCE_GAMES[0];

            container.innerHTML = `
                <div style="padding:0 20px;">
                    <div class="section-header">ìš°ë¦¬ ê°™ì´ íœ´ì‹ì„ ì¦ê²¨ìš”!</div>
                    <div class="card">
                        <div style="font-weight:700; margin-bottom:10px;">ğŸŒª ê±±ì • íŒŒì‡„ê¸°</div>
                        <div id="shredderBox" class="shredder-box"><input type="text" id="worryInput" class="btn-sub" style="background:white; text-align:left;" placeholder="ê±±ì •ì„ ì…ë ¥í•˜ì„¸ìš”..."><button onclick="window.shredWorry()" class="btn-sub" style="background:#eee;">ê°ˆì•„ë²„ë¦¬ê¸° ğŸ—‘ï¸</button></div>
                    </div>
                    <div class="card" style="text-align:center;">
                        <div style="font-weight:700; margin-bottom:15px;">âš–ï¸ íë§ ë°¸ëŸ°ìŠ¤</div>
                        <p style="font-size:14px; margin-bottom:15px;">${bg.q}</p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-main" onclick="window.showAlert('${bg.aMsg || 'ì¢‹ì€ ì„ íƒì´ì—ìš”!'}')">${bg.a}</button>
                            <button class="btn-main" style="background:var(--primary-dark); color:white;" onclick="window.showAlert('${bg.bMsg || 'ë©‹ì§„ ì„ íƒì´ì—ìš”!'}')">${bg.b}</button>
                        </div>
                    </div>
                    <div class="card clickable" onclick="window.openCookie()" style="background:#FFFDE7; border-color:#FFF9C4;">
                        <div style="display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:700;">ğŸ¥  íë§ ì¿ í‚¤ ë½‘ê¸°</div><div style="font-size:12px; margin-top:5px;">ì˜¤ëŠ˜ ë‚˜ì—ê²Œ í•„ìš”í•œ í•œ ë§ˆë””ëŠ”?</div></div><div style="font-size:30px;">âœ¨</div></div>
                    </div>
                </div>`;
        }

        // --- Logic ---
        window.fetchPosts = async (type, elId, limitNum=100) => {
            const list = document.getElementById(elId);
            list.innerHTML = '';
            let q;
            
            if(type === 'mood') {
                q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid), orderBy("date", "desc"));
            } 
            else if(type === 'editor') {
                if(currentEditorFilter) q = query(collection(db, "posts"), where("type", "==", "editor"), where("title", "==", currentEditorFilter), orderBy("date", "desc"));
                else q = query(collection(db, "posts"), where("type", "==", "editor"), orderBy("date", "desc"));
            } 
            else if(type === 'letter') {
                if(currentLetterFilter === 'notice') q = query(collection(db, "posts"), where("type", "==", "notice"), orderBy("date", "desc"));
                else q = query(collection(db, "posts"), where("type", "in", ["letter", "notice"]), orderBy("date", "desc"));
            } 
            else {
                q = query(collection(db, "posts"), where("type", "==", type), orderBy("date", "desc"));
            }

            try {
                const snap = await getDocs(q);
                if(snap.empty) {
                    if(type === 'mood' && elId === 'moodList') window.showAlert("ì•„ì§ ê¸°ë¡ëœ ë¬´ë“œê°€ ì—†ì–´ìš”.<br>ì²« ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ¨");
                    list.innerHTML = `<div style="text-align:center; padding:30px; color:#bbb; font-size:13px;">ì•„ì§ ê¸€ì´ ì—†ì–´ìš”. ğŸƒ</div>`; return; 
                }

                let count = 0;
                snap.forEach(d => {
                    if(count >= limitNum) return;
                    const data = d.data();
                    const date = new Date(data.date).toLocaleDateString();
                    const isNew = (new Date() - new Date(data.date)) / (1000 * 60 * 60 * 24) < 7;
                    const newBadge = isNew ? '<span class="badge-new">N</span>' : '';
                    const noticeBadge = data.type === 'notice' ? '<span class="badge-notice">ê³µì§€</span> ' : '';

                    if(type === 'mood') {
                        list.innerHTML += `<div class="card" style="display:flex; gap:15px; align-items:center;"><div style="font-size:30px;">${data.emoji}</div><div><div style="font-size:12px; color:#aaa;">${date}</div><div style="font-size:14px; margin-top:2px;">${data.content}</div></div></div>`;
                    } else {
                        list.innerHTML += `
                            <div class="card">
                                <div style="font-weight:700; margin-bottom:5px;">${noticeBadge}${data.title} ${newBadge}</div>
                                <div style="font-size:14px; color:#444; line-height:1.5;">${data.content}</div>
                                ${data.url ? `<button onclick="window.open('${data.url}')" class="btn-sub" style="width:auto; padding:8px 15px; font-size:12px; margin-top:10px;">${data.btnText || 'ë³´ëŸ¬ê°€ê¸°'}</button>` : ''}
                                ${type === 'editor' ? `<div class="empathy-bar"><button class="empathy-btn">ğŸ”¥ ê³µê°</button><button class="empathy-btn">ğŸŒ¿ íë§</button><button class="empathy-btn">â˜•ï¸ ìˆ˜ê³ </button></div>` : ''}
                            </div>`;
                    }
                    count++;
                });
            } catch (e) {
                console.error("Fetch Error:", e);
                list.innerHTML = `<div style="text-align:center; padding:20px;">ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        };

        window.loadCalendar = async () => {
            const grid = document.getElementById('calGrid');
            const year = currentMoodDate.getFullYear(); 
            const month = currentMoodDate.getMonth();
            
            document.getElementById('calTitle').innerText = `${year}ë…„ ${month+1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const moods = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === month && date.getFullYear() === year) {
                    moods[date.getDate()] = { emoji: d.data().emoji, content: d.data().content };
                }
            });

            for(let i=1; i<=lastDate; i++) {
                const moodData = moods[i];
                const onClick = moodData ? `onclick="window.showMoodDetail('${moodData.content.replace(/'/g, "\\'")}')"` : '';
                grid.innerHTML += `<div class="day-cell ${moodData ? 'today' : ''}" ${onClick}><span style="position:absolute; top:2px; left:4px; font-size:9px;">${i}</span><span class="day-emoji">${moodData ? moodData.emoji : ''}</span></div>`;
            }
        };

        window.showMoodDetail = (content) => {
            window.showAlert(content, "ë‹«ê¸°");
        };

        // ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸° (ì¤‘ë³µ ì²´í¬ ì¶”ê°€)
        window.openWriteModal = async () => {
            if(currentTab === 'mood') {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const docId = `${dateStr}_${currentUser.uid}`;
                const docRef = doc(db, "posts", docId);
                
                try {
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) {
                        return window.showAlert("ì˜¤ëŠ˜ì˜ ê¸°ë¡ì€ ì´ë¯¸ ì™„ë£Œë˜ì—ˆì–´ìš”! ğŸŒ™");
                    }
                } catch(e) {
                    console.error(e);
                }

                document.getElementById('moodForm').classList.remove('hidden');
                document.getElementById('adminForm').classList.add('hidden');
                document.getElementById('emojiList').innerHTML = MOODS.map(m => `<div class="clickable" style="font-size:24px; text-align:center;" onclick="window.selectEmoji('${m}', this)">${m}</div>`).join('');
            } else if(isAdmin) {
                document.getElementById('moodForm').classList.add('hidden');
                document.getElementById('adminForm').classList.remove('hidden');
            } else {
                return; // ê´€ë¦¬ìê°€ ì•„ë‹ˆê³  ë¬´ë“œíƒ­ë„ ì•„ë‹ˆë©´ ì•„ë¬´ê²ƒë„ ì•ˆí•¨
            }
            document.getElementById('writeModal').style.display = 'flex';
        };

        window.submitPost = async () => {
            if (!currentUser) return window.showAlert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            
            if(currentTab === 'mood') {
                if(!selectedEmoji) return window.showAlert("ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                const docId = `${dateStr}_${currentUser.uid}`;
                const docRef = doc(db, "posts", docId);
                
                try {
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) return window.showAlert("ì˜¤ëŠ˜ì˜ ê¸°ë¡ì€ ì´ë¯¸ ì™„ë£Œë˜ì—ˆì–´ìš”! ğŸŒ™");
                    
                    await setDoc(docRef, { type: 'mood', emoji: selectedEmoji, content: document.getElementById('moodContent').value, date: now.toISOString(), authorId: currentUser.uid });
                    const userRef = doc(db, "users", currentUser.uid);
                    const userSnap = await getDoc(userRef);
                    await setDoc(userRef, { stamps: (userSnap.data()?.stamps || 0) + 1 }, { merge: true });
                    window.showAlert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ â˜ï¸");
                    window.closeModal(); 
                    window.renderTab(currentTab);
                } catch (e) {
                    console.error(e);
                    window.showAlert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                }
            } else {
                try {
                    await addDoc(collection(db, "posts"), { 
                        type: document.getElementById('postType').value, 
                        title: document.getElementById('postTitle').value, 
                        content: document.getElementById('postContent').value, 
                        url: document.getElementById('postUrl').value, 
                        btnText: document.getElementById('btnText').value,
                        date: now.toISOString(), authorId: currentUser.uid, authorEmail: currentUser.email 
                    });
                    window.showAlert("ê²Œì‹œê¸€ ë“±ë¡ ì™„ë£Œ!");
                    window.closeModal();
                    
                    const t = document.getElementById('postType').value;
                    if(t === 'notice') window.renderTab('letter');
                    else if(t === 'letter') window.renderTab('letter');
                    else window.renderTab('editor', null);
                } catch (e) {
                    console.error("Post Error:", e);
                    window.showAlert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
                }
            }
        };

        // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
        window.openAdminDashboard = () => { 
            document.getElementById('adminDashboardModal').style.display='flex'; 
            if(isSuperAdmin) document.getElementById('superAdminSection').classList.remove('hidden');
            window.loadContentList();
        };

        window.loadAllUsers = async () => {
            if(!isSuperAdmin) return;
            const list = document.getElementById('allUserList');
            list.innerHTML = 'ë¡œë”©ì¤‘...';
            try {
                const q = query(collection(db, "users"));
                const snap = await getDocs(q);
                list.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    const joinDate = u.joinDate ? new Date(u.joinDate).toLocaleDateString() : 'ë‚ ì§œì—†ìŒ';
                    list.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px;">${u.nickname || 'ì´ë¦„ì—†ìŒ'} (${u.email || 'ì´ë©”ì¼ì—†ìŒ'}) - ${joinDate}</div>`;
                });
            } catch(e) {
                list.innerHTML = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
            }
        };

        window.loadContentList = async () => {
            const type = document.getElementById('manageContentType').value;
            document.getElementById('balanceInputArea').classList.toggle('hidden', type !== 'balance');
            document.getElementById('cookieInputArea').classList.toggle('hidden', type !== 'cookie');
            
            const listArea = document.getElementById('contentListArea');
            listArea.innerHTML = '<div>ë¡œë”©ì¤‘...</div>';
            
            const q = query(collection(db, "contents"), where("type", "==", type));
            const snap = await getDocs(q);
            listArea.innerHTML = '';
            
            window.cachedBalance = []; 
            if(type === 'balance') BALANCE_GAMES = []; 

            snap.forEach(d => {
                const data = d.data();
                const text = type === 'balance' ? data.q : data.msg;
                if(type === 'balance') window.cachedBalance.push(data); 
                
                listArea.innerHTML += `<div class="admin-list-item"><span>${text}</span><span class="admin-delete-btn" onclick="window.delContent('${d.id}')">Ã—</span></div>`;
            });
            
            if(type === 'balance' && window.cachedBalance.length > 0) BALANCE_GAMES = window.cachedBalance;
        };

        window.addContentItem = async () => {
            const type = document.getElementById('manageContentType').value;
            if(type === 'balance') {
                const q = document.getElementById('mBalQ').value;
                const a = document.getElementById('mBalA').value;
                const b = document.getElementById('mBalB').value;
                const aMsg = document.getElementById('mBalAMsg').value;
                const bMsg = document.getElementById('mBalBMsg').value;
                if(q && a && b) await addDoc(collection(db, "contents"), { type, q, a, b, aMsg, bMsg });
            } else {
                const msg = document.getElementById('mCookieMsg').value;
                if(msg) await addDoc(collection(db, "contents"), { type, msg });
            }
            window.showAlert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.loadContentList();
        };

        window.delContent = async (id) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "contents", id));
                window.loadContentList();
            }
        };

        window.adminAction = (action) => {
            if(!isSuperAdmin) return window.showAlert("ìŠˆí¼ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            window.showInputPopup("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”", async (email) => {
                window.showAlert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (DB users ì»¬ë ‰ì…˜ ìˆ˜ì • í•„ìš”)");
            });
        };

        // ... ê¸°ë³¸ í•¨ìˆ˜ë“¤ ...
        window.selectEmoji = (m, el) => { selectedEmoji = m; document.querySelectorAll('#emojiList div').forEach(d => d.style.background = 'none'); el.style.background = 'var(--primary-light)'; el.style.borderRadius = '50%'; };
        window.clickEmpathy = (btn) => { btn.style.color = 'var(--primary)'; btn.style.fontWeight = '700'; btn.innerHTML += ' +1'; };
        window.loadStamps = async () => { const userSnap = await getDoc(doc(db, "users", currentUser.uid)); const count = userSnap.data()?.stamps || 0; const grid = document.getElementById('stampGrid'); grid.innerHTML = ''; for(let i=1; i<=30; i++) { let giftHtml = ''; let onClick = ''; if(i===10) { giftHtml='<div class="gift-box">ğŸ</div>'; if(count>=10) onClick=`onclick="window.showAlert('10ê°œ ë‹¬ì„± ì¶•í•˜í•´ìš”! ğŸ‰<br>ë¹„ë°€ì½”ë“œ: <b>[êµ¬ë¦„í•œì ]</b>')"` } if(i===20) { giftHtml='<div class="gift-box">ğŸ“œ</div>'; if(count>=20) onClick=`onclick="window.showAlert('20ê°œ ë‹¬ì„±! ğŸ‘<br>ë¹„ë°€ì½”ë“œ: <b>[ë‹¬ë¹›ì‚°ì±…]</b>')"` } if(i===30) { giftHtml='<div class="gift-box">ğŸ‘‘</div>'; if(count>=30) onClick=`onclick="window.showAlert('30ê°œ ë‹¬ì„±! VIP ğŸ‘‘<br>ë¹„ë°€ì½”ë“œ: <b>[ì˜¨ì „í•œì‰¼]</b>')"` } grid.innerHTML += `<div class="stamp-slot ${i<=count?'active':''} clickable" ${onClick}>${i}${giftHtml}</div>`; } };
        window.shredWorry = () => { const box = document.getElementById('shredderBox'); box.classList.add('shredder-act'); setTimeout(() => { window.showAlert("ê±±ì •ì´ ë§ë”íˆ ì‚¬ë¼ì¡Œì–´ìš”! âœ¨"); box.classList.remove('shredder-act'); document.getElementById('worryInput').value=''; }, 1000); };
        window.openCookie = async () => { 
            const today = new Date().toDateString();
            if(localStorage.getItem('cookieDate_v2') === today) return window.showAlert("ì¿ í‚¤ëŠ” í•˜ë£¨ì— í•œ ë²ˆë§Œ<br>ì—´ ìˆ˜ ìˆì–´ìš”! ğŸ¥ ");
            const q = query(collection(db, "contents"), where("type", "==", "cookie"));
            const snap = await getDocs(q);
            let msgs = COOKIE_MSGS;
            if(!snap.empty) { msgs = []; snap.forEach(d => msgs.push(d.data().msg)); }
            localStorage.setItem('cookieDate_v2', today); 
            window.showAlert(`ğŸ’Œ ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€<br><br>"${msgs[Math.floor(Math.random()*msgs.length)]}"`, "í˜ì´ ë‚˜ìš”!"); 
        };
        window.doLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('authEmail').value, document.getElementById('authPw').value); } catch(e) { window.showAlert("ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); } };
        window.doSignup = async () => { 
            try { 
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPw').value); 
                await updateProfile(cred.user, { displayName: document.getElementById('regNick').value }); 
                // ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ê°€ì…ì¼ í¬í•¨)
                await setDoc(doc(db, "users", cred.user.uid), { 
                    stamps: 0, 
                    nickname: document.getElementById('regNick').value,
                    email: document.getElementById('regEmail').value,
                    joinDate: new Date().toISOString()
                }); 
                window.showAlert("í™˜ì˜í•©ë‹ˆë‹¤!"); 
            } catch(e) { window.showAlert("ê°€ì… ì˜¤ë¥˜: " + e.message); } 
        };
        window.toggleSignupMode = () => { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('signupForm').classList.toggle('hidden'); };
        window.resetPw = () => window.showInputPopup("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”", (email) => { sendPasswordResetEmail(auth, email).then(()=>window.showAlert("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ì´ë©”ì¼ì—ì„œ í™•ì¸í•˜ì„¸ìš”!<br>(ìŠ¤íŒ¸í•¨ê¹Œì§€ check!)")).catch(()=>window.showAlert("ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")); });
        window.handleLogout = async () => { await signOut(auth); window.location.reload(); };
        window.saveImage = (targetId, fileName) => { const el = document.getElementById(targetId); html2canvas(el, { scale: 2, backgroundColor: null }).then(canvas => { const link = document.createElement("a"); link.download = fileName || `jahyu_mood.png`; link.href = canvas.toDataURL(); link.click(); }); };

        // ì´ˆê¸°í™”
        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === user.email.toLowerCase());
                isSuperAdmin = (user.email.toLowerCase() === SUPER_ADMIN);
                document.getElementById('authModal').style.display = 'none';
                window.renderTab('home');
                window.loadContentList(); 
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>