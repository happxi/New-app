<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìíœ´ë ˆí„° - í–…ì‚ë‹˜ì„ ìœ„í•œ íŠ¹ë³„í•œ ê³µê°„!</title>
    
    <!-- í°íŠ¸ & ì•„ì´ì½˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ë””ìì¸ì€ í–…ì‚ë‹˜ì´ ì›í•˜ì‹  ê·¸ëŒ€ë¡œ ìœ ì§€í–ˆìŠµë‹ˆë‹¤ */
        :root {
            --primary: #6B46C1; --primary-soft: #F3E8FF; --accent: #FF6B9D; --accent-soft: #FFE4EC;
            --secondary: #4ECDC4; --secondary-soft: #E6FFF9; --text-main: #2D3748; --text-sub: #718096;
            --bg-body: #F8F9FA; --white: #FFFFFF; --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.2); --shadow-card: 0 8px 32px rgba(107, 70, 193, 0.12);
            --shadow-glass: 0 8px 32px rgba(31, 38, 135, 0.15);
            
            /* ë¬´ë“œ ì´ëª¨ì§€ ì»¬ëŸ¬ */
            --mood-1: #FDE8D9; --mood-2: #FFD7E9; --mood-3: #F9D5FF; --mood-4: #D8D2FF; 
            --mood-5: #D4F3F7; --mood-6: #D7F7E9; --mood-7: #E6FFD2; --mood-8: #FFF9D2; 
            --mood-9: #FFEBEB; --mood-10: #E0E0E0; --mood-11: #B0E0E6; --mood-12: #C4A7E3; 
            --mood-13: #F0A0B0; --mood-14: #87CEEB; --mood-15: #98FB98; --mood-16: #FDF5E6; 
            --mood-17: #FFC0CB; --mood-18: #D8BFD8; --mood-19: #A0D0A0; --mood-20: #ADD8E6; 
            
            /* ê´€ë¦¬ì í”„ë¡œí•„ ì»¬ëŸ¬ */
            --admin-happxi: #FFD7E9; --admin-elly: #D7F7E9; --admin-gokal: #D4F3F7;
            --admin-sunny: #FDE8D9; --admin-yudan: #F9D5FF;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nanum Round Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #F8F9FA 0%, #E6FFF9 100%); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 80%, var(--primary-soft), transparent 50%), radial-gradient(circle at 80% 20%, var(--accent-soft), transparent 50%); z-index: -1; opacity: 0.6; }

        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--glass-bg); backdrop-filter: blur(10px); margin-top: 20px; box-shadow: var(--shadow-glass); border: 1px solid var(--glass-border); padding-bottom: 90px; border-radius: 30px 30px 0 0; }
        
        .header-section { padding: 40px 25px 20px; text-align: center; background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(248,249,250,0.8)); border-radius: 30px 30px 0 0; }
        .header-title { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
        .header-sub { font-size: 14px; color: var(--text-sub); }

        .content-card { background: var(--glass-bg); backdrop-filter: blur(10px); border-radius: 25px; padding: 20px; margin: 0 20px 15px; box-shadow: var(--shadow-card); border: 1px solid rgba(255,255,255,0.6); transition: transform 0.2s; cursor: pointer; }
        .content-card:active { transform: scale(0.98); }

        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 12px 24px; border: none; border-radius: 15px; font-weight: 700; width: 100%; cursor: pointer; }
        .btn-secondary { background: white; color: var(--text-sub); border: 2px solid var(--primary-soft); padding: 12px; border-radius: 15px; width: 100%; cursor: pointer; font-weight: 700; }
        
        .input-box { width: 100%; padding: 15px; border: 2px solid rgba(107, 70, 193, 0.1); border-radius: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.9); }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--glass-bg); width: 90%; max-width: 380px; padding: 30px; border-radius: 30px; text-align: center; max-height: 90vh; overflow-y: auto; }

        /* í•˜ë‹¨ ë„¤ë¹„ */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; height: 80px; background: var(--glass-bg); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 1px solid var(--glass-border); padding-bottom: 10px; backdrop-filter: blur(20px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); width: 60px; font-size: 10px; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.central .central-bg { width: 55px; height: 55px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 20px; display: flex; align-items: center; justify-content: center; border: 4px solid white; transform: translateY(-15px); color: white; box-shadow: 0 8px 25px rgba(107, 70, 193, 0.3); }

        /* ì´ëª¨ì§€ ì„ íƒê¸° */
        .emoji-selector { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        .emoji-option { font-size: 28px; padding: 5px; border-radius: 15px; cursor: pointer; border: 2px solid transparent; }
        .emoji-option.selected { border-color: var(--primary); transform: scale(1.1); }

        .write-icon { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 20px rgba(107,70,193,0.3); cursor: pointer; z-index: 999; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; z-index: 3000; display: none; }
        
        /* ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .activity-log-item { font-size: 13px; padding: 8px 0; border-bottom: 1px dashed #eee; text-align: left; }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-card">
            <h2 style="color:var(--primary); margin-bottom:20px;">ìíœ´ë ˆí„°</h2>
            <input type="email" id="emailInput" class="input-box" placeholder="ì´ë©”ì¼">
            <input type="password" id="pwInput" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="handleLogin()" class="btn-primary" style="margin-bottom:10px;">ë¡œê·¸ì¸</button>
            <button onclick="showSignup()" class="btn-secondary">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div id="signupModal" class="modal-overlay">
        <div class="modal-card">
            <h3>íšŒì›ê°€ì…</h3>
            <p style="font-size:12px; color:var(--text-sub); margin-bottom:15px;">ê´€ë¦¬ìëŠ” ì§€ì •ëœ ì´ë©”ì¼ë¡œ ê°€ì…í•´ì£¼ì„¸ìš”!</p>
            <input type="text" id="regNick" class="input-box" placeholder="ë‹‰ë„¤ì„">
            <input type="email" id="regEmail" class="input-box" placeholder="ì´ë©”ì¼">
            <input type="password" id="regPw" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
            <button onclick="handleSignup()" class="btn-primary">ê°€ì…í•˜ê¸°</button>
            <button onclick="showLogin()" class="btn-secondary" style="margin-top:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="modal-card" style="text-align: left;">
            <h3 id="writeHeader">ê¸€ì“°ê¸°</h3>
            
            <select id="writeCategory" class="input-box" style="display:none; margin-top:10px;">
                <option value="ìíœ´ë ˆí„°">ìíœ´ë ˆí„°</option>
                <option value="ìíœ´ë©">ìíœ´ë©</option>
                <option value="ì—ë””í„°í†¡">ì—ë””í„°í†¡</option>
            </select>
            
            <div id="moodSection" style="display:none;">
                <p style="font-size:12px; margin-top:10px;">ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€?</p>
                <div id="emojiGrid" class="emoji-selector"></div>
            </div>
            
            <input type="text" id="writeTitle" class="input-box" placeholder="ì œëª©">
            <textarea id="writeContent" class="input-box" style="height:100px;" placeholder="ë‚´ìš©"></textarea>
            
            <div id="fileArea" style="margin-bottom:10px;">
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="previewImage(this)">
                <button onclick="document.getElementById('fileInput').click()" class="btn-secondary" style="font-size:12px;">ğŸ“· ì‚¬ì§„ ì²¨ë¶€</button>
                <img id="imgPreview" style="width:100%; border-radius:10px; margin-top:5px; display:none;">
            </div>

            <button onclick="savePost()" class="btn-primary">ë“±ë¡</button>
            <button onclick="closeModal('writeModal')" class="btn-secondary" style="margin-top:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ -->
    <div id="dashboardModal" class="modal-overlay">
        <div class="modal-card" style="max-width:400px; text-align:left;">
            <h3>ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
            
            <!-- ê´€ë¦¬ì ì¶”ê°€ íƒ­ -->
            <div style="margin-top:15px; padding:10px; background:#f0f0f0; border-radius:10px;">
                <h5 style="margin-bottom:5px;">ê´€ë¦¬ì ê´€ë¦¬</h5>
                <input type="email" id="newAdminEmail" placeholder="ê´€ë¦¬ì ì´ë©”ì¼ ì¶”ê°€" style="width:70%; padding:5px;">
                <button onclick="addAdmin()" style="width:25%; padding:5px;">ì¶”ê°€</button>
                <div id="adminListDisplay" style="margin-top:5px; font-size:11px; color:#555;"></div>
            </div>

            <div style="margin:20px 0; padding:15px; background:var(--primary-soft); border-radius:15px;">
                <p><b>ì´ ì‚¬ìš©ì:</b> <span id="dashUserCount">0</span>ëª…</p>
                <p><b>ì´ ê²Œì‹œê¸€:</b> <span id="dashPostCount">0</span>ê°œ</p>
            </div>
            <h4>ğŸ“‹ í™œë™ ë¡œê·¸ (íƒ€ì¸ ë¬´ë“œ ì œì™¸)</h4>
            <div id="activityLogs" style="height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-top:5px; background:white;"></div>
            <button onclick="closeModal('dashboardModal')" class="btn-secondary" style="margin-top:15px;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì•± ë©”ì¸ í™”ë©´ -->
    <div id="appContainer" class="app-container"></div>

    <!-- ê´€ë¦¬ììš© ê¸€ì“°ê¸° ë²„íŠ¼ -->
    <div id="writeIcon" class="write-icon" onclick="openWriteModal('admin')">
        <i class="fas fa-plus"></i>
    </div>

    <!-- í•˜ë‹¨ë°” -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="renderTab('home')" id="nav-home"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item" onclick="renderTab('letter')" id="nav-letter"><i class="fas fa-envelope"></i>ë ˆí„°</div>
        <div class="nav-item central" onclick="renderTab('mood')" id="nav-mood"><div class="central-bg"><i class="fas fa-smile"></i></div>ë¬´ë“œ</div>
        <div class="nav-item" onclick="renderTab('editorTalk')" id="nav-editorTalk"><i class="fas fa-comments"></i>í†¡</div>
        <div class="nav-item" onclick="renderTab('mypage')" id="nav-mypage"><i class="fas fa-user"></i>ë§ˆì´</div>
    </nav>

    <!-- íŒŒì´ì–´ë² ì´ìŠ¤ ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, orderBy, deleteDoc, updateDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ í–…ì‚ë‹˜ì´ ì£¼ì‹  ì„¤ì •ê°’ ì ìš© ì™„ë£Œ! ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ì „ì—­ ìƒíƒœ
        window.currentUser = null;
        window.currentTab = 'home';
        window.isAdmin = false;
        let unsubscribe = null; 

        // ğŸ‘‘ ê¸°ë³¸ ê´€ë¦¬ì ëª©ë¡ (ì½”ë“œì— ê³ ì •) + ë™ì  ì¶”ê°€ëŠ” DB í™œìš© ì¶”ì²œí•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨íˆ
        // ì²˜ìŒì—” ì´ ëª©ë¡ì— ìˆëŠ” ì´ë©”ì¼ë¡œ ê°€ì…í•´ì•¼ ê´€ë¦¬ìê°€ ë©ë‹ˆë‹¤.
        let ADMIN_EMAILS = [
            'happxi@jahyu.com', 'elly@jahyu.com', 'gokal@jahyu.com', 'sunny@jahyu.com', 'yudan@jahyu.com'
        ];

        // ğŸŒˆ ë¬´ë“œ ë°ì´í„° (ìƒ‰ìƒ í¬í•¨)
        const MOODS = [
            {e:'ğŸ˜Š',c:'#FDE8D9'}, {e:'ğŸ¥°',c:'#FFD7E9'}, {e:'ğŸ˜Œ',c:'#F9D5FF'}, {e:'ğŸ˜­',c:'#D8D2FF'},
            {e:'ğŸ˜¡',c:'#D4F3F7'}, {e:'ğŸ˜´',c:'#D7F7E9'}, {e:'ğŸ¤©',c:'#E6FFD2'}, {e:'ğŸ¤”',c:'#FFF9D2'},
            {e:'ğŸ¥º',c:'#FFEBEB'}, {e:'ğŸ”¥',c:'#F0A0B0'}, {e:'ğŸ˜‡',c:'#C4A7E3'}, {e:'â˜”',c:'#D8BFD8'},
            {e:'ğŸ¤§',c:'#B0E0E6'}, {e:'ğŸ˜©',c:'#87CEEB'}, {e:'ğŸ€',c:'#98FB98'}, {e:'ğŸ¤«',c:'#FDF5E6'},
            {e:'ğŸ’«',c:'#FFC0CB'}, {e:'ğŸŒ³',c:'#A0D0A0'}, {e:'ğŸ¤ª',c:'#ADD8E6'}, {e:'ğŸ˜',c:'#E0E0E0'}
        ];

        // ğŸ” ì¸ì¦ í•¨ìˆ˜
        window.handleLogin = async () => {
            const email = document.getElementById('emailInput').value;
            const pw = document.getElementById('pwInput').value;
            try {
                await signInWithEmailAndPassword(auth, email, pw);
                showToast("ë¡œê·¸ì¸ ì„±ê³µ!");
            } catch (e) {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        };

        window.handleSignup = async () => {
            const nick = document.getElementById('regNick').value;
            const email = document.getElementById('regEmail').value;
            const pw = document.getElementById('regPw').value;
            if(!nick) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pw);
                await updateProfile(cred.user, { displayName: nick });
                
                // ì‚¬ìš©ì DB ì €ì¥
                await setDoc(doc(db, "users", cred.user.uid), {
                    email: email, name: nick, createdAt: new Date().toISOString()
                });
                
                // ë¡œê·¸ ì €ì¥
                addLog('signup', nick, 'ë‹˜ì´ ê°€ì…í–ˆìŠµë‹ˆë‹¤.');
                
                alert("ê°€ì… ì™„ë£Œ! ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.");
            } catch (e) {
                alert("ê°€ì… ì‹¤íŒ¨: " + e.message);
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            window.location.reload(); // ë¡œê·¸ì•„ì›ƒ ì‹œ ìƒˆë¡œê³ ì¹¨
        };

        // ğŸ“ ê¸€ì“°ê¸° ë° ìˆ˜ì • ë¡œì§
        let isEditing = false;
        let editId = null;
        let selectedMood = null;

        window.openWriteModal = (type, editData = null) => {
            const modal = document.getElementById('writeModal');
            const catSelect = document.getElementById('writeCategory');
            const moodSec = document.getElementById('moodSection');
            const fileArea = document.getElementById('fileArea');
            
            // ì´ˆê¸°í™”
            document.getElementById('writeTitle').value = '';
            document.getElementById('writeContent').value = '';
            document.getElementById('imgPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
            isEditing = false; editId = null; selectedMood = null;
            
            modal.style.display = 'flex';

            if (editData) {
                isEditing = true;
                editId = editData.id;
                document.getElementById('writeTitle').value = editData.title || '';
                document.getElementById('writeContent').value = editData.content;
                document.getElementById('writeHeader').innerText = "ê¸€ ìˆ˜ì •";
                if(editData.category) catSelect.value = editData.category;
            } else {
                document.getElementById('writeHeader').innerText = "ê¸€ì“°ê¸°";
            }

            if (type === 'mood') {
                catSelect.style.display = 'none';
                moodSec.style.display = 'block';
                fileArea.style.display = 'none';
                document.getElementById('writeTitle').placeholder = 'ì˜¤ëŠ˜ í•˜ë£¨ í•œ ì¤„ ìš”ì•½';
                document.getElementById('emojiGrid').innerHTML = MOODS.map(m => 
                    `<div class="emoji-option" style="background:${m.c}" onclick="selectMood(this, '${m.e}', '${m.c}')">${m.e}</div>`
                ).join('');
            } else { // admin write
                catSelect.style.display = 'block';
                moodSec.style.display = 'none';
                fileArea.style.display = 'block';
                document.getElementById('writeTitle').placeholder = 'ì œëª©';
            }
        };

        window.selectMood = (el, emoji, color) => {
            document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedMood = { emoji, color };
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.savePost = async () => {
            const title = document.getElementById('writeTitle').value;
            const content = document.getElementById('writeContent').value;
            const category = document.getElementById('writeCategory').value;
            const fileInput = document.getElementById('fileInput');

            if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            // ì´ë¯¸ì§€ Base64 ë³€í™˜
            let imageStr = null;
            if (fileInput.files.length > 0) {
                imageStr = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            const postData = {
                content: content,
                date: new Date().toISOString(),
                author: currentUser.displayName,
                authorId: currentUser.uid,
                likes: [],
                commentsCount: 0
            };

            if (selectedMood) {
                postData.type = 'mood';
                postData.emoji = selectedMood.emoji;
                postData.color = selectedMood.color;
                postData.title = title || selectedMood.emoji;
            } else {
                if (!isAdmin) return alert("ê´€ë¦¬ìë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                postData.type = 'post';
                postData.title = title;
                postData.category = category;
                if (imageStr) postData.image = imageStr;
            }

            try {
                if (isEditing) {
                    const updateData = { title, content, category };
                    if (imageStr) updateData.image = imageStr;
                    await updateDoc(doc(db, "posts", editId), updateData);
                    showToast("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    await addDoc(collection(db, "posts"), postData);
                    if(postData.type === 'post') addLog('post', currentUser.displayName, `[${category}] ìƒˆ ê¸€ ì‘ì„±`);
                    showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
                closeModal('writeModal');
            } catch (e) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
            }
        };

        window.deletePost = async (id) => {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await deleteDoc(doc(db, "posts", id));
            showToast("ì‚­ì œ ì™„ë£Œ");
        };

        // ğŸ“Š ëŒ€ì‹œë³´ë“œ ë¡œì§
        window.openDashboard = async () => {
            document.getElementById('dashboardModal').style.display = 'flex';
            renderAdminList();

            // ìœ ì €ìˆ˜
            const uSnap = await getDocs(collection(db, "users"));
            document.getElementById('dashUserCount').innerText = uSnap.size;
            
            // ê²Œì‹œê¸€ìˆ˜
            const pSnap = await getDocs(query(collection(db, "posts"), where("type", "==", "post")));
            document.getElementById('dashPostCount').innerText = pSnap.size;

            // ë¡œê·¸ ë¡œë”©
            const lSnap = await getDocs(query(collection(db, "logs"), orderBy("date", "desc")));
            const logDiv = document.getElementById('activityLogs');
            logDiv.innerHTML = '';
            lSnap.forEach(doc => {
                const l = doc.data();
                // ë¬´ë“œ ê¸°ë¡ì€ ë¡œê·¸ì—ì„œ ì œì™¸ (í”„ë¼ì´ë²„ì‹œ)
                if(l.type !== 'mood') {
                    logDiv.innerHTML += `
                        <div class="activity-log-item">
                            <span style="color:var(--primary);">[${l.type}]</span> <b>${l.user}</b>: ${l.action}
                            <span style="float:right; color:#aaa; font-size:10px;">${new Date(l.date).toLocaleTimeString()}</span>
                        </div>`;
                }
            });
        };

        window.addAdmin = () => {
            const email = document.getElementById('newAdminEmail').value;
            if(email && !ADMIN_EMAILS.includes(email)) {
                ADMIN_EMAILS.push(email);
                renderAdminList();
                document.getElementById('newAdminEmail').value = '';
                showToast("ê´€ë¦¬ì ëª©ë¡(ì„ì‹œ)ì— ì¶”ê°€ë¨");
            }
        };
        
        window.removeAdmin = (email) => {
            if(confirm('ì‚­ì œí•©ë‹ˆê¹Œ?')) {
                ADMIN_EMAILS = ADMIN_EMAILS.filter(e => e !== email);
                renderAdminList();
            }
        };

        function renderAdminList() {
            document.getElementById('adminListDisplay').innerText = "ê´€ë¦¬ì: " + ADMIN_EMAILS.join(", ");
        }

        async function addLog(type, user, action) {
            await addDoc(collection(db, "logs"), { type, user, action, date: new Date().toISOString() });
        }

        // ğŸ–¥ï¸ í™”ë©´ ë Œë”ë§ (íƒ­ ì „í™˜)
        window.renderTab = (tab) => {
            window.currentTab = tab;
            const container = document.getElementById('appContainer');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            
            // ê´€ë¦¬ì ê¸€ì“°ê¸° ë²„íŠ¼ ì œì–´
            document.getElementById('writeIcon').style.display = (isAdmin && ['letter', 'editorTalk'].includes(tab)) ? 'flex' : 'none';
            
            if(unsubscribe) unsubscribe(); // ì´ì „ ë¦¬ìŠ¤ë„ˆ í•´ì œ

            if (tab === 'home') {
                container.innerHTML = `
                    <div class="header-section">
                        <h2 class="header-title">${currentUser.displayName}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</h2>
                        <p class="header-sub">ì˜¤ëŠ˜ë„ í–…ì‚í•œ í•˜ë£¨ ë˜ì„¸ìš” ğŸ’œ</p>
                    </div>
                    <div style="padding:20px;">
                        <button class="btn-primary" onclick="renderTab('mood')">ì˜¤ëŠ˜ì˜ ë¬´ë“œ ë‚¨ê¸°ê¸°</button>
                    </div>
                `;
            } else if (tab === 'letter' || tab === 'editorTalk') {
                container.innerHTML = `<div class="header-section"><h2>${tab === 'letter'?'ìíœ´ë ˆí„°':'ì—ë””í„°í†¡'}</h2></div><div id="postList" style="padding:0 20px;">ë¡œë”©ì¤‘...</div>`;
                
                const q = query(collection(db, "posts"), where("type", "==", "post"), orderBy("date", "desc"));
                unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = document.getElementById('postList');
                    if(!list) return;
                    list.innerHTML = '';
                    snapshot.forEach(d => {
                        const p = d.data();
                        const pid = d.id;
                        // ì¹´í…Œê³ ë¦¬ í•„í„°
                        if(tab === 'letter' && p.category === 'ì—ë””í„°í†¡') return;
                        if(tab === 'editorTalk' && p.category !== 'ì—ë””í„°í†¡') return;
                        
                        // ê´€ë¦¬ì ìƒ‰ìƒ
                        const colorMap = {
                            'happxi@jahyu.com': 'var(--admin-happxi)',
                            'elly@jahyu.com': 'var(--admin-elly)',
                            'gokal@jahyu.com': 'var(--admin-gokal)',
                            'sunny@jahyu.com': 'var(--admin-sunny)',
                            'yudan@jahyu.com': 'var(--admin-yudan)'
                        };
                        const profileColor = colorMap[p.authorId] || '#eee'; // IDëŒ€ì‹  ì´ë©”ì¼ ë§¤í•‘ì´ í•„ìš”í•˜ë©´ êµ¬ì¡°ë³€ê²½ í•„ìš”í•˜ë‚˜ ì—¬ê¸°ì„  ê°„ë‹¨íˆ

                        list.innerHTML += `
                            <div class="content-card" onclick="alert('ìƒì„¸ë³´ê¸°ëŠ” ì‹¬í”Œë²„ì „ì—ì„œ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.')">
                                ${isAdmin ? `<div style="float:right;">
                                    <i class="fas fa-edit" onclick="event.stopPropagation(); openWriteModal('admin', {id:'${pid}', ...{title:'${p.title}', content:'${p.content.replace(/\n/g,' ')}', category:'${p.category}'}})"></i>
                                    <i class="fas fa-trash" onclick="event.stopPropagation(); deletePost('${pid}')" style="margin-left:8px; color:red;"></i>
                                </div>` : ''}
                                <h4>[${p.category}] ${p.title}</h4>
                                ${p.image ? `<img src="${p.image}" style="width:100%; height:150px; object-fit:cover; border-radius:10px; margin:10px 0;">` : ''}
                                <p style="font-size:13px; color:#555;">${p.content.substring(0,60)}...</p>
                                <div style="margin-top:10px; font-size:12px; color:#888;">${p.author} Â· ${new Date(p.date).toLocaleDateString()}</div>
                            </div>`;
                    });
                });
            } else if (tab === 'mood') {
                container.innerHTML = `
                    <div class="header-section"><h2>ì˜¤ëŠ˜ì˜ ë¬´ë“œ</h2></div>
                    <div style="text-align:center; padding:15px;"><button class="btn-primary" onclick="openWriteModal('mood')">ê¸°ë¡í•˜ê¸°</button></div>
                    <div id="moodList" style="padding:0 20px;"></div>
                `;
                // ë‚´ ë¬´ë“œë§Œ
                const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid), orderBy("date", "desc"));
                unsubscribe = onSnapshot(q, (snapshot) => {
                    const list = document.getElementById('moodList');
                    if(!list) return;
                    list.innerHTML = '';
                    snapshot.forEach(d => {
                        const m = d.data();
                        list.innerHTML += `
                            <div class="content-card" style="background:${m.color}; display:flex; align-items:center;">
                                <div style="font-size:40px; margin-right:15px;">${m.emoji}</div>
                                <div>
                                    <h4 style="margin:0;">${m.title}</h4>
                                    <p style="font-size:12px; margin:5px 0;">${m.content}</p>
                                    <span style="font-size:10px; opacity:0.6;">${new Date(m.date).toLocaleString()}</span>
                                </div>
                            </div>`;
                    });
                });
            } else if (tab === 'mypage') {
                container.innerHTML = `
                    <div class="header-section"><h2>ë§ˆì´í˜ì´ì§€</h2></div>
                    <div style="padding:20px;">
                        <h3>${currentUser.displayName}ë‹˜</h3>
                        ${isAdmin ? `<button class="btn-primary" onclick="openDashboard()" style="background:#333; margin-bottom:10px;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</button>` : ''}
                        <button class="btn-secondary" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                `;
            }
        };

        // ìœ í‹¸
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.showSignup = () => { closeModal('loginModal'); document.getElementById('signupModal').style.display = 'flex'; };
        window.showLogin = () => { closeModal('signupModal'); document.getElementById('loginModal').style.display = 'flex'; };
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }

        // ğŸ”¥ ì¸ì¦ ìƒíƒœ ê°ì§€ (ì•± ì‹œì‘ì )
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                window.isAdmin = ADMIN_EMAILS.includes(user.email);
                
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('signupModal').style.display = 'none';
                renderTab('home');
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
