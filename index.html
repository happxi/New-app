<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìíœ´ë ˆí„°</title>
    
    <!-- í°íŠ¸ & ì•„ì´ì½˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ì´ë¯¸ì§€ ì €ì¥ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        :root {
            /* ğŸ¨ ë©”ì¸ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ */
            --primary: #845EF7;       /* ê°ì„± í¼í”Œ */
            --primary-soft: #F3F0FF;  /* ì—°í•œ í¼í”Œ ë°°ê²½ */
            --accent: #FF8787;        /* ë”°ëœ»í•œ í•‘í¬ (ì¢‹ì•„ìš”, ì•Œë¦¼) */
            --bg-body: #F8F9FA;
            --text-main: #343A40;
            --text-sub: #868E96;
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
            
            /* ë¬´ë“œ ìº˜ë¦°ë”ìš© íŒŒìŠ¤í…” */
            --mood-happy: #FFD6E0; --mood-sad: #D6E4FF; --mood-angry: #FFD6D6; 
            --mood-calm: #E4F9D4; --mood-tired: #F2F2F2;
        }

        /* ğŸŒ™ ìƒˆë²½ ê°ì„± ëª¨ë“œ (00:00 ~ 06:00 ìë™ ì ìš©) */
        body.night-mode {
            --primary: #B197FC;
            --primary-soft: #2D2B55;
            --bg-body: #1E1E2E;
            --text-main: #EDE9FE;
            --text-sub: #A5A5C0;
            --glass: rgba(30, 30, 46, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nanum Round Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-body); 
            color: var(--text-main); 
            min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center; 
            transition: background 0.5s ease;
        }

        /* ğŸ“± ì•± ì»¨í…Œì´ë„ˆ */
        .app-container { 
            width: 100%; max-width: 480px; min-height: 100vh; 
            background: var(--bg-body); 
            position: relative; padding-bottom: 90px; 
        }

        /* âœ¨ í—¤ë” (ìœ ë¦¬ ì§ˆê°) */
        .header {
            position: sticky; top: 0; z-index: 100;
            padding: 15px 20px;
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        .logo { font-family: 'Gaegu', cursive; font-size: 24px; font-weight: 700; color: var(--primary); }
        .header-icons i { font-size: 20px; margin-left: 15px; cursor: pointer; color: var(--text-main); position: relative; }
        .badge-dot { position: absolute; top: -2px; right: -2px; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; display: none; }

        /* ğŸ  í™ˆ: íˆì–´ë¡œ ì¹´ë“œ (íë§ í…ŒìŠ¤íŠ¸) */
        .hero-card {
            margin: 20px; padding: 25px;
            background: linear-gradient(135deg, var(--primary), #DA77F2);
            border-radius: 25px; color: white; text-align: center;
            box-shadow: 0 10px 25px rgba(132, 94, 247, 0.3);
            position: relative; overflow: hidden; cursor: pointer;
        }
        .hero-card::before {
            content: 'âœ¨'; position: absolute; top: 10px; left: 15px; font-size: 40px; opacity: 0.2;
        }
        .hero-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .hero-sub { font-size: 13px; opacity: 0.9; }

        /* ğŸ”˜ í€µë©”ë‰´ (ìˆ˜ì •ë¨: ì±Œë¦°ì§€ í¬í•¨) */
        .quick-menu { display: flex; justify-content: space-between; padding: 0 25px; margin-bottom: 30px; }
        .quick-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .quick-icon {
            width: 55px; height: 55px; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; margin-bottom: 8px; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .quick-item:active .quick-icon { transform: scale(0.95); }
        /* íŒŒìŠ¤í…”í†¤ ê·¸ë¼ë°ì´ì…˜ */
        .icon-letter { background: linear-gradient(135deg, #FF9A9E, #FECFEF); }
        .icon-challenge { background: linear-gradient(135deg, #a18cd1, #fbc2eb); }
        .icon-sentence { background: linear-gradient(135deg, #84fab0, #8fd3f4); }
        .icon-chat { background: linear-gradient(135deg, #fccb90, #d57eeb); }
        .quick-text { font-size: 12px; font-weight: 600; color: var(--text-main); }

        /* ğŸ“Œ í•€í„°ë ˆìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¹´ë“œ (ë ˆí„°/ì±Œë¦°ì§€) */
        .masonry-grid { column-count: 2; column-gap: 15px; padding: 0 20px; }
        .pin-card {
            break-inside: avoid; margin-bottom: 15px;
            background: white; border-radius: 20px;
            overflow: hidden; box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .pin-card:active { transform: scale(0.98); }
        .pin-img { width: 100%; display: block; object-fit: cover; }
        .pin-content { padding: 12px; }
        .pin-tag { font-size: 10px; color: var(--primary); background: var(--primary-soft); padding: 3px 8px; border-radius: 10px; font-weight: 700; display: inline-block; margin-bottom: 5px; }
        .pin-title { font-size: 14px; font-weight: 700; line-height: 1.4; margin-bottom: 5px; color: #333; }
        .pin-meta { font-size: 11px; color: var(--text-sub); display: flex; justify-content: space-between; }
        
        /* ğŸš¨ ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ (ìƒë‹¨ ê³ ì •) */
        .notice-card {
            background: #FFF5F5; border: 1px solid #FFEC99;
            break-inside: avoid; margin-bottom: 15px; border-radius: 20px; padding: 15px;
            position: relative; cursor: pointer;
        }
        .notice-badge { position: absolute; top: 10px; right: 10px; font-size: 16px; }

        /* ğŸ—“ï¸ ë¬´ë“œ ìº˜ë¦°ë” */
        .calendar-wrap { padding: 0 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 700; font-size: 18px; }
        .week-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-sub); margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell {
            aspect-ratio: 1/1; border-radius: 12px;
            background: white; border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: var(--text-sub);
            position: relative; cursor: pointer;
        }
        .day-cell.today { border: 2px solid var(--primary); font-weight: 700; color: var(--primary); }
        .day-emoji { font-size: 24px; line-height: 1; }

        /* ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥ ìº¡ì²˜ ì˜ì—­ (ìˆ¨ê¹€ ì²˜ë¦¬ë¨, ì €ì¥ ì‹œì—ë§Œ ì‚¬ìš©) */
        #captureArea {
            position: fixed; top: -9999px; left: -9999px; width: 320px;
            background: linear-gradient(135deg, #FFF0F6 0%, #FFF5F5 100%);
            padding: 30px; border-radius: 0; text-align: center;
            font-family: 'Nanum Round Gothic', sans-serif;
        }
        .capture-logo { font-family: 'Gaegu'; color: var(--primary); font-size: 20px; margin-bottom: 20px; }
        .capture-content { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }

        /* ğŸ“ ê¸€ì“°ê¸° ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: flex-end;
        }
        .modal-sheet {
            background: white; width: 100%; max-width: 480px;
            border-radius: 25px 25px 0 0; padding: 25px;
            animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .input-box { width: 100%; padding: 15px; border: 1px solid #eee; border-radius: 15px; margin-bottom: 10px; font-size: 14px; background: #FAFAFA; }
        .emoji-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .emoji-btn { font-size: 28px; padding: 5px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; min-width: 45px; text-align: center; }
        .emoji-btn.selected { border-color: var(--primary); background: var(--primary-soft); }

        /* ğŸ§­ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 480px;
            height: 80px; background: var(--glass); backdrop-filter: blur(12px);
            border-top: 1px solid var(--glass-border);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 15px; z-index: 900;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); width: 60px; cursor: pointer; transition: 0.2s; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-text { font-size: 10px; font-weight: 600; }

        /* í”Œë¡œíŒ… ë²„íŠ¼ (ê¸€ì“°ê¸°) */
        .fab {
            position: fixed; bottom: 100px; right: 20px;
            width: 55px; height: 55px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 5px 20px rgba(132, 94, 247, 0.4);
            cursor: pointer; transition: transform 0.2s; z-index: 950;
        }
        .fab:active { transform: scale(0.9); }

        /* ğŸ í† ìŠ¤íŠ¸ & íŒì—… */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 13px; z-index: 3000; display: none;
            animation: fadeIn 0.3s;
        }
        .popup-overlay { display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .pink-popup {
            background: #FFF0F6; border: 2px solid #FFFFFF;
            width: 300px; padding: 30px; border-radius: 30px;
            text-align: center; box-shadow: 0 20px 50px rgba(255, 135, 135, 0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        .save-btn-wrap { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 5px; }
        .save-tooltip { background: var(--text-main); color: var(--bg-body); padding: 5px 10px; border-radius: 10px; font-size: 10px; opacity: 0.8; }
        
        /* ë§í¬ ì¹´ë“œ ë²„íŠ¼ */
        .link-card {
            display: block; margin-top: 15px; padding: 15px;
            background: #F1F3F5; border-radius: 15px;
            text-decoration: none; color: var(--text-main); font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }
    </style>
</head>
<body>

    <!-- ìº¡ì²˜ìš© ìˆ¨ê²¨ì§„ ì˜ì—­ -->
    <div id="captureArea">
        <div class="capture-logo">Jahyu Letter ğŸŒ¿</div>
        <div class="capture-content" id="captureTarget">
            <!-- ë‚´ìš©ì´ ì—¬ê¸°ì— ë³µì‚¬ë¨ -->
        </div>
        <div style="font-size:12px; color:#888;">ë‚˜ë¥¼ ìœ„í•œ ì‰¼, ìíœ´ë ˆí„°</div>
    </div>

    <!-- í•‘í¬ íŒì—… -->
    <div id="pinkPopup" class="popup-overlay">
        <div class="pink-popup">
            <div style="font-size:40px; margin-bottom:15px;">ğŸŒ¸</div>
            <h3 id="popupTitle" style="margin-bottom:10px; color:#D6336C;">ì €ì¥ ì™„ë£Œ!</h3>
            <p id="popupMsg" style="font-size:14px; color:#868E96; margin-bottom:20px;">ìŠ¤íƒ¬í”„ê°€ ì ë¦½ë˜ì—ˆì–´ìš”.</p>
            <button onclick="closePopup()" class="btn-primary" style="background:#FF8787;">í™•ì¸</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo" onclick="renderTab('home')">Jahyu</div>
        <div class="header-icons">
            <i class="fas fa-search" onclick="alert('ê²€ìƒ‰ ê¸°ëŠ¥ì€ ë°ì´í„°ê°€ ë” ìŒ“ì´ë©´ ì˜¤í”ˆë  ì˜ˆì •ì´ì—ìš”!')"></i>
            <i class="fas fa-bell" onclick="alert('ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.')"><div class="badge-dot"></div></i>
        </div>
    </header>

    <!-- ì•± ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="app-container">
        <!-- JSë¡œ ë‚´ìš©ì´ ì±„ì›Œì§ -->
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="renderTab('home')">
            <i class="fas fa-home"></i><span class="nav-text">í™ˆ</span>
        </div>
        <div class="nav-item" id="nav-letter" onclick="renderTab('letter')">
            <i class="fas fa-envelope-open-text"></i><span class="nav-text">ë ˆí„°</span>
        </div>
        <div class="nav-item" id="nav-mood" onclick="renderTab('mood')">
            <i class="fas fa-calendar-alt"></i><span class="nav-text">ë¬´ë“œ</span>
        </div>
        <div class="nav-item" id="nav-challenge" onclick="renderTab('challenge')">
            <i class="fas fa-running"></i><span class="nav-text">ì±Œë¦°ì§€</span>
        </div>
        <div class="nav-item" id="nav-mypage" onclick="renderTab('mypage')">
            <i class="fas fa-user-circle"></i><span class="nav-text">ë§ˆì´</span>
        </div>
    </nav>

    <!-- ê¸€ì“°ê¸° í”Œë¡œíŒ… ë²„íŠ¼ -->
    <div id="fab" class="fab" onclick="openWriteModal()">
        <i class="fas fa-pen"></i>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="modal-sheet">
            <h3 id="writeHeader" style="margin-bottom:20px;">ê¸€ì“°ê¸°</h3>
            
            <!-- ê´€ë¦¬ììš© ì˜µì…˜ -->
            <div id="adminOptions" class="hidden" style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:10px;">
                <label style="font-size:13px; font-weight:700;">
                    <input type="checkbox" id="isNotice"> ğŸ“Œ ê³µì§€ë¡œ ìƒë‹¨ ê³ ì •
                </label>
                <select id="postCategory" class="input-box" style="margin-top:10px;">
                    <option value="ìíœ´ë ˆí„°">ìíœ´ë ˆí„°</option>
                    <option value="ì—ë””í„°í†¡">ì—ë””í„°í†¡</option>
                    <option value="ìíœ´ìƒë‹´ì†Œ">ìíœ´ìƒë‹´ì†Œ(ë‹µë³€)</option>
                </select>
            </div>

            <!-- ë¬´ë“œ ì„ íƒ (ë¬´ë“œíƒ­ì¼ë•Œë§Œ) -->
            <div id="moodSelector" class="hidden">
                <p style="font-size:13px; margin-bottom:10px;">ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë–¤ê°€ìš”?</p>
                <div class="emoji-list">
                    <!-- JSë¡œ ì´ëª¨ì§€ ì±„ì›€ -->
                </div>
            </div>

            <input type="text" id="postTitle" class="input-box" placeholder="ì œëª©">
            <textarea id="postContent" class="input-box" style="height:120px; resize:none;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            
            <!-- ë§í¬ ì¹´ë“œ ì…ë ¥ -->
            <div style="margin-bottom:10px;">
                <input type="text" id="linkUrl" class="input-box" placeholder="ğŸ”— ì—°ê²°í•  ë§í¬ (http://...)" style="margin-bottom:5px;">
                <input type="text" id="linkText" class="input-box" placeholder="ë²„íŠ¼ ë¬¸êµ¬ (ì˜ˆ: ë³´ëŸ¬ê°€ê¸°)">
            </div>

            <!-- ì‚¬ì§„ ì²¨ë¶€ -->
            <div onclick="document.getElementById('fileInput').click()" style="padding:15px; border:2px dashed #ddd; border-radius:15px; text-align:center; color:#adb5bd; cursor:pointer; margin-bottom:20px;">
                <i class="fas fa-camera"></i> ì‚¬ì§„ ì¶”ê°€ (ìë™ ì••ì¶•ë¨)
            </div>
            <input type="file" id="fileInput" hidden accept="image/*">

            <button onclick="submitPost()" class="btn-primary">ë“±ë¡í•˜ê¸°</button>
            <button onclick="closeModal('writeModal')" class="btn-secondary" style="margin-top:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="authModal" class="modal-overlay" style="display:flex;">
        <div class="modal-card">
            <div class="logo" style="font-size:40px; margin-bottom:10px;">Jahyu</div>
            <p style="margin-bottom:30px; color:var(--text-sub);">ë‹¹ì‹ ì„ ìœ„í•œ ì‘ì€ ì‰¼í‘œ ğŸŒ¿</p>
            
            <div id="loginForm">
                <input type="email" id="email" class="input-box" placeholder="ì´ë©”ì¼">
                <input type="password" id="pw" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button onclick="doLogin()" class="btn-primary" style="margin-bottom:10px;">ë¡œê·¸ì¸</button>
                <button onclick="toggleAuth('signup')" class="btn-secondary">íšŒì›ê°€ì…</button>
                <p onclick="resetPw()" style="font-size:12px; color:#adb5bd; margin-top:15px; cursor:pointer; text-decoration:underline;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</p>
            </div>

            <div id="signupForm" class="hidden">
                <input type="text" id="newNick" class="input-box" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: í–…ì‚)">
                <input type="email" id="newEmail" class="input-box" placeholder="ì´ë©”ì¼">
                <input type="password" id="newPw" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
                <button onclick="doSignup()" class="btn-primary" style="margin-bottom:10px;">ê°€ì…í•˜ê¸°</button>
                <button onclick="toggleAuth('login')" class="btn-secondary">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">ë©”ì‹œì§€</div>

    <!-- ğŸ”¥ íŒŒì´ì–´ë² ì´ìŠ¤ ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, orderBy, updateDoc, deleteDoc, arrayUnion, arrayRemove, setDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ í–…ì‚ë‹˜ ì„¤ì •ê°’ (ê¼­ ë„£ìœ¼ì„¸ìš”!) ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentUser = null;
        let isAdmin = false;
        let currentTab = 'home';
        const ADMIN_EMAILS = ['happxi@jahyu.com', 'elly@jahyu.com', 'gokal@jahyu.com', 'sunny@jahyu.com', 'yudan@jahyu.com'];
        const MOODS = ['ğŸ˜Š','ğŸ¥°','ğŸ˜Œ','ğŸ˜­','ğŸ˜¡','ğŸ˜´','ğŸ¤©','ğŸ¤”','ğŸ¥º','ğŸ”¥','â˜”','ğŸ€'];

        // --- ìƒˆë²½ ëª¨ë“œ ìë™ ê°ì§€ ---
        const hour = new Date().getHours();
        if(hour >= 0 && hour < 6) document.body.classList.add('night-mode');

        // --- ì¸ì¦ ë¡œì§ ---
        window.doLogin = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pw').value);
            } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
        };

        window.doSignup = async () => {
            const nick = document.getElementById('newNick').value;
            if(!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('newEmail').value, document.getElementById('newPw').value);
                await updateProfile(cred.user, { displayName: nick });
                await setDoc(doc(db, "users", cred.user.uid), { 
                    email: cred.user.email, name: nick, stamps: 0, createdAt: new Date().toISOString() 
                });
                alert("ê°€ì… í™˜ì˜í•©ë‹ˆë‹¤! í–…ì‚ë‹˜!");
            } catch(e) { alert("ê°€ì… ì‹¤íŒ¨: " + e.message); }
        };

        window.resetPw = async () => {
            const email = prompt("ê°€ì…í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if(email) {
                await sendPasswordResetEmail(auth, email);
                alert("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ìŠ¤íŒ¸í•¨ë„ í™•ì¸í•´ì£¼ì„¸ìš”!");
            }
        };

        window.toggleAuth = (mode) => {
            document.getElementById('loginForm').classList.toggle('hidden', mode === 'signup');
            document.getElementById('signupForm').classList.toggle('hidden', mode === 'login');
        };

        // --- íƒ­ ë Œë”ë§ (í•µì‹¬) ---
        window.renderTab = async (tab) => {
            currentTab = tab;
            const container = document.getElementById('appContainer');
            container.innerHTML = ''; // ì´ˆê¸°í™”
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`)?.classList.add('active');

            // FAB(ê¸€ì“°ê¸°) ë²„íŠ¼ ì œì–´
            const fab = document.getElementById('fab');
            // ê´€ë¦¬ìë©´ í•­ìƒ ë³´ì´ê³ , ì¼ë°˜ ìœ ì €ëŠ” ë¬´ë“œ/ì±Œë¦°ì§€/ìƒë‹´ì†Œ(ëŒ“ê¸€)ì—ì„œë§Œ ë³´ì„ (ì—¬ê¸°ì„  ê°„ë‹¨íˆ ë¬´ë“œ/ì±Œë¦°ì§€ë§Œ)
            if(tab === 'mood' || tab === 'challenge') fab.style.display = 'flex';
            else if(isAdmin && (tab === 'letter' || tab === 'home')) fab.style.display = 'flex';
            else fab.style.display = 'none';

            // 1. í™ˆ íƒ­
            if (tab === 'home') {
                container.innerHTML = `
                    <div class="header-section">
                        <div class="header-title">${currentUser.displayName}ë‹˜, ì˜¤ëŠ˜ ë§ˆìŒì€ ì–´ë•Œìš”?</div>
                        <div class="header-sub">ìíœ´ë ˆí„°ì™€ í•¨ê»˜ ì ì‹œ ì‰¬ì–´ê°€ì„¸ìš” ğŸŒ¿</div>
                    </div>
                    
                    <div class="hero-card" onclick="window.open('https://index-html-zak5.vercel.app/')">
                        <div class="hero-title">ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì‰¼ ìœ í˜•ì€?</div>
                        <div class="hero-sub">íë§ í…ŒìŠ¤íŠ¸ í•˜ëŸ¬ê°€ê¸° ğŸ‘‰</div>
                    </div>

                    <div class="quick-menu">
                        <div class="quick-item" onclick="renderTab('letter')">
                            <div class="quick-icon icon-letter"><i class="fas fa-envelope-open-text"></i></div>
                            <span class="quick-text">ë ˆí„°</span>
                        </div>
                        <div class="quick-item" onclick="renderTab('challenge')">
                            <div class="quick-icon icon-challenge"><i class="fas fa-running"></i></div>
                            <span class="quick-text">ì±Œë¦°ì§€</span>
                        </div>
                        <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn/111753149')">
                            <div class="quick-icon icon-sentence"><i class="fas fa-pen-nib"></i></div>
                            <span class="quick-text">ë¬¸ì¥ìˆ˜ì§‘</span>
                        </div>
                        <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn')">
                            <div class="quick-icon icon-chat"><i class="fas fa-comments"></i></div>
                            <span class="quick-text">1:1ì±„íŒ…</span>
                        </div>
                    </div>

                    <div style="padding:0 20px;">
                        <h4 style="margin-bottom:15px;">ìµœì‹  ë ˆí„°</h4>
                        <div id="recentPosts" class="masonry-grid"></div>
                    </div>
                `;
                fetchPosts('post', 'recentPosts', 4);
            }

            // 2. ë ˆí„° íƒ­ (ê³µì§€ì‚¬í•­ + í•€í„°ë ˆìŠ¤íŠ¸)
            else if (tab === 'letter') {
                container.innerHTML = `
                    <div style="padding:20px 20px 0;">
                        <h2 style="font-weight:800; color:var(--primary);">ìíœ´ ì•„ì¹´ì´ë¸Œ</h2>
                        <div class="editor-filter">
                            <div class="filter-chip active" onclick="filterPosts('all')">ì „ì²´</div>
                            <div class="filter-chip" onclick="filterPosts('ìíœ´ë ˆí„°')">ìíœ´ë ˆí„°</div>
                            <div class="filter-chip" onclick="filterPosts('ì—ë””í„°í†¡')">ì—ë””í„°í†¡</div>
                            <div class="filter-chip" onclick="filterPosts('ìíœ´ìƒë‹´ì†Œ')">ìíœ´ìƒë‹´ì†Œ</div>
                        </div>
                    </div>
                    <div id="noticeArea" style="padding:0 20px;"></div>
                    <div id="letterGrid" class="masonry-grid" style="padding-top:10px;"></div>
                `;
                fetchPosts('post', 'letterGrid', 20, true); // true = ê³µì§€ í¬í•¨ ë¡œë“œ
            }

            // 3. ë¬´ë“œ íƒ­ (ìº˜ë¦°ë”)
            else if (tab === 'mood') {
                const today = new Date();
                container.innerHTML = `
                    <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="font-weight:800;">My Mood Log</h2>
                        <div class="save-tooltip">ğŸ‘‡ ì €ì¥í•˜ê¸°</div>
                        <i class="fas fa-camera" style="font-size:20px; color:var(--text-sub); cursor:pointer;" onclick="captureScreen('moodCalendar')"></i>
                    </div>
                    
                    <div id="moodCalendar" class="calendar-wrap" style="background:white; padding:20px; border-radius:20px; margin:0 20px;">
                        <div class="calendar-header">
                            <span>${today.getMonth()+1}ì›”</span>
                            <span style="font-size:12px; font-weight:400; color:#888;">ì˜¤ëŠ˜: ${MOODS[0]}</span>
                        </div>
                        <div class="week-days">
                            <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                        </div>
                        <div class="calendar-grid" id="calGrid"></div>
                    </div>
                    
                    <div style="padding:20px;">
                        <h4>ë‚˜ì˜ ê¸°ë¡</h4>
                        <div id="myMoodList" style="margin-top:10px;"></div>
                    </div>
                `;
                loadCalendar();
            }

            // 4. ì±Œë¦°ì§€ íƒ­
            else if (tab === 'challenge') {
                container.innerHTML = `
                    <div style="padding:40px 20px; text-align:center; background:#F8F0FC;">
                        <h3>í•¨ê»˜í•˜ëŠ” ë¦¬ì¶”ì–¼ ğŸƒâ€â™€ï¸</h3>
                        <p style="font-size:13px; color:#666; margin-top:5px;">ê±°ì°½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”.<br>ë‚˜ë§Œì˜ ì‚¬ì†Œí•œ ìŠµê´€ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                        <button class="btn-secondary" style="width:auto; margin-top:15px; background:white;" onclick="openWriteModal('challenge')">+ ë‚˜ë§Œì˜ ì±Œë¦°ì§€ ë§Œë“¤ê¸°</button>
                    </div>
                    <div id="challengeList" style="padding:20px;"></div>
                `;
                fetchPosts('challenge', 'challengeList');
            }

            // 5. ë§ˆì´í˜ì´ì§€
            else if (tab === 'mypage') {
                container.innerHTML = `
                    <div style="padding:40px 20px; text-align:center;">
                        <div style="width:80px; height:80px; background:var(--primary-soft); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:30px;">
                            ${currentUser.displayName[0]}
                        </div>
                        <h3>${currentUser.displayName}ë‹˜</h3>
                        <p style="font-size:12px; color:#888;">${currentUser.email}</p>
                    </div>

                    <div style="margin:0 20px 20px; padding:20px; background:white; border-radius:20px; box-shadow:var(--shadow);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <h4>ë‚˜ì˜ ìŠ¤íƒ¬í”„ ğŸ¾</h4>
                            <button id="rewardBtn" class="hidden" style="font-size:11px; padding:5px 10px; background:var(--primary); color:white; border:none; border-radius:10px;" onclick="window.open('http://pf.kakao.com/_Jfjxgn')">ğŸ ìŠ¤í˜ì…œ ë ˆí„° ë°›ê¸°</button>
                        </div>
                        <div id="stampGrid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">
                            <!-- JSë¡œ ì±„ì›€ -->
                        </div>
                    </div>

                    <div style="padding:0 20px;">
                        <button class="btn-secondary" onclick="auth.signOut(); location.reload();">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                `;
                loadStamps();
            }
        };

        // --- ê¸°ëŠ¥ ë¡œì§ ---

        // ğŸ“… ìº˜ë¦°ë” ë¡œì§
        async function loadCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';

            // ë‚´ ë¬´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const moodMap = {};
            snap.forEach(d => {
                const date = new Date(d.data().date);
                if(date.getMonth() === month) moodMap[date.getDate()] = d.data().emoji;
            });

            // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            
            // ë‚ ì§œ ì±„ìš°ê¸°
            for(let i=1; i<=lastDate; i++) {
                const emoji = moodMap[i] || '';
                const isToday = i === today.getDate() ? 'today' : '';
                grid.innerHTML += `
                    <div class="day-cell ${isToday}" onclick="alert('${i}ì¼ì˜ ê¸°ë¡: ${emoji || 'ì—†ìŒ'}')">
                        <span style="position:absolute; top:3px; left:5px;">${i}</span>
                        <span class="day-emoji">${emoji}</span>
                    </div>
                `;
            }
        }

        // ğŸ“® ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (ê³µì§€ í¬í•¨)
        async function fetchPosts(type, targetId, limit = 100, includeNotice = false) {
            const target = document.getElementById(targetId);
            if(!target) return;
            
            let q = query(collection(db, "posts"), where("type", "==", type), orderBy("date", "desc"));
            const snap = await getDocs(q);
            
            target.innerHTML = '';
            const noticeArea = document.getElementById('noticeArea');
            if(noticeArea) noticeArea.innerHTML = '';

            snap.forEach(d => {
                const p = d.data();
                const card = `
                    <div class="${p.isNotice ? 'notice-card' : 'pin-card'}" onclick="viewDetail('${d.id}')">
                        ${p.isNotice ? '<div class="notice-badge">ğŸ“Œ</div>' : ''}
                        ${p.image ? `<img src="${p.image}" class="pin-img">` : ''}
                        <div class="pin-content">
                            ${!p.isNotice ? `<span class="pin-tag">${p.category || 'ê¸°ë¡'}</span>` : ''}
                            <div class="pin-title">${p.title}</div>
                            <div class="pin-meta">
                                <span>${p.isAnonymous ? 'ìµëª…' : p.author}</span>
                                <span>${new Date(p.date).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                `;

                if(p.isNotice && noticeArea) noticeArea.innerHTML += card;
                else target.innerHTML += card;
            });
        }

        // ğŸ“ ê¸€ì“°ê¸°
        window.openWriteModal = (mode) => {
            const modal = document.getElementById('writeModal');
            const title = document.getElementById('postTitle');
            const content = document.getElementById('postContent');
            const moodSec = document.getElementById('moodSelector');
            const adminOpt = document.getElementById('adminOptions');
            
            // ì´ˆê¸°í™”
            title.value = ''; content.value = '';
            modal.style.display = 'flex';
            
            // ëª¨ë“œë³„ UI ì„¤ì •
            if(currentTab === 'mood' || mode === 'mood') {
                moodSec.classList.remove('hidden');
                moodSec.querySelector('.emoji-list').innerHTML = MOODS.map(m => 
                    `<div class="emoji-btn" onclick="selectMood(this, '${m}')">${m}</div>`
                ).join('');
                title.placeholder = "ì˜¤ëŠ˜ì˜ ê°ì • í•œ ì¤„";
                adminOpt.classList.add('hidden');
            } else {
                moodSec.classList.add('hidden');
                title.placeholder = "ì œëª©";
                if(isAdmin) adminOpt.classList.remove('hidden');
            }
        };

        let selectedEmoji = null;
        window.selectMood = (el, emoji) => {
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedEmoji = emoji;
        };

        window.submitPost = async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const linkUrl = document.getElementById('linkUrl').value;
            const linkText = document.getElementById('linkText').value;
            const isNotice = document.getElementById('isNotice')?.checked;
            const category = document.getElementById('postCategory').value;
            
            if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

            const postData = {
                title: title,
                content: content,
                date: new Date().toISOString(),
                author: currentUser.displayName,
                authorId: currentUser.uid,
                type: currentTab === 'mood' ? 'mood' : (currentTab === 'challenge' ? 'challenge' : 'post'),
                category: category || 'ì¼ë°˜',
                isNotice: isNotice || false,
                emoji: selectedEmoji,
                link: linkUrl ? { url: linkUrl, text: linkText || 'ë³´ëŸ¬ê°€ê¸°' } : null
                // ì´ë¯¸ì§€ëŠ” Base64ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥ (ìƒëµëœ ì½”ë“œ: previewImage í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬)
            };

            await addDoc(collection(db, "posts"), postData);
            
            // í•‘í¬ íŒì—… ë„ìš°ê¸°
            document.getElementById('popupTitle').innerText = "ì €ì¥ ì™„ë£Œ! âœ¨";
            document.getElementById('popupMsg').innerText = "ê¸°ë¡ì´ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆì–´ìš”.";
            document.getElementById('pinkPopup').style.display = 'flex';
            
            closeModal('writeModal');
            renderTab(currentTab); // ìƒˆë¡œê³ ì¹¨
        };

        // ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥ (html2canvas)
        window.captureScreen = (elementId) => {
            const target = document.getElementById(elementId);
            // ìº¡ì²˜ìš© ìˆ¨ê²¨ì§„ ì˜ì—­ì— ë‚´ìš© ë³µì‚¬
            const captureArea = document.getElementById('captureTarget');
            captureArea.innerHTML = target.innerHTML;
            
            html2canvas(document.getElementById('captureArea')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'jahyu_card.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        // ğŸ¾ ìŠ¤íƒ¬í”„ ë¡œë“œ
        async function loadStamps() {
            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const count = snap.size;
            
            const grid = document.getElementById('stampGrid');
            grid.innerHTML = '';
            for(let i=1; i<=30; i++) {
                grid.innerHTML += `<div style="width:100%; aspect-ratio:1; border-radius:50%; background:${i<=count?'var(--primary)':'#eee'}; color:${i<=count?'white':'#aaa'}; display:flex; justify-content:center; align-items:center; font-weight:700;">${i}</div>`;
            }

            if(count >= 30) document.getElementById('rewardBtn').classList.remove('hidden');
        }

        // --- ê³µí†µ ìœ í‹¸ ---
        window.closePopup = () => document.getElementById('pinkPopup').style.display = 'none';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        // ì•± ì‹œì‘
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                isAdmin = ADMIN_EMAILS.includes(user.email);
                document.getElementById('authModal').style.display = 'none';
                renderTab('home');
            } else {
                document.getElementById('authModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
