<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìíœ´ë ˆí„°</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Round+Gothic:wght@400;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6B46C1; --primary-soft: #F3E8FF; --accent: #FF6B9D; --accent-soft: #FFE4EC;
            --secondary: #4ECDC4; --secondary-soft: #E6FFF9; --text-main: #2D3748; --text-sub: #718096;
            --bg-body: #F8F9FA; --white: #FFFFFF; --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.6); --shadow-card: 0 8px 32px rgba(107, 70, 193, 0.1);
            --stamp-active: #A78BFA;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nanum Round Gothic', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #F8F9FA 0%, #E6FFF9 100%); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

        .app-container { width: 100%; max-width: 480px; min-height: 100vh; background: var(--glass-bg); margin-top: 0; padding-bottom: 90px; position: relative; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-section { padding: 50px 20px 20px; text-align: center; background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(248,249,250,0.9)); border-radius: 0 0 30px 30px; margin-bottom: 20px; position: relative; }
        .header-title { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .header-sub { font-size: 13px; color: var(--text-sub); line-height: 1.5; }
        .back-btn { position: absolute; left: 20px; top: 50px; font-size: 22px; color: var(--text-main); cursor: pointer; background: none; border: none; z-index: 100; }

        .hero-card { background: linear-gradient(180deg, var(--white), var(--primary-soft)); border-radius: 25px; padding: 25px 20px; margin: 0 20px 25px; text-align: center; box-shadow: var(--shadow-card); }
        .hero-btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 12px 25px; border-radius: 20px; font-size: 14px; font-weight: 700; border: none; box-shadow: 0 4px 15px rgba(107,70,193,0.3); cursor: pointer; }

        /* í€µë©”ë‰´ */
        .quick-menu { display: flex; justify-content: space-between; padding: 0 20px; margin-bottom: 30px; overflow-x: auto; gap: 10px; }
        .quick-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 65px; }
        .quick-icon { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 8px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .icon-yellow { background: linear-gradient(135deg, #FDE68A, #FFC107); } 
        .icon-mint { background: linear-gradient(135deg, #99F6E4, var(--secondary)); } 
        .icon-blue { background: linear-gradient(135deg, #93C5FD, #2196F3); } 
        .icon-purple { background: linear-gradient(135deg, #A78BFA, var(--primary)); } 
        .quick-text { font-size: 11px; font-weight: 600; text-align: center; }

        /* ì¹´ë“œ ë° UI ìš”ì†Œ */
        .content-card { background: white; border-radius: 20px; padding: 20px; margin: 0 20px 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .btn-primary { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 15px; font-weight: 700; width: 100%; cursor: pointer; }
        .btn-secondary { background: white; color: var(--text-sub); border: 1px solid #ddd; padding: 12px; border-radius: 15px; width: 100%; cursor: pointer; }
        .input-box { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 15px; margin-bottom: 10px; background: #fff; }
        
        /* í•‘í¬ íŒì—…ì°½ */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .popup-box { background: #FFE4EC; width: 85%; max-width: 320px; padding: 30px 20px; border-radius: 25px; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(255, 107, 157, 0.2); border: 2px solid white; }
        .popup-close { position: absolute; top: 15px; right: 15px; font-size: 18px; color: var(--accent); cursor: pointer; }
        .popup-msg { color: var(--text-main); font-weight: 700; font-size: 15px; line-height: 1.6; margin-bottom: 15px; }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-card { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 25px; text-align: center; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }

        /* í•˜ë‹¨ë°” */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; height: 80px; background: rgba(255,255,255,0.95); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top: 1px solid #eee; padding-bottom: 10px; backdrop-filter: blur(10px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); width: 60px; font-size: 10px; cursor: pointer; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.central .central-bg { width: 55px; height: 55px; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; border: 4px solid white; transform: translateY(-15px); color: white; box-shadow: 0 8px 20px rgba(107, 70, 193, 0.3); }

        /* ì—ë””í„° í•„í„° */
        .editor-filter { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding: 0 20px; -webkit-overflow-scrolling: touch; border-bottom: none; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; background: white; border: 1px solid #eee; color: var(--text-sub); font-size: 12px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .write-icon { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(107,70,193,0.4); cursor: pointer; z-index: 999; }
        
        /* ìŠ¤íƒ¬í”„ */
        .emoji-selector { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; }
        .emoji-option { font-size: 26px; padding: 5px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; display:flex; justify-content:center; align-items:center; }
        .emoji-option.selected { border-color: var(--primary); transform: scale(1.1); }
        
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }
        .stamp { width: 35px; height: 35px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #aaa; font-weight: 700; }
        .stamp.active { background: var(--stamp-active); color: white; box-shadow: 0 3px 10px rgba(167, 139, 250, 0.4); }

        /* ìƒì„¸ í˜ì´ì§€ */
        .post-detail { min-height: 100vh; background: white; padding-bottom: 100px; }
        .detail-header { padding: 20px; display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 10; height: 60px; }
        .detail-content { padding: 20px; line-height: 1.6; }
        .comments-section { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
        .comment-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        
        .my-menu-item { padding: 18px 20px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 14px; background:white; }
        .my-menu-item:hover { background: #f9f9f9; }
    </style>
</head>
<body>

    <!-- í•‘í¬ íŒì—…ì°½ -->
    <div id="customPopup" class="popup-overlay">
        <div class="popup-box">
            <div class="popup-close" onclick="closePopup()"><i class="fas fa-times"></i></div>
            <div style="font-size:30px; margin-bottom:10px;">âœ¨</div>
            <div id="popupMessage" class="popup-msg"></div>
            <button onclick="closePopup()" style="background:white; border:2px solid var(--accent); color:var(--accent); padding:8px 20px; border-radius:20px; font-weight:700; cursor:pointer;">í™•ì¸</button>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-card">
            <h2 style="color:var(--primary); margin-bottom:10px;">ìíœ´ë ˆí„°</h2>
            <p style="margin-bottom:20px; color:var(--text-sub); font-size:13px;">í–…ì‚ë‹˜ì„ ìœ„í•œ íë§ ê³µê°„ ğŸ’œ</p>
            <input type="email" id="emailInput" class="input-box" placeholder="ì´ë©”ì¼">
            <input type="password" id="pwInput" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="handleLogin()" class="btn-primary" style="margin-bottom:10px;">ë¡œê·¸ì¸</button>
            <button onclick="showSignup()" class="btn-secondary">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div id="signupModal" class="modal-overlay">
        <div class="modal-card">
            <h3>íšŒì›ê°€ì…</h3>
            <p style="font-size:12px; color:var(--text-sub); margin-bottom:15px;">ê´€ë¦¬ìëŠ” ì§€ì •ëœ ì´ë©”ì¼ë¡œ ê°€ì…í•´ì£¼ì„¸ìš”!</p>
            <input type="text" id="regNick" class="input-box" placeholder="ë‹‰ë„¤ì„ (ì˜ˆ: í–…ì”¨)">
            <input type="email" id="regEmail" class="input-box" placeholder="ì´ë©”ì¼">
            <input type="password" id="regPw" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
            <button onclick="handleSignup()" class="btn-primary">ê°€ì…í•˜ê¸°</button>
            <button onclick="showLogin()" class="btn-secondary" style="margin-top:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="modal-overlay">
        <div class="modal-card" style="text-align: left;">
            <h3 id="writeHeader" style="text-align:center; margin-bottom:15px;">ê¸€ì“°ê¸°</h3>
            
            <select id="writeCategory" class="input-box" style="display:none;">
                <option value="ìíœ´ë ˆí„°">ìíœ´ë ˆí„°</option>
                <option value="ìíœ´ë©">ìíœ´ë©</option>
                <option value="ì—ë””í„°í†¡">ì—ë””í„°í†¡</option>
            </select>
            
            <div id="moodSection" style="display:none;">
                <p style="font-size:12px; text-align:center;">ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€ ì–´ë–¤ê°€ìš”?</p>
                <div id="emojiGrid" class="emoji-selector"></div>
            </div>
            
            <input type="text" id="writeTitle" class="input-box" placeholder="ì œëª©">
            <textarea id="writeContent" class="input-box" style="height:120px; resize:none;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            
            <div id="fileArea" style="margin-bottom:15px;">
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="previewImage(this)">
                <div onclick="document.getElementById('fileInput').click()" style="padding:10px; border:1px dashed #ccc; border-radius:10px; text-align:center; cursor:pointer; font-size:12px; color:#888;">
                    <i class="fas fa-camera"></i> ì‚¬ì§„ ì²¨ë¶€í•˜ê¸°
                </div>
                <img id="imgPreview" style="width:100%; border-radius:10px; margin-top:10px; display:none; max-height:200px; object-fit:cover;">
            </div>

            <button onclick="savePost()" class="btn-primary">ë“±ë¡í•˜ê¸°</button>
            <button onclick="closeModal('writeModal')" class="btn-secondary" style="margin-top:10px;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì•± ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="app-container"></div>

    <!-- ê¸€ì“°ê¸° í”Œë¡œíŒ… ë²„íŠ¼ -->
    <div id="writeIcon" class="write-icon" onclick="openWriteModal('admin')">
        <i class="fas fa-plus"></i>
    </div>

    <!-- í•˜ë‹¨ë°” -->
    <nav class="bottom-nav">
        <div class="nav-item" onclick="renderTab('home')" id="nav-home"><i class="fas fa-home"></i>í™ˆ</div>
        <div class="nav-item" onclick="renderTab('letter')" id="nav-letter"><i class="fas fa-envelope"></i>ë ˆí„°</div>
        <div class="nav-item central" onclick="renderTab('mood')" id="nav-mood"><div class="central-bg"><i class="fas fa-smile"></i></div>ë¬´ë“œ</div>
        <div class="nav-item" onclick="renderTab('editorTalk')" id="nav-editorTalk"><i class="fas fa-comments"></i>í†¡</div>
        <div class="nav-item" onclick="renderTab('mypage')" id="nav-mypage"><i class="fas fa-user"></i>ë§ˆì´</div>
    </nav>

    <!-- íŒŒì´ì–´ë² ì´ìŠ¤ ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, orderBy, deleteDoc, updateDoc, setDoc, where, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ í–…ì‚ë‹˜ ì„¤ì •ê°’ ğŸ”´
        const firebaseConfig = {
            apiKey: "AIzaSyDq2eT8H6tNcsrT8dhZWsEyyMZbpCZIZZQ",
            authDomain: "jahyu-e24cd.firebaseapp.com",
            databaseURL: "https://jahyu-e24cd-default-rtdb.firebaseio.com",
            projectId: "jahyu-e24cd",
            storageBucket: "jahyu-e24cd.firebasestorage.app",
            messagingSenderId: "955637836464",
            appId: "1:955637836464:web:096ed0c28e0070f4fca975",
            measurementId: "G-CTDZFNYJV7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ì „ì—­ ë³€ìˆ˜
        window.currentUser = null;
        window.currentTab = 'home';
        window.isAdmin = false;
        let unsubscribe = null; 
        
        // ê´€ë¦¬ì ëª…ë‹¨
        const ADMIN_EMAILS = ['happxi@jahyu.com', 'elly@jahyu.com', 'gokal@jahyu.com', 'sunny@jahyu.com', 'yudan@jahyu.com'];
        // ì—ë””í„° ëª…ë‹¨ (í•„í„°ìš©)
        const EDITOR_NAMES = ['ì „ì²´', 'í–…ì”¨', 'ì—˜ë¦¬', 'ê³ ì¹¼', 'ì¨ë‹ˆ', 'ìœ ë‹¨'];

        const MOODS = [
            {e:'ğŸ˜Š',c:'#FDE8D9'}, {e:'ğŸ¥°',c:'#FFD7E9'}, {e:'ğŸ˜Œ',c:'#F9D5FF'}, {e:'ğŸ˜­',c:'#D8D2FF'},
            {e:'ğŸ˜¡',c:'#D4F3F7'}, {e:'ğŸ˜´',c:'#D7F7E9'}, {e:'ğŸ¤©',c:'#E6FFD2'}, {e:'ğŸ¤”',c:'#FFF9D2'},
            {e:'ğŸ¥º',c:'#FFEBEB'}, {e:'ğŸ”¥',c:'#F0A0B0'}, {e:'ğŸ˜‡',c:'#C4A7E3'}, {e:'â˜”',c:'#D8BFD8'},
            {e:'ğŸ¤§',c:'#B0E0E6'}, {e:'ğŸ˜©',c:'#87CEEB'}, {e:'ğŸ€',c:'#98FB98'}, {e:'ğŸ¤«',c:'#FDF5E6'},
            {e:'ğŸ’«',c:'#FFC0CB'}, {e:'ğŸŒ³',c:'#A0D0A0'}, {e:'ğŸ¤ª',c:'#ADD8E6'}, {e:'ğŸ˜',c:'#E0E0E0'}
        ];

        // ğŸ” ì¸ì¦
        window.handleLogin = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('pwInput').value);
            } catch (e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
        };

        window.handleSignup = async () => {
            const nick = document.getElementById('regNick').value;
            if(!nick) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPw').value);
                await updateProfile(cred.user, { displayName: nick });
                await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, name: nick, stamps: 0 });
                alert("ê°€ì… ì™„ë£Œ!");
            } catch (e) { alert("ê°€ì… ì‹¤íŒ¨: " + e.message); }
        };

        // ğŸ“ ê¸€ì“°ê¸°
        let selectedMood = null;
        window.openWriteModal = (type) => {
            const modal = document.getElementById('writeModal');
            const catSelect = document.getElementById('writeCategory');
            const moodSec = document.getElementById('moodSection');
            
            // ì´ˆê¸°í™”
            document.getElementById('writeTitle').value = '';
            document.getElementById('writeContent').value = '';
            document.getElementById('imgPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
            selectedMood = null;
            
            modal.style.display = 'flex';

            if (type === 'mood') {
                catSelect.style.display = 'none';
                moodSec.style.display = 'block';
                document.getElementById('fileArea').style.display = 'none';
                document.getElementById('writeTitle').placeholder = 'í•œ ì¤„ ìš”ì•½';
                document.getElementById('emojiGrid').innerHTML = MOODS.map(m => 
                    `<div class="emoji-option" style="background:${m.c}" onclick="selectMood(this, '${m.e}', '${m.c}')">${m.e}</div>`
                ).join('');
            } else { // admin
                catSelect.style.display = 'block';
                moodSec.style.display = 'none';
                document.getElementById('fileArea').style.display = 'block';
                document.getElementById('writeTitle').placeholder = 'ì œëª©';
            }
        };

        window.selectMood = (el, emoji, color) => {
            document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedMood = { emoji, color };
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.savePost = async () => {
            const title = document.getElementById('writeTitle').value;
            const content = document.getElementById('writeContent').value;
            const category = document.getElementById('writeCategory').value;
            const fileInput = document.getElementById('fileInput');

            if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            let imageStr = null;
            if (fileInput.files.length > 0) {
                imageStr = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            // ëª¨ë“  ê¸€ì€ posts ì»¬ë ‰ì…˜ì— ì €ì¥ (ë¬´ë“œ í¬í•¨)
            const postData = {
                content: content,
                date: new Date().toISOString(),
                author: currentUser.displayName,
                authorId: currentUser.uid,
                likes: [],
                bookmarks: []
            };

            let successMsg = "";

            if (selectedMood) {
                postData.type = 'mood';
                postData.emoji = selectedMood.emoji;
                postData.color = selectedMood.color;
                postData.title = title || selectedMood.emoji;
                successMsg = "ë¬´ë“œê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ìŠ¤íƒ¬í”„ 1ê°œê°€ ì ë¦½ë˜ì—ˆì–´ìš” ğŸŒ¸";
            } else {
                if (!isAdmin) return alert("ê´€ë¦¬ìë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                postData.type = 'post';
                postData.title = title;
                postData.category = category;
                if (imageStr) postData.image = imageStr;
                successMsg = "ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!";
            }

            try {
                await addDoc(collection(db, "posts"), postData);
                closeModal('writeModal');
                showPopup(successMsg);
                // í˜„ì¬ íƒ­ ìœ ì§€
            } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
        };

        // â¤ï¸ ì¢‹ì•„ìš”/ë¶ë§ˆí¬/ëŒ“ê¸€
        window.toggleLike = async (postId, currentLikes) => {
            const ref = doc(db, "posts", postId);
            if (currentLikes.includes(currentUser.uid)) {
                await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
            }
        };

        window.toggleBookmark = async (postId, currentBookmarks) => {
            const ref = doc(db, "posts", postId);
            if (currentBookmarks.includes(currentUser.uid)) {
                await updateDoc(ref, { bookmarks: arrayRemove(currentUser.uid) });
                showPopup("ë¶ë§ˆí¬ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                await updateDoc(ref, { bookmarks: arrayUnion(currentUser.uid) });
                showPopup("ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ”–");
            }
        };

        window.addComment = async (postId) => {
            const input = document.getElementById(`commentInput-${postId}`);
            if(!input.value) return;
            await addDoc(collection(db, "comments"), {
                postId: postId,
                content: input.value,
                author: currentUser.displayName,
                authorId: currentUser.uid,
                date: new Date().toISOString()
            });
            input.value = '';
            showPopup("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’¬");
        };

        window.deleteComment = async (commentId) => {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await deleteDoc(doc(db, "comments", commentId));
        };

        // íŒì—… í•¨ìˆ˜
        window.showPopup = (msg) => {
            document.getElementById('popupMessage').innerHTML = msg;
            document.getElementById('customPopup').style.display = 'flex';
        };
        window.closePopup = () => {
            document.getElementById('customPopup').style.display = 'none';
        };

        // ìƒì„¸í˜ì´ì§€ ë³´ê¸°
        window.viewPostDetail = (postId) => {
            if(unsubscribe) unsubscribe();
            const container = document.getElementById('appContainer');
            
            // ìƒì„¸í˜ì´ì§€ ë¦¬ìŠ¤ë„ˆ
            unsubscribe = onSnapshot(doc(db, "posts", postId), (docSnap) => {
                if(!docSnap.exists()) return container.innerHTML = '<p style="padding:20px;">ì‚­ì œëœ ê¸€ì…ë‹ˆë‹¤.</p>';
                const p = docSnap.data();
                const isLiked = p.likes && p.likes.includes(currentUser.uid);
                const isBookmarked = p.bookmarks && p.bookmarks.includes(currentUser.uid);
                
                const commentsQuery = query(collection(db, "comments"), where("postId", "==", postId));
                
                container.innerHTML = `
                    <div class="post-detail">
                        <div class="detail-header">
                            <button class="back-btn" onclick="renderTab(window.lastTab || 'home')"><i class="fas fa-arrow-left"></i></button>
                            <h3 style="font-size:16px; margin:0; flex:1; text-align:center;">${p.title}</h3>
                            ${(isAdmin && p.authorId === currentUser.uid) ? `<i class="fas fa-trash" onclick="deleteDoc(doc(db,'posts','${postId}')); renderTab(window.lastTab);" style="color:red; cursor:pointer;"></i>` : ''}
                        </div>
                        <div class="detail-content">
                            ${p.image ? `<img src="${p.image}" style="width:100%; border-radius:10px; margin-bottom:15px;">` : ''}
                            <div style="white-space:pre-wrap;">${p.content}</div>
                            <div style="margin-top:20px; font-size:12px; color:#999;">${p.author} Â· ${new Date(p.date).toLocaleString()}</div>
                        </div>
                        <div class="detail-actions" style="display:flex; gap:15px; padding:15px 20px; border-top:1px solid #f0f0f0;">
                            <div onclick="toggleLike('${postId}', [${p.likes?p.likes.map(u=>`'${u}'`):''}])" style="cursor:pointer; color:${isLiked?'var(--accent)':'#999'}">
                                <i class="fas fa-heart"></i> ${p.likes ? p.likes.length : 0}
                            </div>
                            <div onclick="toggleBookmark('${postId}', [${p.bookmarks?p.bookmarks.map(u=>`'${u}'`):''}])" style="cursor:pointer; color:${isBookmarked?'var(--primary)':'#999'}">
                                <i class="fas fa-bookmark"></i> ë¶ë§ˆí¬
                            </div>
                        </div>
                        <div class="comments-section">
                            <h4 style="margin-bottom:15px; font-size:14px;">ëŒ“ê¸€</h4>
                            <div id="commentList">ë¡œë”©ì¤‘...</div>
                            <div style="display:flex; margin-top:15px;">
                                <input type="text" id="commentInput-${postId}" class="input-box" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”" style="margin-bottom:0; border-radius:10px 0 0 10px;">
                                <button onclick="addComment('${postId}')" class="btn-primary" style="width:60px; border-radius:0 10px 10px 0;">ë“±ë¡</button>
                            </div>
                        </div>
                    </div>
                `;

                // ëŒ“ê¸€ ë Œë”ë§
                onSnapshot(commentsQuery, (cSnap) => {
                    const cList = document.getElementById('commentList');
                    if(!cList) return;
                    cList.innerHTML = '';
                    if(cSnap.empty) cList.innerHTML = '<p style="color:#999; font-size:12px;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>';
                    
                    const comments = [];
                    cSnap.forEach(d => comments.push({id: d.id, ...d.data()}));
                    comments.sort((a,b) => new Date(a.date) - new Date(b.date));

                    comments.forEach(c => {
                        cList.innerHTML += `
                            <div class="comment-item">
                                <div style="font-weight:700; color:var(--primary); margin-bottom:3px;">
                                    ${c.author} 
                                    ${c.authorId === currentUser.uid ? `<i class="fas fa-times" onclick="deleteComment('${c.id}')" style="float:right; cursor:pointer; color:#ccc;"></i>` : ''}
                                </div>
                                <div>${c.content}</div>
                                <div style="font-size:10px; color:#aaa; margin-top:3px;">${new Date(c.date).toLocaleDateString()}</div>
                            </div>
                        `;
                    });
                });
            });
        };

        // ğŸ’» íƒ­ ë Œë”ë§
        window.renderTab = (tab) => {
            if(tab !== 'postDetail') window.lastTab = tab; 
            window.currentTab = tab;
            const container = document.getElementById('appContainer');
            
            // ë„¤ë¹„ í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const nav = document.getElementById(`nav-${tab}`);
            if(nav) nav.classList.add('active');

            if(unsubscribe) { unsubscribe(); unsubscribe = null; }

            // ê´€ë¦¬ì ê¸€ì“°ê¸° ë²„íŠ¼ í‘œì‹œ ì¡°ê±´
            const showWrite = isAdmin && ['letter', 'editorTalk'].includes(tab);
            document.getElementById('writeIcon').style.display = showWrite ? 'flex' : 'none';

            if (tab === 'home') {
                container.innerHTML = `
                    <div class="header-section">
                        <h2 class="header-title">${currentUser.displayName}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”!</h2>
                        <p class="header-sub">ì˜¤ëŠ˜ë„ ìíœ´ë ˆí„°ì™€ í•¨ê»˜ ì‰¬ì–´ê°€ì„¸ìš” ğŸ’œ</p>
                    </div>
                    <div class="hero-card">
                        <h3 style="margin-bottom:10px; color:var(--text-main);">ë§ˆìŒ ì±™ê¹€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h3>
                        <p style="font-size:13px; color:var(--text-sub); margin-bottom:20px;">ì˜¤ëŠ˜ì˜ ë¬´ë“œë¥¼ ê¸°ë¡í•˜ê³  ìŠ¤íƒ¬í”„ë¥¼ ëª¨ì•„ë³´ì„¸ìš”!</p>
                        <button class="hero-btn" onclick="renderTab('mood')">ë¬´ë“œ ê¸°ë¡í•˜ëŸ¬ ê°€ê¸°</button>
                    </div>
                    <!-- í€µë©”ë‰´ ìˆœì„œ ìˆ˜ì •ë¨ -->
                    <div class="quick-menu">
                        <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn')">
                            <div class="quick-icon icon-yellow"><i class="fas fa-comments"></i></div>
                            <span class="quick-text">1:1 ì±„íŒ…</span>
                        </div>
                        <div class="quick-item" onclick="window.open('https://pf.kakao.com/_Jfjxgn/111753149')">
                            <div class="quick-icon icon-mint"><i class="fas fa-pen-nib"></i></div>
                            <span class="quick-text">ë¬¸ì¥ìˆ˜ì§‘</span>
                        </div>
                        <div class="quick-item" onclick="window.open('https://index-html-zak5.vercel.app/')">
                            <div class="quick-icon icon-blue"><i class="fas fa-magic"></i></div>
                            <span class="quick-text">íë§í…ŒìŠ¤íŠ¸</span>
                        </div>
                        <div class="quick-item" onclick="window.open('https://maily.so/happci')">
                            <div class="quick-icon icon-purple"><i class="fas fa-envelope-open-text"></i></div>
                            <span class="quick-text">ë ˆí„°ì½ê¸°</span>
                        </div>
                    </div>
                `;

            } else if (tab === 'letter' || tab === 'editorTalk') {
                const isTalk = tab === 'editorTalk';
                container.innerHTML = `
                    <div class="header-section">
                        ${window.lastTab !== 'home' ? `<button class="back-btn" onclick="renderTab('home')"><i class="fas fa-arrow-left"></i></button>` : ''}
                        <h2 class="header-title">${isTalk ? 'ì—ë””í„°í†¡' : 'ìíœ´ë ˆí„°'}</h2>
                        <p class="header-sub">${isTalk ? 'ì—ë””í„°ë“¤ì˜ ì¼ìƒì„ ë§Œë‚˜ë³´ì„¸ìš”!' : 'ë‹¹ì‹ ì„ ìœ„í•œ íë§ ë ˆí„°'}</p>
                    </div>
                    ${isTalk ? `
                        <div class="editor-filter">
                            ${EDITOR_NAMES.map(name => `<div class="filter-chip ${name==='ì „ì²´'?'active':''}" onclick="filterEditors(this, '${name}')">${name}</div>`).join('')}
                        </div>
                    ` : ''}
                    <div id="postList" style="padding:0 20px;">ë¡œë”©ì¤‘...</div>
                `;
                
                // ì¿¼ë¦¬ ë‹¨ìˆœí™” (ì¸ë±ìŠ¤ ë¬¸ì œ ë°©ì§€)
                const q = query(collection(db, "posts"), where("type", "==", "post"), orderBy("date", "desc"));
                unsubscribe = onSnapshot(q, (snap) => {
                    const list = document.getElementById('postList');
                    if(!list) return;
                    list.innerHTML = '';
                    snap.forEach(d => {
                        const p = d.data();
                        if(isTalk && p.category !== 'ì—ë””í„°í†¡') return;
                        if(!isTalk && p.category === 'ì—ë””í„°í†¡') return;
                        
                        const div = document.createElement('div');
                        div.innerHTML = renderCard(d.id, p);
                        div.dataset.author = p.author;
                        list.appendChild(div);
                    });
                });

            } else if (tab === 'mood') {
                container.innerHTML = `
                    <div class="header-section">
                        <button class="back-btn" onclick="renderTab('home')"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="header-title">ì˜¤ëŠ˜ì˜ ë¬´ë“œ</h2>
                        <p class="header-sub">ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?<br>ë‚˜ì˜ ì†”ì§í•œ ê°ì •ì„ ê¸°ë¡í•´ ë³´ì„¸ìš”!<br>ì˜¤ì§ í–…ì‚ë‹˜ë§Œ ë³¼ ìˆ˜ ìˆë‹µë‹ˆë‹¤!</p>
                    </div>
                    <div style="text-align:center; padding:0 20px 20px;">
                        <button class="btn-primary" onclick="openWriteModal('mood')">ì˜¤ëŠ˜ ê¸°ë¶„ ë‚¨ê¸°ê¸° âœï¸</button>
                    </div>
                    <div id="moodList" style="padding:0 20px;"></div>
                `;
                const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid), orderBy("date", "desc"));
                unsubscribe = onSnapshot(q, (snap) => {
                    const list = document.getElementById('moodList');
                    if(!list) return;
                    list.innerHTML = '';
                    snap.forEach(d => {
                        const m = d.data();
                        list.innerHTML += `
                            <div class="content-card" style="background:${m.color}; display:flex; align-items:center;">
                                <div style="font-size:35px; margin-right:15px;">${m.emoji}</div>
                                <div>
                                    <h4 style="margin:0; font-size:14px;">${m.title}</h4>
                                    <p style="font-size:12px; margin:5px 0;">${m.content}</p>
                                    <span style="font-size:10px; opacity:0.6;">${new Date(m.date).toLocaleDateString()}</span>
                                </div>
                            </div>`;
                    });
                });

            } else if (tab === 'mypage') {
                renderMyPage(container);
            }
        };

        // ğŸ§‘â€ğŸ’» ë§ˆì´í˜ì´ì§€ ë¡œì§
        async function renderMyPage(container) {
            container.innerHTML = `
                <div class="header-section">
                    <button class="back-btn" onclick="renderTab('home')"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="header-title">${currentUser.displayName}ë‹˜</h2>
                    <p class="header-sub">${currentUser.email}</p>
                </div>
                <div style="padding:0 20px;">
                    <div class="content-card">
                        <h4 style="margin-bottom:10px;">ë‚˜ì˜ ë¬´ë“œ ìŠ¤íƒ¬í”„</h4>
                        <div id="stampContainer" class="stamp-grid"></div>
                        <p id="stampText" style="text-align:center; font-size:12px; margin-top:15px; color:var(--text-sub); line-height:1.5;">
                            ìŠ¤íƒ¬í”„ë¥¼ ëª¨ë‘ ëª¨ìœ¼ë©´ ì–´ëŠë‚  ìŠ¤í˜ì…œ ë ˆí„°ê°€ ë„ì°©í•´ìš”!<br>
                            ìíœ´ë ˆí„° ì¹´í†¡ ì±„ë„ì— 30ê°œë¥¼ ëª¨ë‘ ëª¨ì€ ì¸ì¦ìƒ·ì„ ë³´ë‚´ì£¼ì„¸ìš”!
                        </p>
                    </div>
                    
                    <div class="content-card" style="padding:0; overflow:hidden;">
                        <div class="my-menu-item" onclick="showMyHistory('posts')"><span>ğŸ“ ë‚´ê°€ ì“´ ê¸€</span><i class="fas fa-chevron-right"></i></div>
                        <div class="my-menu-item" onclick="showMyHistory('comments')"><span>ğŸ’¬ ë‚˜ì˜ ëŒ“ê¸€</span><i class="fas fa-chevron-right"></i></div>
                        <div class="my-menu-item" onclick="showMyHistory('likes')"><span>â¤ï¸ ì¢‹ì•„ìš”í•œ ê¸€</span><i class="fas fa-chevron-right"></i></div>
                        <div class="my-menu-item" onclick="showMyHistory('bookmarks')"><span>ğŸ”– ë¶ë§ˆí¬í•œ ê¸€</span><i class="fas fa-chevron-right"></i></div>
                        <div class="my-menu-item" onclick="handleLogout()" style="color:var(--accent);"><span>ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ</span><i class="fas fa-sign-out-alt"></i></div>
                    </div>
                </div>
            `;
            
            const q = query(collection(db, "posts"), where("type", "==", "mood"), where("authorId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const count = snap.size;
            const stampBox = document.getElementById('stampContainer');
            if(stampBox) {
                stampBox.innerHTML = Array(30).fill(0).map((_, i) => 
                    `<div class="stamp ${i < count ? 'active' : ''}">${i < count ? 'V' : i+1}</div>`
                ).join('');
            }
        }

        window.showMyHistory = async (type) => {
            const container = document.getElementById('appContainer');
            container.innerHTML = `
                <div class="header-section">
                    <button class="back-btn" onclick="renderTab('mypage')"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="header-title">${type==='posts'?'ë‚´ê°€ ì“´ ê¸€':type==='comments'?'ë‚˜ì˜ ëŒ“ê¸€':type==='likes'?'ì¢‹ì•„ìš”í•œ ê¸€':'ë¶ë§ˆí¬'}</h2>
                </div>
                <div id="historyList" style="padding:0 20px;">ë¡œë”©ì¤‘...</div>
            `;
            
            const list = document.getElementById('historyList');
            let q;
            if (type === 'posts') q = query(collection(db, "posts"), where("authorId", "==", currentUser.uid), where("type", "==", "post"));
            else if (type === 'comments') q = query(collection(db, "comments"), where("authorId", "==", currentUser.uid));
            else q = query(collection(db, "posts"), where(type, "array-contains", currentUser.uid));
            
            const snap = await getDocs(q);
            list.innerHTML = '';
            
            if(snap.empty) return list.innerHTML = '<p style="text-align:center; color:#999;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

            for (const d of snap.docs) {
                const data = d.data();
                if (type === 'comments') {
                    const postSnap = await getDoc(doc(db, "posts", data.postId));
                    const postTitle = postSnap.exists() ? postSnap.data().title : "(ì‚­ì œëœ ê¸€)";
                    list.innerHTML += `
                        <div class="content-card" onclick="viewPostDetail('${data.postId}')">
                            <p style="font-size:13px; font-weight:700;">${data.content}</p>
                            <p style="font-size:11px; color:#999; margin-top:5px;">ì›ë¬¸: ${postTitle}</p>
                        </div>`;
                } else {
                    list.innerHTML += renderCard(d.id, data);
                }
            }
        };

        function renderCard(id, p) {
            const isLiked = p.likes && p.likes.includes(currentUser.uid);
            return `
                <div class="content-card" onclick="viewPostDetail('${id}')">
                    <span style="font-size:10px; color:var(--primary); font-weight:700; background:var(--primary-soft); padding:3px 8px; border-radius:10px;">${p.category}</span>
                    <h4 style="margin:10px 0 5px; font-size:16px;">${p.title}</h4>
                    ${p.image ? `<img src="${p.image}" style="width:100%; height:120px; object-fit:cover; border-radius:10px; margin-bottom:10px;">` : ''}
                    <p style="font-size:13px; color:var(--text-sub); line-height:1.4;">${p.content.substring(0,60)}...</p>
                    <div style="margin-top:15px; display:flex; gap:15px; font-size:12px; color:#999;">
                        <span>${p.author}</span>
                        <span><i class="fas fa-heart" style="color:${isLiked?'var(--accent)':'#ccc'}"></i> ${p.likes?p.likes.length:0}</span>
                    </div>
                </div>
            `;
        }
        
        window.filterEditors = (el, name) => {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            const cards = document.querySelectorAll('#postList > div');
            cards.forEach(card => {
                if(name === 'ì „ì²´' || card.dataset.author === name) card.style.display = 'block';
                else card.style.display = 'none';
            });
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.showSignup = () => { closeModal('loginModal'); document.getElementById('signupModal').style.display = 'flex'; };
        window.showLogin = () => { closeModal('signupModal'); document.getElementById('loginModal').style.display = 'flex'; };
        window.handleLogout = async () => { await signOut(auth); window.location.reload(); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                window.isAdmin = ADMIN_EMAILS.includes(user.email);
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('signupModal').style.display = 'none';
                renderTab('home');
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
